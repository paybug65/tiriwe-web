value),lng=parseFloat(document.getElementById('searchLng').value),radius=parseInt(document.getElementById('searchRadius').value)||50;if(isNaN(lat)||isNaN(lng)){r.innerHTML='<div class="alert alert-danger">Get location first</div>';return}markers.forEach(m=>helpersMap.removeLayer(m));markers=[];const um=L.marker([lat,lng],{icon:L.divIcon({className:'',html:'<div style="background:#3b82f6;color:white;padding:10px 14px;border-radius:25px;font-weight:600">üìç You</div>',iconAnchor:[30,20]})}).addTo(helpersMap);markers.push(um);let q=db.from('user_availability').select('*, profiles(id, email)').eq('is_available',true).neq('user_id',currentUser.id);if(document.getElementById('needPickup').checked)q=q.eq('can_pickup',true);if(document.getElementById('needGarage').checked)q=q.eq('can_provide_garage',true);if(document.getElementById('needStay').checked)q=q.eq('can_provide_accommodation',true);if(document.getElementById('needMeet').checked)q=q.eq('can_meet_for_drinks',true);const{data,error}=await q;if(error){r.innerHTML='<div class="alert alert-danger">'+error.message+'</div>';return}currentHelpers=(data||[]).filter(h=>{if(!h.latitude)return false;h.distance=getDistance(lat,lng,h.latitude,h.longitude);return h.distance<=radius}).sort((a,b)=>a.distance-b.distance);if(!currentHelpers.length){r.innerHTML='<div class="alert alert-info">No helpers found.</div>';return}currentHelpers.forEach((h,i)=>{const e=h.profiles?.email||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);const m=L.marker([h.latitude,h.longitude],{icon:L.divIcon({className:'',html:`<div style="background:${av.color};color:white;padding:8px 14px;border-radius:20px;font-weight:600">${av.icon}</div>`,iconAnchor:[20,20]})}).addTo(helpersMap);m.bindPopup(`<strong>${dn}</strong><br>üìç ${h.distance.toFixed(1)} km<br><button onclick="openContactModal(${i})" style="margin-top:8px;padding:8px 16px;background:#1F4788;color:white;border:none;border-radius:8px;cursor:pointer">üì® Contact</button>`);markers.push(m)});helpersMap.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));r.innerHTML=`<h4>${currentHelpers.length} helper(s)</h4>`+currentHelpers.map((h,i)=>{const e=h.profiles?.email||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);return`<div class="request-card" onclick="focusHelper(${i})" style="cursor:pointer"><div class="request-user"><div class="request-avatar" style="background:${av.color}">${av.icon}</div><div class="request-info"><h4>${dn}</h4><p>üìç ${h.distance.toFixed(1)} km</p></div></div><button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openContactModal(${i})">üì® Contact</button></div>`}).join('')}
        function focusHelper(i){const h=currentHelpers[i];helpersMap.setView([h.latitude,h.longitude],14);markers[i+1].openPopup()}
        
        // Contact & Respond
        function openContactModal(i){selectedHelper=currentHelpers[i];const e=selectedHelper.profiles?.email||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);document.getElementById('contactHelperInfo').innerHTML=`<div style="text-align:center;padding:20px;background:var(--bg);border-radius:12px;margin-bottom:20px"><div style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;margin:0 auto 12px;background:${av.color}">${av.icon}</div><h3>${dn}</h3><p style="color:var(--text-light)">üìç ${selectedHelper.distance.toFixed(1)} km</p></div>`;document.getElementById('contactModal').classList.add('active')}
        function closeContactModal(){document.getElementById('contactModal').classList.remove('active');selectedHelper=null}
        async function sendContactRequest(){if(!currentUser||!selectedHelper)return;const{error}=await db.from('interactions').insert({requester_id:currentUser.id,helper_id:selectedHelper.profiles.id,interaction_type:document.getElementById('contactType').value,status:'pending',notes:document.getElementById('contactMessage').value});if(error)alert('Error: '+error.message);else{alert('‚úÖ Sent!');closeContactModal();document.getElementById('contactMessage').value=''}}
        function openRespondModal(id,name,type){currentRespondRequest={id,name,type};document.getElementById('respondRequestInfo').innerHTML=`<div style="background:var(--bg);padding:20px;border-radius:12px;margin-bottom:20px"><h4 style="margin:0 0 8px;border:none;padding:0">Helping: ${name}</h4><p style="margin:0;color:var(--text-light)">${type}</p></div>`;document.getElementById('respondModal').classList.add('active')}
        function closeRespondModal(){document.getElementById('respondModal').classList.remove('active');currentRespondRequest=null}
        async function sendResponse(){if(!currentRespondRequest)return;const{error}=await db.from('interactions').insert({helper_id:currentUser.id,interaction_type:currentRespondRequest.type,sos_alert_id:currentRespondRequest.id,status:'accepted',notes:document.getElementById('respondMessage').value});if(error)alert('Error: '+error.message);else{alert('‚úÖ Response sent!');closeRespondModal();loadDashboard()}}
        
        // Activity & Feedback
        async function checkPendingFeedback(){if(!currentUser)return;const{data}=await db.from('interactions').select('*').or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`).eq('status','completed');const pending=(data||[]).filter(i=>(i.requester_id===currentUser.id&&!i.requester_feedback_given)||(i.helper_id===currentUser.id&&!i.helper_feedback_given));const badge=document.getElementById('pendingBadge');if(pending.length>0){badge.classList.remove('hidden');badge.textContent='‚ö†Ô∏è '+pending.length}else badge.classList.add('hidden')}
        async function loadActivity(){if(!currentUser)return;const{data}=await db.from('interactions').select('*, requester:requester_id(email), helper:helper_id(email)').or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`).order('created_at',{ascending:false});const all=data||[];const pending=all.filter(i=>i.status==='completed'&&((i.requester_id===currentUser.id&&!i.requester_feedback_given)||(i.helper_id===currentUser.id&&!i.helper_feedback_given)));const pendingDiv=document.getElementById('pendingInteractions');if(pending.length>0){document.getElementById('pendingFeedbackAlert').classList.remove('hidden');pendingDiv.innerHTML=pending.map(i=>{const oe=i.requester_id===currentUser.id?i.helper?.email:i.requester?.email;const n=generateAnonymousName(oe||'unknown');return`<div class="request-card" style="border-color:var(--warning);background:var(--warning-light)"><p><strong>With:</strong> ${n}</p><p style="color:var(--text-light);font-size:13px">${i.interaction_type}</p><button class="btn btn-accent btn-sm" onclick="openFeedbackModal('${i.id}','${n}')" style="margin-top:12px">‚≠ê Feedback</button></div>`}).join('')}else{document.getElementById('pendingFeedbackAlert').classList.add('hidden');pendingDiv.innerHTML='<p style="color:var(--success)">‚úÖ All done!</p>'}const recentDiv=document.getElementById('recentActivity');recentDiv.innerHTML=all.length>0?all.slice(0,10).map(i=>{const oe=i.requester_id===currentUser.id?i.helper?.email:i.requester?.email;const n=generateAnonymousName(oe||'unknown');return`<div class="request-card"><p><strong>${i.requester_id===currentUser.id?'Requested from':'Helped'}:</strong> ${n}</p><p style="color:var(--text-light);font-size:13px">${i.interaction_type} ‚Ä¢ ${i.status}</p></div>`}).join(''):'<p style="color:var(--text-light)">No activity.</p>'}
        function openFeedbackModal(id,name){currentInteractionId=id;selectedRating=null;document.getElementById('feedbackUserName').textContent=name;document.querySelectorAll('.rating-btn').forEach(b=>b.classList.remove('selected'));document.getElementById('feedbackComment').value='';document.getElementById('feedbackWouldAgain').checked=true;document.getElementById('feedbackModal').classList.add('active')}
        function closeFeedbackModal(){document.getElementById('feedbackModal').classList.remove('active');currentInteractionId=null}
        function selectRatingBtn(r){selectedRating=r;document.querySelectorAll('.rating-btn').forEach(b=>b.classList.remove('selected'));document.querySelector('.rating-btn.'+r).classList.add('selected')}
        async function submitFeedback(){if(!selectedRating){alert('Select rating');return}const{data:interaction}=await db.from('interactions').select('*').eq('id',currentInteractionId).single();if(!interaction)return;const isReq=interaction.requester_id===currentUser.id;await db.from('feedback').insert({interaction_id:currentInteractionId,from_user_id:currentUser.id,to_user_id:isReq?interaction.helper_id:interaction.requester_id,rating:selectedRating,comment:document.getElementById('feedbackComment').value,would_interact_again:document.getElementById('feedbackWouldAgain').checked,interaction_type:interaction.interaction_type});await db.from('interactions').update({[isReq?'requester_feedback_given':'helper_feedback_given']:true}).eq('id',currentInteractionId);closeFeedbackModal();checkPendingFeedback();loadActivity();loadDashboardStats();alert('‚úÖ Thanks!')}
        
        // SOS
        function startSOS(){document.getElementById('sosButton').classList.add('holding');sosStartTime=Date.now();document.getElementById('sosStatus').textContent='Hold...';document.getElementById('sosStatus').style.color='var(--danger)';sosTimer=setInterval(()=>{const elapsed=Date.now()-sosStartTime;document.getElementById('sosProgress').style.width=Math.min((elapsed/3000)*100,100)+'%';if(elapsed>=3000){cancelSOS();triggerSOS()}},50)}
        function cancelSOS(){document.getElementById('sosButton').classList.remove('holding');document.getElementById('sosProgress').style.width='0%';if(sosTimer){clearInterval(sosTimer);sosTimer=null}if(!sosStartTime||Date.now()-sosStartTime<3000)document.getElementById('sosStatus').textContent=''}
        function triggerSOS(){document.getElementById('sosStatus').textContent='üö® TRIGGERED!';if(navigator.geolocation){navigator.geolocation.getCurrentPosition(async p=>{await db.from('sos_alerts').insert({user_id:currentUser.id,alert_type:'emergency',severity:'critical',description:'EMERGENCY SOS',latitude:p.coords.latitude,longitude:p.coords.longitude,status:'active'});document.getElementById('sosStatus').textContent='‚úÖ SOS sent!';document.getElementById('sosStatus').style.color='var(--success)'},()=>{document.getElementById('sosStatus').textContent='‚ö†Ô∏è No location'},{enableHighAccuracy:true})}}
        async function handleCreateSOS(){if(!currentUser)return;const r=document.getElementById('sosResult');r.innerHTML='<div class="alert alert-info">Sending...</div>';const vid=document.getElementById('sosVehicle').value;let vinfo='';if(vid){const v=userVehicles.find(x=>x.id===vid);if(v)vinfo=`\nüöó Vehicle: ${v.year||''} ${v.make} ${v.model} (${v.fuel_type||'Unknown'})`}const{error}=await db.from('sos_alerts').insert({user_id:currentUser.id,alert_type:document.getElementById('sosType').value,severity:document.getElementById('sosSeverity').value,description:document.getElementById('sosDescription').value+vinfo,latitude:parseFloat(document.getElementById('sosLat').value)||null,longitude:parseFloat(document.getElementById('sosLng').value)||null,status:'active'});r.innerHTML=error?'<div class="alert alert-danger">‚ùå '+error.message+'</div>':'<div class="alert alert-success">‚úÖ Help request sent!</div>';if(!error)document.getElementById('sosDescription').value=''}
        
        // Utilities
        function getDistance(lat1,lng1,lat2,lng2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
    </script>
</body>
</html>
