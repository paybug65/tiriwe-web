<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato - I exist because you exist</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1F4788;
            --primary-dark: #163560;
            --primary-light: #2d5aa3;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --bg: #f8fafc;
            --bg-alt: #f1f5f9;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: white; }
        .logo-icon { font-size: 32px; }
        .logo-text h1 { font-size: 24px; font-weight: 800; }
        .logo-text span { font-size: 11px; opacity: 0.8; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        
        .pending-badge { background: var(--danger); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; color: white; border: 2px solid rgba(255,255,255,0.3);
        }
        .user-display-name { font-size: 14px; font-weight: 600; }
        .btn-signout { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn-signout:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        .tabs { display: flex; background: var(--card); border-radius: 16px 16px 0 0; overflow-x: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-bottom: 2px solid var(--border); }
        .tab { padding: 18px 28px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-light); white-space: nowrap; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: var(--primary); background: var(--bg); }
        .tab.active { color: var(--primary); border-bottom-color: var(--accent); background: white; }
        .tab .tab-badge { background: var(--danger); color: white; min-width: 20px; height: 20px; border-radius: 10px; font-size: 11px; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; padding: 0 6px; }
        
        .tab-content { display: none; background: var(--card); padding: 32px; border-radius: 0 0 16px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 500px; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .card h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 12px; }
        .card h4 { font-size: 16px; font-weight: 700; margin: 28px 0 16px; color: var(--text); padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .card h4:first-of-type { margin-top: 0; }
        
        /* Auth Styles */
        .auth-container { max-width: 450px; margin: 0 auto; }
        .auth-card { background: var(--card); border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); border: 2px solid var(--border); }
        .auth-card.signin { border-color: var(--primary); }
        .auth-card.signup { border-color: var(--accent); }
        .auth-card .card-header { text-align: center; margin-bottom: 32px; }
        .auth-card .card-icon { font-size: 56px; margin-bottom: 16px; }
        .auth-card .card-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .auth-card.signin .card-title { color: var(--primary); }
        .auth-card.signup .card-title { color: var(--accent-dark); }
        .auth-card .card-subtitle { color: var(--text-light); font-size: 15px; }
        .auth-toggle { text-align: center; margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border); }
        .auth-toggle a { color: var(--primary); font-weight: 600; cursor: pointer; text-decoration: underline; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text); }
        .form-control { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.2s; background: var(--bg); }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(31, 71, 136, 0.1); }
        .form-hint { font-size: 12px; color: var(--text-light); margin-top: 6px; }
        
        /* Buttons */
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(31, 71, 136, 0.4); }
        .btn-accent { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); color: white; }
        .btn-accent:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg-alt); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-sm { padding: 10px 18px; font-size: 13px; }
        .btn-xs { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        
        /* Alerts */
        .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 500; display: flex; align-items: center; gap: 12px; }
        .alert-success { background: var(--success-light); color: #065f46; border: 1px solid #a7f3d0; }
        .alert-danger { background: var(--danger-light); color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: var(--warning-light); color: #92400e; border: 1px solid #fde68a; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        /* Grids */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 24px; border-radius: 16px; text-align: center; }
        .stat-card.accent { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); }
        .stat-card.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
        .stat-card .stat-value { font-size: 36px; font-weight: 800; }
        .stat-card .stat-label { font-size: 14px; opacity: 0.9; margin-top: 4px; }
        
        /* Request Cards */
        .request-card { background: var(--card); border: 2px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 16px; transition: all 0.2s; }
        .request-card:hover { border-color: var(--primary); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .request-card.urgent { border-color: var(--danger); background: var(--danger-light); }
        .request-card.high { border-color: var(--warning); background: var(--warning-light); }
        .request-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .request-user { display: flex; align-items: center; gap: 12px; }
        .request-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: 700; }
        .request-info h4 { font-size: 16px; margin: 0; padding: 0; border: none; color: var(--text); }
        .request-info p { font-size: 13px; color: var(--text-light); margin: 4px 0 0 0; }
        .request-severity { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .severity-critical { background: var(--danger); color: white; }
        .severity-high { background: var(--warning); color: white; }
        .severity-medium { background: #60a5fa; color: white; }
        .severity-low { background: var(--success); color: white; }
        .request-body { margin-bottom: 16px; }
        .request-type { display: inline-flex; align-items: center; gap: 6px; background: var(--bg); padding: 8px 14px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        .request-description { color: var(--text-light); font-size: 14px; line-height: 1.6; }
        .request-meta { display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; color: var(--text-light); margin-bottom: 16px; }
        .request-actions { display: flex; gap: 12px; }
        
        /* Vehicle Cards */
        .vehicle-card { background: var(--bg); border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; position: relative; }
        .vehicle-card.inactive { opacity: 0.6; }
        .vehicle-card .vehicle-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .vehicle-card .vehicle-icon { font-size: 32px; }
        .vehicle-card .vehicle-status { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .vehicle-card .vehicle-status.active { background: var(--success-light); color: #065f46; }
        .vehicle-card .vehicle-status.inactive { background: var(--bg-alt); color: var(--text-light); }
        .vehicle-card h5 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .vehicle-card .vehicle-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: var(--text-light); }
        .vehicle-card .vehicle-actions { display: flex; gap: 8px; margin-top: 12px; }
        .add-vehicle-card { background: var(--bg); border: 2px dashed var(--border); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .add-vehicle-card:hover { border-color: var(--primary); background: white; }
        
        /* Traveler Cards (Nearby) */
        .traveler-card { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
        .traveler-card .traveler-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; font-weight: 700; flex-shrink: 0; }
        .traveler-card .traveler-info { flex: 1; }
        .traveler-card .traveler-info h5 { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
        .traveler-card .traveler-info p { font-size: 13px; color: var(--text-light); margin: 0; }
        .traveler-card .traveler-types { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .traveler-card .type-tag { background: var(--bg); padding: 4px 10px; border-radius: 12px; font-size: 11px; }
        
        /* Map */
        .map-container { height: 400px; border-radius: 16px; overflow: hidden; border: 2px solid var(--border); margin-bottom: 24px; }
        .map-container.small { height: 200px; }
        #helpersMap, #homeMap, #availMap, #dashboardMap { height: 100%; width: 100%; }
        
        /* Checkboxes & Radios */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 16px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; background: var(--bg); padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .checkbox-item:hover { border-color: var(--primary); }
        .checkbox-item input { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .checkbox-item label { cursor: pointer; font-size: 14px; font-weight: 500; }
        
        .radio-group { display: flex; gap: 16px; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; gap: 10px; background: var(--bg); padding: 14px 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .radio-item:hover { border-color: var(--primary); }
        .radio-item.selected { border-color: var(--primary); background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); }
        .radio-item input { width: 20px; height: 20px; accent-color: var(--primary); }
        .radio-item label { cursor: pointer; font-weight: 600; }
        
        /* Location Box */
        .location-capture-box { background: var(--bg); border: 2px dashed var(--border); border-radius: 16px; padding: 28px; text-align: center; }
        .location-capture-box.has-location { border-style: solid; border-color: var(--success); background: var(--success-light); }
        .location-display { font-family: monospace; font-size: 14px; color: var(--text-light); margin-top: 16px; padding: 12px; background: white; border-radius: 8px; }
        
        /* SOS */
        .sos-container { text-align: center; padding: 48px; background: linear-gradient(180deg, #fef2f2 0%, #fee2e2 100%); border-radius: 20px; margin-bottom: 24px; }
        .sos-button { width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(145deg, #ef4444, #b91c1c); border: 6px solid #fca5a5; color: white; font-size: 32px; font-weight: 800; cursor: pointer; box-shadow: 0 0 0 8px rgba(239,68,68,0.2), 0 20px 50px rgba(239,68,68,0.4); transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; font-family: inherit; }
        .sos-button:hover { transform: scale(1.05); }
        .sos-button.holding { background: linear-gradient(145deg, #f87171, #dc2626); transform: scale(0.95); }
        .sos-button span { font-size: 13px; margin-top: 8px; font-weight: 500; opacity: 0.9; }
        .sos-progress { width: 200px; height: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; margin: 24px auto; overflow: hidden; }
        .sos-progress-bar { height: 100%; background: linear-gradient(90deg, #fca5a5, #ef4444); width: 0%; transition: width 0.1s linear; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.7); z-index: 1000; align-items: center; justify-content: center; padding: 24px; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px 28px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 22px; font-weight: 700; color: var(--primary); }
        .modal-close { background: var(--bg); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 28px; }
        .modal-footer { padding: 20px 28px; border-top: 2px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg); border-radius: 0 0 24px 24px; }
        
        /* Rating */
        .rating-buttons { display: flex; gap: 16px; justify-content: center; margin: 28px 0; }
        .rating-btn { padding: 24px 32px; border: 3px solid var(--border); border-radius: 16px; background: white; cursor: pointer; transition: all 0.2s; text-align: center; }
        .rating-btn:hover { transform: scale(1.05); }
        .rating-btn.selected { border-width: 3px; }
        .rating-btn.positive.selected { border-color: var(--success); background: var(--success-light); }
        .rating-btn.neutral.selected { border-color: var(--warning); background: var(--warning-light); }
        .rating-btn.negative.selected { border-color: var(--danger); background: var(--danger-light); }
        .rating-btn .emoji { font-size: 42px; display: block; margin-bottom: 10px; }
        .rating-btn .label { font-size: 14px; font-weight: 700; }
        
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 48px; color: var(--text-light); }
        
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-light); text-decoration: none; font-size: 14px; font-weight: 600; margin-bottom: 20px; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; }
        .back-link:hover { color: var(--primary); background: var(--bg); }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; height: auto; padding: 16px 0; gap: 12px; }
            .tab { padding: 14px 18px; font-size: 13px; }
            .tab-content { padding: 20px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .radio-group { flex-direction: column; }
            .map-container { height: 300px; }
            .rating-buttons { flex-direction: column; }
            .sos-button { width: 160px; height: 160px; font-size: 26px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">
                <span class="logo-icon">üåç</span>
                <div class="logo-text"><h1>Obonato</h1><span>I exist because you exist</span></div>
            </a>
            <div class="header-right">
                <span id="connectionStatus" class="status-badge status-disconnected">Connecting...</span>
                <span id="pendingBadge" class="pending-badge hidden">‚ö†Ô∏è 0</span>
                <div id="userArea" class="hidden user-info">
                    <div id="userAvatar" class="user-avatar">?</div>
                    <span class="user-display-name" id="userDisplayName">User</span>
                    <button class="btn-signout" onclick="handleSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>
        
        <div class="tabs" id="mainTabs">
            <button class="tab active" data-tab="auth" onclick="showTab('auth', this)">üîê Welcome</button>
            <button class="tab hidden" data-tab="dashboard" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab hidden" data-tab="profile" onclick="showTab('profile', this)">üë§ Profile</button>
            <button class="tab hidden" data-tab="availability" onclick="showTab('availability', this)">üìç Availability</button>
            <button class="tab hidden" data-tab="helpers" onclick="showTab('helpers', this)">üó∫Ô∏è Find Helpers</button>
            <button class="tab hidden" data-tab="activity" onclick="showTab('activity', this)">üìã Activity</button>
            <button class="tab hidden" data-tab="sos" onclick="showTab('sos', this)">üö® SOS</button>
        </div>
        
        <!-- Auth Tab -->
        <div id="auth" class="tab-content active">
            <div class="auth-container">
                <!-- Sign In Card -->
                <div id="signInCard" class="auth-card signin">
                    <div class="card-header">
                        <div class="card-icon">üëã</div>
                        <h3 class="card-title">Welcome Back!</h3>
                        <p class="card-subtitle">Sign in to your existing account</p>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" class="form-control" id="signInEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signInPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="handleSignIn()">Sign In ‚Üí</button>
                    <div id="signInResult" style="margin-top: 16px;"></div>
                    <div class="auth-toggle">
                        Don't have an account? <a onclick="showSignUp()">Create one</a>
                    </div>
                </div>
                
                <!-- Sign Up Card -->
                <div id="signUpCard" class="auth-card signup hidden">
                    <div class="card-header">
                        <div class="card-icon">üöÄ</div>
                        <h3 class="card-title">Join Obonato</h3>
                        <p class="card-subtitle">Create your free account</p>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" class="form-control" id="signUpEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signUpPassword" placeholder="Min 6 characters">
                    </div>
                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        <span>üé≠</span> Your anonymous display name will be automatically generated to protect your privacy (like Reddit usernames).
                    </div>
                    <button class="btn btn-accent btn-block" onclick="handleSignUp()">Create Account ‚Üí</button>
                    <div id="signUpResult" style="margin-top: 16px;"></div>
                    <div class="auth-toggle">
                        Already have an account? <a onclick="showSignIn()">Sign in</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statNearbyRequests">0</div>
                    <div class="stat-label">Nearby Requests</div>
                </div>
                <div class="stat-card accent">
                    <div class="stat-value" id="statNearbyTravelers">0</div>
                    <div class="stat-label">Travelers Nearby</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="statHelpGiven">0</div>
                    <div class="stat-label">Help Given</div>
                </div>
                <div class="stat-card danger" id="pendingFeedbackStat" style="cursor: pointer;" onclick="showTab('activity', document.querySelector('[data-tab=activity]'))">
                    <div class="stat-value" id="statPendingFeedback">0</div>
                    <div class="stat-label">Pending Feedback</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <div class="card">
                        <h3>üÜò Help Requests Near You</h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">These people need help within your range and match your services.</p>
                        <div id="nearbyRequests">
                            <p class="loading">Loading nearby requests...</p>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <h3>üó∫Ô∏è Your Area</h3>
                        <div class="map-container small">
                            <div id="dashboardMap"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üë• Travelers Nearby</h3>
                        <p style="color: var(--text-light); margin-bottom: 16px;">Fellow travelers in your area right now.</p>
                        <div id="nearbyTravelers">
                            <p class="loading">Loading nearby travelers...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="card">
                <h3>üë§ Your Profile</h3>
                
                <!-- Anonymous Identity Display -->
                <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 20px;">
                    <div id="profileAvatar" class="user-avatar" style="width: 80px; height: 80px; font-size: 36px; border: 3px solid rgba(255,255,255,0.3);">?</div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">Your Anonymous Identity</div>
                        <div id="profileDisplayName" style="font-size: 24px; font-weight: 800;">Loading...</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">This name is shown to other users to protect your privacy</div>
                    </div>
                </div>
                
                <h4>üìã Personal Information (Private)</h4>
                <p class="form-hint" style="margin-bottom: 16px;">This information is only visible to helpers you contact.</p>
                <div class="grid-3">
                    <div class="form-group"><label>First Name</label><input type="text" class="form-control" id="profileFirstName" placeholder="John"></div>
                    <div class="form-group"><label>Surname</label><input type="text" class="form-control" id="profileSurname" placeholder="Smith"></div>
                    <div class="form-group"><label>Mobile Phone</label><input type="tel" class="form-control" id="profileMobile" placeholder="+64 21 123 4567"></div>
                </div>
                
                <h4>üè† Home Address</h4>
                <div class="grid-2">
                    <div class="form-group"><label>Suburb</label><input type="text" class="form-control" id="profileSuburb" placeholder="e.g., Ponsonby"></div>
                    <div class="form-group"><label>City</label><input type="text" class="form-control" id="profileCity" placeholder="e.g., Auckland"></div>
                </div>
                <div class="grid-3">
                    <div class="form-group"><label>Country</label><input type="text" class="form-control" id="profileCountry" placeholder="e.g., New Zealand"></div>
                    <div class="form-group"><label>Post Code</label><input type="text" class="form-control" id="profilePostCode" placeholder="e.g., 1021"></div>
                </div>
                
                <h4>üìç Home Location (GPS)</h4>
                <div class="grid-2">
                    <div>
                        <div class="location-capture-box" id="homeLocationBox">
                            <div class="btn-group" style="justify-content: center; margin-bottom: 16px;">
                                <button class="btn btn-primary btn-sm" onclick="captureHomeGPS()">üìç Use Device GPS</button>
                                <button class="btn btn-secondary btn-sm" onclick="toggleManualEntry()">‚úèÔ∏è Manual</button>
                            </div>
                            <div id="manualGpsEntry" class="hidden">
                                <div class="grid-2" style="max-width: 300px; margin: 16px auto 0;">
                                    <input type="text" class="form-control" id="profileHomeLat" placeholder="Latitude">
                                    <input type="text" class="form-control" id="profileHomeLng" placeholder="Longitude">
                                </div>
                            </div>
                            <div class="location-display" id="homeLocationDisplay">üìç No location set</div>
                        </div>
                    </div>
                    <div class="map-container small"><div id="homeMap"></div></div>
                </div>
                
                <h4>üöó Traveler Type</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="typeMoto"><label for="typeMoto">üèçÔ∏è Motorcyclist</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeCyclist"><label for="typeCyclist">üö¥ Cyclist</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="type4wd"><label for="type4wd">üöô 4WD / Overlander</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeYacht"><label for="typeYacht">‚õµ Sailor</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeHiker"><label for="typeHiker">ü•æ Hiker</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeTrucker"><label for="typeTrucker">üöõ Trucker</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeRV"><label for="typeRV">üöê RV / Campervan</label></div>
                </div>
                
                <!-- VEHICLES SECTION -->
                <h4>üöô My Vehicles</h4>
                <p class="form-hint" style="margin-bottom: 16px;">Add your vehicles so helpers know what parts/tools to bring when you need assistance.</p>
                <div id="vehiclesList"></div>
                <div class="add-vehicle-card" onclick="openVehicleModal()">
                    <span style="font-size: 32px;">‚ûï</span>
                    <p style="color: var(--text-light); margin-top: 8px; font-weight: 600;">Add Vehicle</p>
                </div>
                
                <h4>üö® Emergency Contact</h4>
                <div class="grid-3">
                    <div class="form-group"><label>Contact Name</label><input type="text" class="form-control" id="emergencyName" placeholder="Full name"></div>
                    <div class="form-group"><label>Contact Phone</label><input type="tel" class="form-control" id="emergencyPhone" placeholder="+64 21 987 6543"></div>
                    <div class="form-group"><label>Contact Email</label><input type="email" class="form-control" id="emergencyEmail" placeholder="emergency@email.com"></div>
                </div>
                
                <h4>‚öôÔ∏è Preferences</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Distance Units</label>
                        <div class="radio-group">
                            <div class="radio-item selected" onclick="selectRadio('unitDistance', 'km')"><input type="radio" name="unitDistance" value="km" checked><label>Kilometres</label></div>
                            <div class="radio-item" onclick="selectRadio('unitDistance', 'miles')"><input type="radio" name="unitDistance" value="miles"><label>Miles</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature Units</label>
                        <div class="radio-group">
                            <div class="radio-item selected" onclick="selectRadio('unitTemp', 'celsius')"><input type="radio" name="unitTemp" value="celsius" checked><label>Celsius</label></div>
                            <div class="radio-item" onclick="selectRadio('unitTemp', 'fahrenheit')"><input type="radio" name="unitTemp" value="fahrenheit"><label>Fahrenheit</label></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="handleSaveProfile()" style="margin-top: 24px;">üíæ Save Profile</button>
                <div id="profileResult" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <!-- Availability Tab -->
        <div id="availability" class="tab-content">
            <div class="card">
                <h3>üìç Your Availability</h3>
                <div class="checkbox-item" style="background: var(--success-light); border-color: var(--success); margin-bottom: 24px;">
                    <input type="checkbox" id="availActive" checked>
                    <label for="availActive" style="font-weight: 700; color: #065f46;">I am available to help others</label>
                </div>
                
                <h4>üìç Current Location</h4>
                <div class="grid-2">
                    <div>
                        <button class="btn btn-secondary" onclick="getCurrentLocation()" style="margin-bottom: 16px;">üìç Use Current Location</button>
                        <div class="grid-2" style="margin-bottom: 16px;">
                            <input type="text" class="form-control" id="availLat" placeholder="Latitude">
                            <input type="text" class="form-control" id="availLng" placeholder="Longitude">
                        </div>
                        <div class="form-group"><label>Location Name</label><input type="text" class="form-control" id="availLocation" placeholder="e.g., Auckland CBD"></div>
                    </div>
                    <div class="map-container small"><div id="availMap"></div></div>
                </div>
                
                <h4>ü§ù Services You Can Provide</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="canPickup"><label for="canPickup">üöó Pickup / Rescue / Trailer</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canGarage"><label for="canGarage">üîß Garage / Workshop</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canStay"><label for="canStay">üè† Accommodation / Camping</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canMeet"><label for="canMeet">üç∫ Drinks / Dinner</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canAdvice"><label for="canAdvice">üí° Local Advice</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canHelp"><label for="canHelp">üÜò General Help</label></div>
                </div>
                
                <div class="form-group" style="margin-top: 24px; max-width: 200px;">
                    <label>Max Help Radius (<span id="radiusUnit">km</span>)</label>
                    <input type="number" class="form-control" id="availRadius" value="50">
                </div>
                
                <button class="btn btn-primary" onclick="handleSaveAvailability()">üíæ Update Availability</button>
                <div id="availResult" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <!-- Find Helpers Tab -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>üó∫Ô∏è Find Nearby Helpers</h3>
                <div class="grid-2" style="margin-bottom: 24px;">
                    <div>
                        <button class="btn btn-secondary" onclick="getSearchLocation()" style="margin-bottom: 16px;">üìç Use Current Location</button>
                        <div class="grid-2">
                            <input type="text" class="form-control" id="searchLat" placeholder="Latitude">
                            <input type="text" class="form-control" id="searchLng" placeholder="Longitude">
                        </div>
                    </div>
                    <div class="form-group"><label>Radius (<span id="searchRadiusUnit">km</span>)</label><input type="number" class="form-control" id="searchRadius" value="50"></div>
                </div>
                <div class="checkbox-group" style="margin-bottom: 24px;">
                    <div class="checkbox-item"><input type="checkbox" id="needPickup"><label>üöó Pickup</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needGarage"><label>üîß Garage</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needStay"><label>üè† Stay</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needMeet"><label>üç∫ Meetup</label></div>
                </div>
                <button class="btn btn-primary" onclick="handleSearchHelpers()">üîç Search</button>
            </div>
            <div class="map-container"><div id="helpersMap"></div></div>
            <div id="helperResults" style="margin-top: 24px;"><p class="loading">Enter your location to find nearby helpers...</p></div>
        </div>
        
        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div class="card">
                <h3>üìã Your Activity</h3>
                <div id="pendingFeedbackAlert" class="alert alert-warning hidden">‚ö†Ô∏è <strong>Feedback Required</strong> - Please provide feedback for completed interactions.</div>
                <h4>‚è≥ Pending Feedback</h4>
                <div id="pendingInteractions"><p class="loading">Loading...</p></div>
                <h4>üìú Recent Activity</h4>
                <div id="recentActivity"><p class="loading">Loading...</p></div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="alert alert-warning">‚ö†Ô∏è <strong>Emergency:</strong> Call 111 (NZ) / 000 (AU) / 911 (US) first!</div>
            <div class="sos-container">
                <button class="sos-button" id="sosButton" onmousedown="startSOS()" onmouseup="cancelSOS()" onmouseleave="cancelSOS()" ontouchstart="startSOS()" ontouchend="cancelSOS()">üö® SOS<span>Hold 3 seconds</span></button>
                <div class="sos-progress"><div class="sos-progress-bar" id="sosProgress"></div></div>
                <p id="sosStatus" style="font-size: 16px; font-weight: 600; color: var(--text-light);"></p>
            </div>
            <div class="card">
                <h3>üìù Help Request</h3>
                
                <!-- Vehicle Selection for SOS -->
                <div class="form-group">
                    <label>Select Vehicle (if applicable)</label>
                    <select class="form-control" id="sosVehicle">
                        <option value="">-- No vehicle / Not vehicle-related --</option>
                    </select>
                    <p class="form-hint">Select your vehicle so helpers know what they're working with</p>
                </div>
                
                <div class="grid-2">
                    <div class="form-group"><label>Type</label><select class="form-control" id="sosType"><option value="breakdown">üîß Breakdown</option><option value="accident">üí• Accident</option><option value="medical">üè• Medical</option><option value="stuck">üöô Stuck</option><option value="fuel">‚õΩ Fuel</option><option value="unsafe">‚ö†Ô∏è Unsafe</option><option value="other">‚ùì Other</option></select></div>
                    <div class="form-group"><label>Severity</label><select class="form-control" id="sosSeverity"><option value="low">üü¢ Low</option><option value="medium">üü° Medium</option><option value="high">üü† High</option><option value="critical">üî¥ Critical</option></select></div>
                </div>
                <div class="form-group"><label>Description</label><textarea class="form-control" id="sosDescription" rows="3" placeholder="Describe your situation..."></textarea></div>
                <div class="form-group"><label>Location</label><button class="btn btn-secondary btn-sm" onclick="getSOSLocation()" style="margin-bottom: 8px;">üìç Get Location</button><div class="grid-2"><input type="text" class="form-control" id="sosLat" placeholder="Lat"><input type="text" class="form-control" id="sosLng" placeholder="Lng"></div></div>
                <button class="btn btn-danger" onclick="handleCreateSOS()">üö® Send Request</button>
                <div id="sosResult" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Vehicle Modal -->
    <div class="modal-overlay" id="vehicleModal">
        <div class="modal">
            <div class="modal-header"><h2 id="vehicleModalTitle">Add Vehicle</h2><button class="modal-close" onclick="closeVehicleModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="vehicleEditId">
                <div class="form-group">
                    <label>Vehicle Type</label>
                    <select class="form-control" id="vehicleType">
                        <option value="motorcycle">üèçÔ∏è Motorcycle</option>
                        <option value="car">üöó Car</option>
                        <option value="4wd">üöô 4WD / SUV</option>
                        <option value="truck">üöõ Truck</option>
                        <option value="rv">üöê RV / Campervan</option>
                        <option value="bicycle">üö¥ Bicycle</option>
                        <option value="boat">‚õµ Boat</option>
                        <option value="other">‚ùì Other</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Make</label><input type="text" class="form-control" id="vehicleMake" placeholder="e.g., Honda, Toyota"></div>
                    <div class="form-group"><label>Model</label><input type="text" class="form-control" id="vehicleModel" placeholder="e.g., CBR600, Hilux"></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Year</label><input type="number" class="form-control" id="vehicleYear" placeholder="e.g., 2020"></div>
                    <div class="form-group">
                        <label>Fuel Type</label>
                        <select class="form-control" id="vehicleFuel">
                            <option value="">-- Select --</option>
                            <option value="91">91 Unleaded</option>
                            <option value="95">95 Premium</option>
                            <option value="98">98 Premium+</option>
                            <option value="diesel">Diesel</option>
                            <option value="lpg">LPG</option>
                            <option value="electric">Electric</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="na">N/A (Bicycle etc)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Colour</label><input type="text" class="form-control" id="vehicleColour" placeholder="e.g., Red, Silver"></div>
                <div class="form-group"><label>Registration / Plate</label><input type="text" class="form-control" id="vehicleRego" placeholder="e.g., ABC123"></div>
                <div class="form-group"><label>Notes</label><textarea class="form-control" id="vehicleNotes" rows="2" placeholder="Any special info (modifications, common issues, etc)"></textarea></div>
                <div class="checkbox-item" style="margin-top: 16px;">
                    <input type="checkbox" id="vehicleActive" checked>
                    <label for="vehicleActive">Vehicle is Active (currently in use)</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeVehicleModal()">Cancel</button>
                <button class="btn btn-danger hidden" id="vehicleDeleteBtn" onclick="deleteVehicle()">üóëÔ∏è Delete</button>
                <button class="btn btn-primary" onclick="saveVehicle()">üíæ Save Vehicle</button>
            </div>
        </div>
    </div>
    
    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal">
            <div class="modal-header"><h2>‚≠ê Rate Interaction</h2><button class="modal-close" onclick="closeFeedbackModal()">√ó</button></div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 24px;">How was your experience with <strong id="feedbackUserName">this person</strong>?</p>
                <div class="rating-buttons">
                    <button class="rating-btn positive" onclick="selectRating('positive')"><span class="emoji">üòä</span><span class="label">Positive</span></button>
                    <button class="rating-btn neutral" onclick="selectRating('neutral')"><span class="emoji">üòê</span><span class="label">Neutral</span></button>
                    <button class="rating-btn negative" onclick="selectRating('negative')"><span class="emoji">üòû</span><span class="label">Negative</span></button>
                </div>
                <div class="form-group"><label>Comments</label><textarea class="form-control" id="feedbackComment" rows="3"></textarea></div>
                <div class="checkbox-item"><input type="checkbox" id="feedbackWouldAgain" checked><label for="feedbackWouldAgain">Would interact again</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button><button class="btn btn-primary" onclick="submitFeedback()">Submit</button></div>
        </div>
    </div>
    
    <!-- Contact Helper Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header"><h2>üì® Contact Helper</h2><button class="modal-close" onclick="closeContactModal()">√ó</button></div>
            <div class="modal-body">
                <div id="contactHelperInfo"></div>
                <div class="form-group"><label>Help Type</label><select class="form-control" id="contactType"><option value="breakdown">üîß Breakdown</option><option value="accommodation">üè† Accommodation</option><option value="meetup">üç∫ Meetup</option><option value="advice">üí° Advice</option></select></div>
                <div class="form-group"><label>Message</label><textarea class="form-control" id="contactMessage" rows="4" placeholder="Hi! I'm traveling through..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button><button class="btn btn-primary" onclick="sendContactRequest()">Send</button></div>
        </div>
    </div>
    
    <!-- Respond to Request Modal -->
    <div class="modal-overlay" id="respondModal">
        <div class="modal">
            <div class="modal-header"><h2>ü§ù Respond to Request</h2><button class="modal-close" onclick="closeRespondModal()">√ó</button></div>
            <div class="modal-body">
                <div id="respondRequestInfo"></div>
                <div class="form-group"><label>Your Response</label><textarea class="form-control" id="respondMessage" rows="4" placeholder="I can help! I'll bring..."></textarea></div>
                <div class="form-group"><label>Estimated Time to Arrive</label><input type="text" class="form-control" id="respondETA" placeholder="e.g., 30 minutes"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeRespondModal()">Cancel</button><button class="btn btn-success" onclick="sendResponse()">‚úÖ I'll Help!</button></div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://mozbpccxzfcoswvxjuym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vemJwY2N4emZjb3N3dnhqdXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODY4NTQsImV4cCI6MjA4NDY2Mjg1NH0.lfOM5ojN2B1MV6wMsntGWmI7OWL7fhUJV5E8b6I48N0';
        
        let db = null, currentUser = null, userProfile = null;
        let helpersMap = null, homeMap = null, availMap = null, dashboardMap = null;
        let markers = [], currentHelpers = [], selectedHelper = null;
        let currentInteractionId = null, selectedRating = null;
        let homeMarker = null, availMarker = null;
        let userVehicles = [];
        let sosTimer = null, sosStartTime = null;
        let currentRespondRequest = null;
        
        // Anonymous Name Generation
        const ADJECTIVES = ['Swift','Brave','Clever','Dusty','Epic','Fierce','Golden','Happy','Iron','Jolly','Keen','Lucky','Mighty','Noble','Ocean','Proud','Quick','Rusty','Shadow','Thunder','Urban','Velvet','Wild','Xenon','Yellow','Zealous','Alpine','Blazing','Coastal','Desert','Eastern','Forest','Glacier','Harbor','Island','Jungle','Karst','Lunar','Misty','Nordic','Outback','Prairie','Quartz','River','Solar','Tropic','Valley','Western','Azure','Crimson','Emerald'];
        const NOUNS = ['Rider','Nomad','Voyager','Wanderer','Explorer','Traveler','Pioneer','Ranger','Scout','Drifter','Adventurer','Journeyer','Roamer','Trekker','Cruiser','Rambler','Wayfarer','Pilgrim','Pathfinder','Navigator','Hawk','Wolf','Bear','Eagle','Fox','Lion','Tiger','Falcon','Raven','Phoenix','Dragon','Panther','Cobra','Viper','Shark','Stallion','Mustang','Thunder','Storm','Blaze','Frost','Shadow','Phantom','Ghost','Specter','Knight','Warrior','Hunter','Seeker','Guardian'];
        const AVATAR_COLORS = ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#14b8a6','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#8b5cf6','#a855f7','#d946ef','#ec4899','#f43f5e'];
        const AVATAR_ICONS = ['ü¶ä','üê∫','ü¶Å','üêØ','ü¶Ö','ü¶â','üêç','ü¶à','üêª','üêº','ü¶å','ü¶è','üêò','ü¶í','üêÜ','ü¶á','üê≤','ü¶ã','ü¶©','üêß','üê¢','ü¶Ä','üêô','ü¶ë','üê¨','üê≥','ü¶≠','üêé','ü¶Ñ','üêó'];
        
        // =====================================================
        // ANONYMOUS NAME GENERATOR (Reddit-style)
        // =====================================================
        function generateAnonymousName(email) {
            // Create hash from email
            let hash = 0;
            for (let i = 0; i < email.length; i++) {
                const char = email.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            hash = Math.abs(hash);
            
            const adjIndex = hash % ADJECTIVES.length;
            const nounIndex = (hash >> 8) % NOUNS.length;
            const number = (hash % 999) + 1;
            
            return `${ADJECTIVES[adjIndex]}${NOUNS[nounIndex]}${number}`;
        }
        
        function generateAvatarData(email) {
            let hash = 0;
            for (let i = 0; i < email.length; i++) {
                hash = ((hash << 5) - hash) + email.charCodeAt(i);
                hash = hash & hash;
            }
            hash = Math.abs(hash);
            
            return {
                color: AVATAR_COLORS[hash % AVATAR_COLORS.length],
                icon: AVATAR_ICONS[(hash >> 4) % AVATAR_ICONS.length]
            };
        }
        
        function renderAvatar(email, element) {
            const data = generateAvatarData(email);
            element.style.background = data.color;
            element.textContent = data.icon;
        }
        
        // =====================================================
        // INITIALIZATION
        // =====================================================
        window.onload = function() {
            initDatabase();
            checkURLParams();
            setTimeout(initMaps, 100);
        };
        
        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            if (mode === 'signup') {
                showSignUp();
            } else {
                showSignIn();
            }
        }
        
        function initDatabase() {
            try {
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                updateConnectionStatus(true);
                checkAuth();
            } catch (e) {
                console.error('DB Error:', e);
                updateConnectionStatus(false);
            }
        }
        
        function initMaps() {
            const defaultView = [-36.8485, 174.7633];
            
            helpersMap = L.map('helpersMap').setView(defaultView, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(helpersMap);
            
            homeMap = L.map('homeMap').setView(defaultView, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(homeMap);
            
            availMap = L.map('availMap').setView(defaultView, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(availMap);
            
            dashboardMap = L.map('dashboardMap').setView(defaultView, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(dashboardMap);
        }
        
        function updateConnectionStatus(c) {
            const b = document.getElementById('connectionStatus');
            b.textContent = c ? 'Connected' : 'Disconnected';
            b.className = 'status-badge ' + (c ? 'status-connected' : 'status-disconnected');
        }
        
        // =====================================================
        // AUTH TOGGLE (Sign In / Sign Up)
        // =====================================================
        function showSignIn() {
            document.getElementById('signInCard').classList.remove('hidden');
            document.getElementById('signUpCard').classList.add('hidden');
        }
        
        function showSignUp() {
            document.getElementById('signInCard').classList.add('hidden');
            document.getElementById('signUpCard').classList.remove('hidden');
        }
        
        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            setTimeout(() => {
                if (tabId === 'helpers' && helpersMap) helpersMap.invalidateSize();
                if (tabId === 'profile' && homeMap) homeMap.invalidateSize();
                if (tabId === 'availability' && availMap) availMap.invalidateSize();
                if (tabId === 'dashboard' && dashboardMap) dashboardMap.invalidateSize();
            }, 100);
            
            if (tabId === 'activity') loadActivity();
            if (tabId === 'dashboard') loadDashboard();
        }
        
        function showLoggedInTabs() {
            document.querySelectorAll('.tab[data-tab]').forEach(t => {
                if (t.dataset.tab !== 'auth') t.classList.remove('hidden');
            });
            document.querySelector('.tab[data-tab="auth"]').classList.add('hidden');
        }
        
        // =====================================================
        // AUTHENTICATION
        // =====================================================
        async function checkAuth() {
            if (!db) return;
            const { data } = await db.auth.getUser();
            if (data && data.user) {
                currentUser = data.user;
                await onUserLoggedIn();
            }
        }
        
        async function onUserLoggedIn() {
            // Generate anonymous name
            const displayName = generateAnonymousName(currentUser.email);
            
            // Update header
            document.getElementById('userArea').classList.remove('hidden');
            document.getElementById('userDisplayName').textContent = displayName;
            renderAvatar(currentUser.email, document.getElementById('userAvatar'));
            
            // Update profile section
            document.getElementById('profileDisplayName').textContent = displayName;
            renderAvatar(currentUser.email, document.getElementById('profileAvatar'));
            
            // Show logged in tabs and switch to dashboard
            showLoggedInTabs();
            showTab('dashboard', document.querySelector('[data-tab="dashboard"]'));
            
            // Load data
            await loadProfile();
            await loadAvailability();
            await loadVehicles();
            await checkPendingFeedback();
            await loadDashboard();
        }
        
        async function handleSignIn() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            const resultDiv = document.getElementById('signInResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter email and password</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">Signing in...</div>';
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            
            if (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå ' + error.message + '</div>';
            } else {
                currentUser = data.user;
                resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ Welcome back!</div>';
                await onUserLoggedIn();
            }
        }
        
        async function handleSignUp() {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const resultDiv = document.getElementById('signUpResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter email and password</div>';
                return;
            }
            
            // Generate the display name that will be used
            const displayName = generateAnonymousName(email);
            
            resultDiv.innerHTML = '<div class="alert alert-info">Creating account...</div>';
            const { data, error } = await db.auth.signUp({
                email, password,
                options: { data: { display_name: displayName } }
            });
            
            if (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå ' + error.message + '</div>';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-success">‚úÖ Account created! Your anonymous name is <strong>${displayName}</strong>. Check your email to verify, then sign in.</div>`;
            }
        }
        
        async function handleSignOut() {
            await db.auth.signOut();
            currentUser = null;
            userProfile = null;
            document.getElementById('userArea').classList.add('hidden');
            
            // Hide logged in tabs
            document.querySelectorAll('.tab[data-tab]').forEach(t => {
                if (t.dataset.tab !== 'auth') t.classList.add('hidden');
            });
            document.querySelector('.tab[data-tab="auth"]').classList.remove('hidden');
            
            showTab('auth', document.querySelector('[data-tab="auth"]'));
            showSignIn();
        }
        
        // =====================================================
        // DASHBOARD
        // =====================================================
        async function loadDashboard() {
            if (!currentUser) return;
            
            // Load user's availability to get their location and radius
            const { data: avail } = await db.from('user_availability').select('*').eq('user_id', currentUser.id).single();
            
            if (avail && avail.latitude && avail.longitude) {
                dashboardMap.setView([avail.latitude, avail.longitude], 11);
                L.marker([avail.latitude, avail.longitude]).addTo(dashboardMap).bindPopup('üìç You');
            }
            
            // Load nearby SOS requests
            await loadNearbyRequests(avail);
            
            // Load nearby travelers
            await loadNearbyTravelers(avail);
            
            // Load stats
            await loadDashboardStats();
        }
        
        async function loadNearbyRequests(avail) {
            const div = document.getElementById('nearbyRequests');
            
            if (!avail || !avail.latitude || !avail.longitude) {
                div.innerHTML = '<div class="alert alert-info">Set your availability location to see nearby requests.</div>';
                return;
            }
            
            const { data: requests } = await db.from('sos_alerts')
                .select('*, profiles(id, email)')
                .eq('status', 'active')
                .order('created_at', { ascending: false });
            
            if (!requests || requests.length === 0) {
                div.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">No active requests nearby. üéâ</p>';
                document.getElementById('statNearbyRequests').textContent = '0';
                return;
            }
            
            // Filter by distance
            const nearbyRequests = requests.filter(r => {
                if (!r.latitude || !r.longitude) return false;
                const dist = getDistance(avail.latitude, avail.longitude, r.latitude, r.longitude);
                r.distance = dist;
                return dist <= (avail.max_help_radius_km || 50);
            }).sort((a, b) => a.distance - b.distance);
            
            document.getElementById('statNearbyRequests').textContent = nearbyRequests.length;
            
            if (nearbyRequests.length === 0) {
                div.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">No requests within your help radius.</p>';
                return;
            }
            
            div.innerHTML = nearbyRequests.map(r => {
                const email = r.profiles?.email || 'unknown@email.com';
                const displayName = generateAnonymousName(email);
                const avatar = generateAvatarData(email);
                const severityClass = 'severity-' + r.severity;
                const cardClass = r.severity === 'critical' ? 'urgent' : (r.severity === 'high' ? 'high' : '');
                const typeEmoji = { breakdown: 'üîß', accident: 'üí•', medical: 'üè•', stuck: 'üöô', fuel: '‚õΩ', unsafe: '‚ö†Ô∏è', other: '‚ùì' }[r.alert_type] || '‚ùì';
                
                return `
                    <div class="request-card ${cardClass}">
                        <div class="request-header">
                            <div class="request-user">
                                <div class="request-avatar" style="background: ${avatar.color}">${avatar.icon}</div>
                                <div class="request-info">
                                    <h4>${displayName}</h4>
                                    <p>üìç ${r.distance.toFixed(1)} km away</p>
                                </div>
                            </div>
                            <span class="request-severity ${severityClass}">${r.severity.toUpperCase()}</span>
                        </div>
                        <div class="request-body">
                            <div class="request-type">${typeEmoji} ${r.alert_type}</div>
                            <p class="request-description">${r.description || 'No description provided'}</p>
                        </div>
                        <div class="request-meta">
                            <span>üïê ${new Date(r.created_at).toLocaleTimeString()}</span>
                        </div>
                        <div class="request-actions">
                            <button class="btn btn-success btn-sm" onclick="openRespondModal('${r.id}', '${displayName}', '${r.alert_type}', '${r.description || ''}')">‚úÖ I Can Help</button>
                            <button class="btn btn-secondary btn-sm" onclick="focusRequestOnMap(${r.latitude}, ${r.longitude})">üó∫Ô∏è View on Map</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadNearbyTravelers(avail) {
            const div = document.getElementById('nearbyTravelers');
            
            if (!avail || !avail.latitude || !avail.longitude) {
                div.innerHTML = '<p style="color: var(--text-light);">Set your location to see nearby travelers.</p>';
                return;
            }
            
            const { data: travelers } = await db.from('user_availability')
                .select('*, profiles(id, email)')
                .eq('is_available', true)
                .neq('user_id', currentUser.id);
            
            if (!travelers || travelers.length === 0) {
                div.innerHTML = '<p style="color: var(--text-light); text-align: center;">No travelers nearby right now.</p>';
                document.getElementById('statNearbyTravelers').textContent = '0';
                return;
            }
            
            const nearbyTravelers = travelers.filter(t => {
                if (!t.latitude || !t.longitude) return false;
                const dist = getDistance(avail.latitude, avail.longitude, t.latitude, t.longitude);
                t.distance = dist;
                return dist <= (avail.max_help_radius_km || 50);
            }).sort((a, b) => a.distance - b.distance).slice(0, 5);
            
            document.getElementById('statNearbyTravelers').textContent = nearbyTravelers.length;
            
            if (nearbyTravelers.length === 0) {
                div.innerHTML = '<p style="color: var(--text-light); text-align: center;">No travelers within your radius.</p>';
                return;
            }
            
            div.innerHTML = nearbyTravelers.map(t => {
                const email = t.profiles?.email || 'unknown@email.com';
                const displayName = generateAnonymousName(email);
                const avatar = generateAvatarData(email);
                
                const types = [];
                if (t.can_pickup) types.push('üöó');
                if (t.can_provide_garage) types.push('üîß');
                if (t.can_provide_accommodation) types.push('üè†');
                if (t.can_meet_for_drinks) types.push('üç∫');
                
                return `
                    <div class="traveler-card">
                        <div class="traveler-avatar" style="background: ${avatar.color}">${avatar.icon}</div>
                        <div class="traveler-info">
                            <h5>${displayName}</h5>
                            <p>üìç ${t.distance.toFixed(1)} km away ‚Ä¢ ${t.current_location_name || 'Nearby'}</p>
                            <div class="traveler-types">${types.map(t => `<span class="type-tag">${t}</span>`).join('')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadDashboardStats() {
            // Help given count
            const { count: helpCount } = await db.from('interactions')
                .select('*', { count: 'exact', head: true })
                .eq('helper_id', currentUser.id)
                .eq('status', 'completed');
            document.getElementById('statHelpGiven').textContent = helpCount || 0;
            
            // Pending feedback
            const { data: interactions } = await db.from('interactions')
                .select('*')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .eq('status', 'completed');
            
            const pending = (interactions || []).filter(i => 
                (i.requester_id === currentUser.id && !i.requester_feedback_given) ||
                (i.helper_id === currentUser.id && !i.helper_feedback_given)
            );
            document.getElementById('statPendingFeedback').textContent = pending.length;
        }
        
        function focusRequestOnMap(lat, lng) {
            dashboardMap.setView([lat, lng], 14);
        }
        
        // =====================================================
        // RESPOND TO REQUEST
        // =====================================================
        function openRespondModal(requestId, displayName, alertType, description) {
            currentRespondRequest = { id: requestId, displayName, alertType, description };
            
            document.getElementById('respondRequestInfo').innerHTML = `
                <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 8px 0; border: none; padding: 0;">Helping: ${displayName}</h4>
                    <p style="margin: 0; color: var(--text-light);"><strong>Issue:</strong> ${alertType} - ${description || 'No description'}</p>
                </div>
            `;
            
            document.getElementById('respondModal').classList.add('active');
        }
        
        function closeRespondModal() {
            document.getElementById('respondModal').classList.remove('active');
            currentRespondRequest = null;
        }
        
        async function sendResponse() {
            if (!currentRespondRequest) return;
            
            // Create interaction
            const { error } = await db.from('interactions').insert({
                requester_id: null, // Will need to look up from SOS alert
                helper_id: currentUser.id,
                interaction_type: currentRespondRequest.alertType,
                sos_alert_id: currentRespondRequest.id,
                status: 'accepted',
                notes: document.getElementById('respondMessage').value
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('‚úÖ Response sent! The person in need has been notified.');
                closeRespondModal();
                loadDashboard();
            }
        }
        
        // =====================================================
        // PROFILE
        // =====================================================
        async function loadProfile() {
            if (!currentUser) return;
            const { data } = await db.from('profiles').select('*').eq('id', currentUser.id).single();
            
            if (data) {
                userProfile = data;
                document.getElementById('profileFirstName').value = data.first_name || '';
                document.getElementById('profileSurname').value = data.last_name || '';
                document.getElementById('profileMobile').value = data.phone || '';
                document.getElementById('profileCountry').value = data.country || '';
                document.getElementById('profileSuburb').value = data.suburb || '';
                document.getElementById('profileCity').value = data.city || '';
                document.getElementById('profilePostCode').value = data.post_code || '';
                document.getElementById('emergencyName').value = data.emergency_contact_name || '';
                document.getElementById('emergencyPhone').value = data.emergency_contact_phone || '';
                document.getElementById('emergencyEmail').value = data.emergency_contact_email || '';
                
                if (data.home_latitude && data.home_longitude) {
                    document.getElementById('profileHomeLat').value = data.home_latitude;
                    document.getElementById('profileHomeLng').value = data.home_longitude;
                    document.getElementById('homeLocationDisplay').textContent = 'üìç ' + data.home_latitude + ', ' + data.home_longitude;
                    document.getElementById('homeLocationBox').classList.add('has-location');
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                    homeMap.setView([data.home_latitude, data.home_longitude], 14);
                    if (homeMarker) homeMap.removeLayer(homeMarker);
                    homeMarker = L.marker([data.home_latitude, data.home_longitude]).addTo(homeMap);
                }
                
                if (data.unit_distance) selectRadio('unitDistance', data.unit_distance);
                if (data.unit_temperature) selectRadio('unitTemp', data.unit_temperature);
            }
        }
        
        async function handleSaveProfile() {
            if (!currentUser) return;
            const resultDiv = document.getElementById('profileResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            const lat = parseFloat(document.getElementById('profileHomeLat').value);
            const lng = parseFloat(document.getElementById('profileHomeLng').value);
            
            const profileData = {
                id: currentUser.id,
                display_name: generateAnonymousName(currentUser.email),
                first_name: document.getElementById('profileFirstName').value,
                last_name: document.getElementById('profileSurname').value,
                phone: document.getElementById('profileMobile').value,
                country: document.getElementById('profileCountry').value,
                suburb: document.getElementById('profileSuburb').value,
                city: document.getElementById('profileCity').value,
                post_code: document.getElementById('profilePostCode').value,
                home_latitude: isNaN(lat) ? null : lat,
                home_longitude: isNaN(lng) ? null : lng,
                emergency_contact_name: document.getElementById('emergencyName').value,
                emergency_contact_phone: document.getElementById('emergencyPhone').value,
                emergency_contact_email: document.getElementById('emergencyEmail').value,
                unit_distance: document.querySelector('input[name="unitDistance"]:checked')?.value || 'km',
                unit_temperature: document.querySelector('input[name="unitTemp"]:checked')?.value || 'celsius',
                updated_at: new Date().toISOString()
            };
            
            const { error } = await db.from('profiles').upsert(profileData);
            resultDiv.innerHTML = error ? 
                '<div class="alert alert-danger">‚ùå ' + error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Profile saved!</div>';
        }
        
        function captureHomeGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('profileHomeLat').value = lat;
                    document.getElementById('profileHomeLng').value = lng;
                    document.getElementById('homeLocationDisplay').textContent = 'üìç ' + lat + ', ' + lng;
                    document.getElementById('homeLocationBox').classList.add('has-location');
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                    homeMap.setView([parseFloat(lat), parseFloat(lng)], 14);
                    if (homeMarker) homeMap.removeLayer(homeMarker);
                    homeMarker = L.marker([parseFloat(lat), parseFloat(lng)]).addTo(homeMap);
                }, err => {
                    alert('Error: ' + err.message);
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                }, { enableHighAccuracy: true });
            }
        }
        
        function toggleManualEntry() {
            document.getElementById('manualGpsEntry').classList.toggle('hidden');
        }
        
        function selectRadio(name, value) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                r.checked = r.value === value;
                r.closest('.radio-item').classList.toggle('selected', r.checked);
            });
        }
        
        // =====================================================
        // VEHICLES
        // =====================================================
        async function loadVehicles() {
            if (!currentUser) return;
            
            const { data } = await db.from('user_vehicles').select('*').eq('user_id', currentUser.id).order('is_active', { ascending: false });
            userVehicles = data || [];
            renderVehicles();
            populateVehicleDropdown();
        }
        
        function renderVehicles() {
            const div = document.getElementById('vehiclesList');
            
            if (userVehicles.length === 0) {
                div.innerHTML = '<p style="color: var(--text-light); margin-bottom: 16px;">No vehicles added yet.</p>';
                return;
            }
            
            const typeIcons = { motorcycle: 'üèçÔ∏è', car: 'üöó', '4wd': 'üöô', truck: 'üöõ', rv: 'üöê', bicycle: 'üö¥', boat: '‚õµ', other: 'üöó' };
            
            div.innerHTML = userVehicles.map(v => `
                <div class="vehicle-card ${v.is_active ? '' : 'inactive'}">
                    <div class="vehicle-header">
                        <span class="vehicle-icon">${typeIcons[v.vehicle_type] || 'üöó'}</span>
                        <span class="vehicle-status ${v.is_active ? 'active' : 'inactive'}">${v.is_active ? 'Active' : 'Inactive'}</span>
                    </div>
                    <h5>${v.year || ''} ${v.make} ${v.model}</h5>
                    <div class="vehicle-details">
                        <span>‚õΩ ${v.fuel_type || 'Not set'}</span>
                        <span>üé® ${v.colour || 'Not set'}</span>
                        <span>üî¢ ${v.registration || 'No rego'}</span>
                    </div>
                    ${v.notes ? `<p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">üìù ${v.notes}</p>` : ''}
                    <div class="vehicle-actions">
                        <button class="btn btn-secondary btn-xs" onclick="editVehicle('${v.id}')">‚úèÔ∏è Edit</button>
                    </div>
                </div>
            `).join('');
        }
        
        function populateVehicleDropdown() {
            const select = document.getElementById('sosVehicle');
            select.innerHTML = '<option value="">-- No vehicle / Not vehicle-related --</option>';
            
            userVehicles.filter(v => v.is_active).forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.year || ''} ${v.make} ${v.model} (${v.fuel_type || 'Unknown fuel'})</option>`;
            });
        }
        
        function openVehicleModal() {
            document.getElementById('vehicleModalTitle').textContent = 'Add Vehicle';
            document.getElementById('vehicleEditId').value = '';
            document.getElementById('vehicleType').value = 'motorcycle';
            document.getElementById('vehicleMake').value = '';
            document.getElementById('vehicleModel').value = '';
            document.getElementById('vehicleYear').value = '';
            document.getElementById('vehicleFuel').value = '';
            document.getElementById('vehicleColour').value = '';
            document.getElementById('vehicleRego').value = '';
            document.getElementById('vehicleNotes').value = '';
            document.getElementById('vehicleActive').checked = true;
            document.getElementById('vehicleDeleteBtn').classList.add('hidden');
            document.getElementById('vehicleModal').classList.add('active');
        }
        
        function editVehicle(id) {
            const v = userVehicles.find(x => x.id === id);
            if (!v) return;
            
            document.getElementById('vehicleModalTitle').textContent = 'Edit Vehicle';
            document.getElementById('vehicleEditId').value = v.id;
            document.getElementById('vehicleType').value = v.vehicle_type || 'car';
            document.getElementById('vehicleMake').value = v.make || '';
            document.getElementById('vehicleModel').value = v.model || '';
            document.getElementById('vehicleYear').value = v.year || '';
            document.getElementById('vehicleFuel').value = v.fuel_type || '';
            document.getElementById('vehicleColour').value = v.colour || '';
            document.getElementById('vehicleRego').value = v.registration || '';
            document.getElementById('vehicleNotes').value = v.notes || '';
            document.getElementById('vehicleActive').checked = v.is_active;
            document.getElementById('vehicleDeleteBtn').classList.remove('hidden');
            document.getElementById('vehicleModal').classList.add('active');
        }
        
        function closeVehicleModal() {
            document.getElementById('vehicleModal').classList.remove('active');
        }
        
        async function saveVehicle() {
            const editId = document.getElementById('vehicleEditId').value;
            
            const vehicleData = {
                user_id: currentUser.id,
                vehicle_type: document.getElementById('vehicleType').value,
                make: document.getElementById('vehicleMake').value,
                model: document.getElementById('vehicleModel').value,
                year: parseInt(document.getElementById('vehicleYear').value) || null,
                fuel_type: document.getElementById('vehicleFuel').value,
                colour: document.getElementById('vehicleColour').value,
                registration: document.getElementById('vehicleRego').value,
                notes: document.getElementById('vehicleNotes').value,
                is_active: document.getElementById('vehicleActive').checked,
                updated_at: new Date().toISOString()
            };
            
            let error;
            if (editId) {
                const result = await db.from('user_vehicles').update(vehicleData).eq('id', editId);
                error = result.error;
            } else {
                const result = await db.from('user_vehicles').insert(vehicleData);
                error = result.error;
            }
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                closeVehicleModal();
                await loadVehicles();
            }
        }
        
        async function deleteVehicle() {
            const editId = document.getElementById('vehicleEditId').value;
            if (!editId || !confirm('Delete this vehicle?')) return;
            
            const { error } = await db.from('user_vehicles').delete().eq('id', editId);
            if (error) {
                alert('Error: ' + error.message);
            } else {
                closeVehicleModal();
                await loadVehicles();
            }
        }
        
        // =====================================================
        // AVAILABILITY
        // =====================================================
        async function loadAvailability() {
            if (!currentUser) return;
            const { data } = await db.from('user_availability').select('*').eq('user_id', currentUser.id).single();
            
            if (data) {
                document.getElementById('availActive').checked = data.is_available;
                document.getElementById('availLocation').value = data.current_location_name || '';
                document.getElementById('availRadius').value = data.max_help_radius_km || 50;
                document.getElementById('canPickup').checked = data.can_pickup;
                document.getElementById('canGarage').checked = data.can_provide_garage;
                document.getElementById('canStay').checked = data.can_provide_accommodation;
                document.getElementById('canMeet').checked = data.can_meet_for_drinks;
                document.getElementById('canAdvice').checked = data.can_provide_local_advice;
                document.getElementById('canHelp').checked = data.can_provide_help;
                
                if (data.latitude && data.longitude) {
                    document.getElementById('availLat').value = data.latitude;
                    document.getElementById('availLng').value = data.longitude;
                    availMap.setView([data.latitude, data.longitude], 12);
                    if (availMarker) availMap.removeLayer(availMarker);
                    availMarker = L.marker([data.latitude, data.longitude]).addTo(availMap);
                }
            }
        }
        
        async function handleSaveAvailability() {
            if (!currentUser) return;
            const resultDiv = document.getElementById('availResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            const lat = parseFloat(document.getElementById('availLat').value);
            const lng = parseFloat(document.getElementById('availLng').value);
            
            const data = {
                user_id: currentUser.id,
                is_available: document.getElementById('availActive').checked,
                current_location_name: document.getElementById('availLocation').value,
                latitude: isNaN(lat) ? null : lat,
                longitude: isNaN(lng) ? null : lng,
                max_help_radius_km: parseInt(document.getElementById('availRadius').value) || 50,
                can_pickup: document.getElementById('canPickup').checked,
                can_provide_garage: document.getElementById('canGarage').checked,
                can_provide_accommodation: document.getElementById('canStay').checked,
                can_meet_for_drinks: document.getElementById('canMeet').checked,
                can_provide_local_advice: document.getElementById('canAdvice').checked,
                can_provide_help: document.getElementById('canHelp').checked,
                updated_at: new Date().toISOString()
            };
            
            const { error } = await db.from('user_availability').upsert(data, { onConflict: 'user_id' });
            resultDiv.innerHTML = error ?
                '<div class="alert alert-danger">‚ùå ' + error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Availability updated!</div>';
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('availLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('availLng').value = pos.coords.longitude.toFixed(6);
                    availMap.setView([pos.coords.latitude, pos.coords.longitude], 12);
                    if (availMarker) availMap.removeLayer(availMarker);
                    availMarker = L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(availMap);
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        // =====================================================
        // FIND HELPERS
        // =====================================================
        function getSearchLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('searchLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('searchLng').value = pos.coords.longitude.toFixed(6);
                    helpersMap.setView([pos.coords.latitude, pos.coords.longitude], 11);
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        async function handleSearchHelpers() {
            const resultsDiv = document.getElementById('helperResults');
            resultsDiv.innerHTML = '<p class="loading">üîç Searching...</p>';
            
            const lat = parseFloat(document.getElementById('searchLat').value);
            const lng = parseFloat(document.getElementById('searchLng').value);
            const radius = parseInt(document.getElementById('searchRadius').value) || 50;
            
            if (isNaN(lat) || isNaN(lng)) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">üìç Please get your location first</div>';
                return;
            }
            
            markers.forEach(m => helpersMap.removeLayer(m));
            markers = [];
            
            // User marker
            const userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: '',
                    html: '<div style="background:#3b82f6;color:white;padding:10px 14px;border-radius:25px;font-size:14px;font-weight:600;">üìç You</div>',
                    iconAnchor: [30, 20]
                })
            }).addTo(helpersMap);
            markers.push(userMarker);
            
            let query = db.from('user_availability')
                .select('*, profiles(id, email)')
                .eq('is_available', true)
                .neq('user_id', currentUser.id);
            
            if (document.getElementById('needPickup').checked) query = query.eq('can_pickup', true);
            if (document.getElementById('needGarage').checked) query = query.eq('can_provide_garage', true);
            if (document.getElementById('needStay').checked) query = query.eq('can_provide_accommodation', true);
            if (document.getElementById('needMeet').checked) query = query.eq('can_meet_for_drinks', true);
            
            const { data, error } = await query;
            if (error) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">' + error.message + '</div>';
                return;
            }
            
            currentHelpers = (data || []).filter(h => {
                if (!h.latitude || !h.longitude) return false;
                h.distance = getDistance(lat, lng, h.latitude, h.longitude);
                return h.distance <= radius;
            }).sort((a, b) => a.distance - b.distance);
            
            if (currentHelpers.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">No helpers found. Try increasing radius.</div>';
                return;
            }
            
            currentHelpers.forEach((h, i) => {
                const email = h.profiles?.email || 'unknown@email.com';
                const displayName = generateAnonymousName(email);
                const avatar = generateAvatarData(email);
                
                const marker = L.marker([h.latitude, h.longitude], {
                    icon: L.divIcon({
                        className: '',
                        html: `<div style="background:${avatar.color};color:white;padding:8px 14px;border-radius:20px;font-size:13px;font-weight:600;">${avatar.icon} ${displayName.substring(0, 12)}</div>`,
                        iconAnchor: [50, 20]
                    })
                }).addTo(helpersMap);
                
                const services = [];
                if (h.can_pickup) services.push('üöó');
                if (h.can_provide_garage) services.push('üîß');
                if (h.can_provide_accommodation) services.push('üè†');
                if (h.can_meet_for_drinks) services.push('üç∫');
                
                marker.bindPopup(`<strong>${displayName}</strong><br>üìç ${h.distance.toFixed(1)} km<br>${services.join(' ')}<br><button onclick="openContactModal(${i})" style="margin-top:8px;padding:8px 16px;background:#1F4788;color:white;border:none;border-radius:8px;cursor:pointer;">üì® Contact</button>`);
                markers.push(marker);
            });
            
            helpersMap.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
            
            resultsDiv.innerHTML = `<h4>${currentHelpers.length} helper(s) found</h4>` + currentHelpers.map((h, i) => {
                const email = h.profiles?.email || 'unknown@email.com';
                const displayName = generateAnonymousName(email);
                const avatar = generateAvatarData(email);
                const services = [];
                if (h.can_pickup) services.push('üöó Pickup');
                if (h.can_provide_garage) services.push('üîß Garage');
                if (h.can_provide_accommodation) services.push('üè† Stay');
                if (h.can_meet_for_drinks) services.push('üç∫ Meetup');
                
                return `
                    <div class="request-card" style="cursor: pointer;" onclick="focusHelper(${i})">
                        <div class="request-user">
                            <div class="request-avatar" style="background: ${avatar.color}">${avatar.icon}</div>
                            <div class="request-info">
                                <h4>${displayName}</h4>
                                <p>üìç ${h.distance.toFixed(1)} km ‚Ä¢ ${h.current_location_name || 'Nearby'}</p>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">${services.map(s => `<span class="type-tag">${s}</span>`).join('')}</div>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openContactModal(${i})">üì® Contact</button>
                    </div>
                `;
            }).join('');
        }
        
        function focusHelper(i) {
            const h = currentHelpers[i];
            helpersMap.setView([h.latitude, h.longitude], 14);
            markers[i + 1].openPopup();
        }
        
        // =====================================================
        // CONTACT HELPER
        // =====================================================
        function openContactModal(i) {
            selectedHelper = currentHelpers[i];
            const email = selectedHelper.profiles?.email || 'unknown@email.com';
            const displayName = generateAnonymousName(email);
            const avatar = generateAvatarData(email);
            
            document.getElementById('contactHelperInfo').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;padding:20px;background:var(--bg);border-radius:12px;">
                    <div style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;margin:0 auto 12px;background:${avatar.color}">${avatar.icon}</div>
                    <h3 style="font-size:18px;">${displayName}</h3>
                    <p style="color:var(--text-light);">üìç ${selectedHelper.distance.toFixed(1)} km away</p>
                </div>
            `;
            document.getElementById('contactModal').classList.add('active');
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            selectedHelper = null;
        }
        
        async function sendContactRequest() {
            if (!currentUser || !selectedHelper) return;
            
            const { error } = await db.from('interactions').insert({
                requester_id: currentUser.id,
                helper_id: selectedHelper.profiles.id,
                interaction_type: document.getElementById('contactType').value,
                status: 'pending',
                notes: document.getElementById('contactMessage').value
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('‚úÖ Request sent!');
                closeContactModal();
                document.getElementById('contactMessage').value = '';
            }
        }
        
        // =====================================================
        // ACTIVITY & FEEDBACK
        // =====================================================
        async function checkPendingFeedback() {
            if (!currentUser) return;
            
            const { data } = await db.from('interactions')
                .select('*')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .eq('status', 'completed');
            
            const pending = (data || []).filter(i =>
                (i.requester_id === currentUser.id && !i.requester_feedback_given) ||
                (i.helper_id === currentUser.id && !i.helper_feedback_given)
            );
            
            const badge = document.getElementById('pendingBadge');
            if (pending.length > 0) {
                badge.classList.remove('hidden');
                badge.textContent = '‚ö†Ô∏è ' + pending.length;
            } else {
                badge.classList.add('hidden');
            }
        }
        
        async function loadActivity() {
            if (!currentUser) return;
            
            const { data } = await db.from('interactions')
                .select('*, requester:requester_id(email), helper:helper_id(email)')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });
            
            const all = data || [];
            const pending = all.filter(i => {
                if (i.status !== 'completed') return false;
                if (i.requester_id === currentUser.id && !i.requester_feedback_given) return true;
                if (i.helper_id === currentUser.id && !i.helper_feedback_given) return true;
                return false;
            });
            
            const pendingDiv = document.getElementById('pendingInteractions');
            if (pending.length > 0) {
                document.getElementById('pendingFeedbackAlert').classList.remove('hidden');
                pendingDiv.innerHTML = pending.map(i => {
                    const otherEmail = i.requester_id === currentUser.id ? i.helper?.email : i.requester?.email;
                    const name = generateAnonymousName(otherEmail || 'unknown');
                    return `
                        <div class="request-card" style="border-color: var(--warning); background: var(--warning-light);">
                            <p><strong>With:</strong> ${name}</p>
                            <p style="color:var(--text-light);font-size:13px;">${i.interaction_type} ‚Ä¢ ${new Date(i.created_at).toLocaleDateString()}</p>
                            <button class="btn btn-accent btn-sm" onclick="openFeedbackModal('${i.id}', '${name}')" style="margin-top:12px;">‚≠ê Give Feedback</button>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('pendingFeedbackAlert').classList.add('hidden');
                pendingDiv.innerHTML = '<p style="color:var(--success);">‚úÖ All caught up!</p>';
            }
            
            const recentDiv = document.getElementById('recentActivity');
            if (all.length > 0) {
                recentDiv.innerHTML = all.slice(0, 10).map(i => {
                    const otherEmail = i.requester_id === currentUser.id ? i.helper?.email : i.requester?.email;
                    const name = generateAnonymousName(otherEmail || 'unknown');
                    return `
                        <div class="request-card">
                            <p><strong>${i.requester_id === currentUser.id ? 'You requested help from' : 'You helped'}:</strong> ${name}</p>
                            <p style="color:var(--text-light);font-size:13px;">${i.interaction_type} ‚Ä¢ ${i.status} ‚Ä¢ ${new Date(i.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }).join('');
            } else {
                recentDiv.innerHTML = '<p style="color:var(--text-light);">No activity yet.</p>';
            }
        }
        
        function openFeedbackModal(id, name) {
            currentInteractionId = id;
            selectedRating = null;
            document.getElementById('feedbackUserName').textContent = name;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('feedbackComment').value = '';
            document.getElementById('feedbackWouldAgain').checked = true;
            document.getElementById('feedbackModal').classList.add('active');
        }
        
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            currentInteractionId = null;
        }
        
        function selectRating(r) {
            selectedRating = r;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('.rating-btn.' + r).classList.add('selected');
        }
        
        async function submitFeedback() {
            if (!selectedRating) { alert('Select a rating'); return; }
            
            const { data: interaction } = await db.from('interactions').select('*').eq('id', currentInteractionId).single();
            if (!interaction) return;
            
            const isRequester = interaction.requester_id === currentUser.id;
            const toId = isRequester ? interaction.helper_id : interaction.requester_id;
            
            await db.from('feedback').insert({
                interaction_id: currentInteractionId,
                from_user_id: currentUser.id,
                to_user_id: toId,
                rating: selectedRating,
                comment: document.getElementById('feedbackComment').value,
                would_interact_again: document.getElementById('feedbackWouldAgain').checked,
                interaction_type: interaction.interaction_type
            });
            
            const updateField = isRequester ? 'requester_feedback_given' : 'helper_feedback_given';
            await db.from('interactions').update({ [updateField]: true }).eq('id', currentInteractionId);
            
            closeFeedbackModal();
            checkPendingFeedback();
            loadActivity();
            loadDashboardStats();
            alert('‚úÖ Thanks for your feedback!');
        }
        
        // =====================================================
        // SOS
        // =====================================================
        function getSOSLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('sosLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('sosLng').value = pos.coords.longitude.toFixed(6);
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        function startSOS() {
            document.getElementById('sosButton').classList.add('holding');
            sosStartTime = Date.now();
            document.getElementById('sosStatus').textContent = 'Keep holding...';
            document.getElementById('sosStatus').style.color = 'var(--danger)';
            
            sosTimer = setInterval(() => {
                const elapsed = Date.now() - sosStartTime;
                document.getElementById('sosProgress').style.width = Math.min((elapsed / 3000) * 100, 100) + '%';
                if (elapsed >= 3000) {
                    cancelSOS();
                    triggerSOS();
                }
            }, 50);
        }
        
        function cancelSOS() {
            document.getElementById('sosButton').classList.remove('holding');
            document.getElementById('sosProgress').style.width = '0%';
            if (sosTimer) { clearInterval(sosTimer); sosTimer = null; }
            if (!sosStartTime || Date.now() - sosStartTime < 3000) {
                document.getElementById('sosStatus').textContent = '';
            }
        }
        
        function triggerSOS() {
            document.getElementById('sosStatus').textContent = 'üö® SOS TRIGGERED!';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async pos => {
                    await db.from('sos_alerts').insert({
                        user_id: currentUser.id,
                        alert_type: 'emergency',
                        severity: 'critical',
                        description: 'EMERGENCY SOS',
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        status: 'active'
                    });
                    document.getElementById('sosStatus').textContent = '‚úÖ SOS sent!';
                    document.getElementById('sosStatus').style.color = 'var(--success)';
                }, () => {
                    document.getElementById('sosStatus').textContent = '‚ö†Ô∏è Could not get location';
                }, { enableHighAccuracy: true });
            }
        }
        
        async function handleCreateSOS() {
            if (!currentUser) return;
            const resultDiv = document.getElementById('sosResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Sending...</div>';
            
            const vehicleId = document.getElementById('sosVehicle').value;
            let vehicleInfo = null;
            if (vehicleId) {
                const vehicle = userVehicles.find(v => v.id === vehicleId);
                if (vehicle) {
                    vehicleInfo = `${vehicle.year || ''} ${vehicle.make} ${vehicle.model} (${vehicle.fuel_type || 'Unknown fuel'})`;
                }
            }
            
            const { error } = await db.from('sos_alerts').insert({
                user_id: currentUser.id,
                alert_type: document.getElementById('sosType').value,
                severity: document.getElementById('sosSeverity').value,
                description: document.getElementById('sosDescription').value + (vehicleInfo ? `\n\nüöó Vehicle: ${vehicleInfo}` : ''),
                latitude: parseFloat(document.getElementById('sosLat').value) || null,
                longitude: parseFloat(document.getElementById('sosLng').value) || null,
                status: 'active'
            });
            
            resultDiv.innerHTML = error ?
                '<div class="alert alert-danger">‚ùå ' + error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Help request sent!</div>';
            
            if (!error) document.getElementById('sosDescription').value = '';
        }
        
        // =====================================================
        // UTILITIES
        // =====================================================
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
