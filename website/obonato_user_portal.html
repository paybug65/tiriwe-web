<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato - I exist because you exist</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1F4788; --primary-dark: #163560; --accent: #f59e0b; --accent-dark: #d97706;
            --success: #10b981; --success-light: #d1fae5; --warning: #f59e0b; --warning-light: #fef3c7;
            --danger: #ef4444; --danger-light: #fee2e2; --bg: #f8fafc; --bg-alt: #f1f5f9;
            --card: #ffffff; --border: #e2e8f0; --text: #1e293b; --text-light: #64748b; --w3w: #e11f26;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.6; }
        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 0 24px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: white; }
        .logo-icon { font-size: 32px; }
        .logo-text h1 { font-size: 24px; font-weight: 800; }
        .logo-text span { font-size: 11px; opacity: 0.8; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        .pending-badge { background: var(--danger); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; border: 2px solid rgba(255,255,255,0.3); }
        .btn-signout { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .tabs { display: flex; background: var(--card); border-radius: 16px 16px 0 0; overflow-x: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-bottom: 2px solid var(--border); }
        .tab { padding: 18px 28px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-light); white-space: nowrap; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: var(--primary); background: var(--bg); }
        .tab.active { color: var(--primary); border-bottom-color: var(--accent); background: white; }
        .tab-content { display: none; background: var(--card); padding: 32px; border-radius: 0 0 16px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 500px; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 24px; }
        .card h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--primary); }
        .card h4 { font-size: 16px; font-weight: 700; margin: 28px 0 16px; color: var(--text); padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .card h4:first-of-type { margin-top: 0; }
        .auth-container { max-width: 450px; margin: 0 auto; }
        .auth-card { background: var(--card); border-radius: 20px; padding: 40px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); border: 2px solid var(--border); }
        .auth-card.signin { border-color: var(--primary); }
        .auth-card.signup { border-color: var(--accent); }
        .auth-card .card-header { text-align: center; margin-bottom: 32px; }
        .auth-card .card-icon { font-size: 56px; margin-bottom: 16px; }
        .auth-card .card-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .auth-card.signin .card-title { color: var(--primary); }
        .auth-card.signup .card-title { color: var(--accent-dark); }
        .auth-card .card-subtitle { color: var(--text-light); }
        .auth-toggle { text-align: center; margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border); }
        .auth-toggle a { color: var(--primary); font-weight: 600; cursor: pointer; text-decoration: underline; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-control { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; font-family: inherit; background: var(--bg); }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; }
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg-alt); color: var(--text); border: 2px solid var(--border); }
        .btn-sm { padding: 10px 18px; font-size: 13px; }
        .btn-xs { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; }
        .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 500; display: flex; align-items: center; gap: 12px; }
        .alert-success { background: var(--success-light); color: #065f46; }
        .alert-danger { background: var(--danger-light); color: #991b1b; }
        .alert-warning { background: var(--warning-light); color: #92400e; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 24px; border-radius: 16px; text-align: center; }
        .stat-card.accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); }
        .stat-card.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }
        .stat-card .stat-value { font-size: 36px; font-weight: 800; }
        .stat-card .stat-label { font-size: 14px; opacity: 0.9; }
        .request-card { background: var(--card); border: 2px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 16px; }
        .request-card:hover { border-color: var(--primary); }
        .request-card.urgent { border-color: var(--danger); background: var(--danger-light); }
        .request-card.high { border-color: var(--warning); background: var(--warning-light); }
        .request-user { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .request-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
        .request-info h4 { font-size: 16px; margin: 0; padding: 0; border: none; }
        .request-info p { font-size: 13px; color: var(--text-light); margin: 0; }
        .vehicle-card { background: var(--bg); border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .vehicle-card.inactive { opacity: 0.6; }
        .vehicle-card .vehicle-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .vehicle-card .vehicle-icon { font-size: 32px; }
        .vehicle-card .vehicle-status { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .vehicle-card .vehicle-status.active { background: var(--success-light); color: #065f46; }
        .vehicle-card .vehicle-status.inactive { background: var(--bg-alt); color: var(--text-light); }
        .vehicle-card h5 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .vehicle-card .vehicle-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: var(--text-light); }
        .add-vehicle-card { background: var(--bg); border: 2px dashed var(--border); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; }
        .add-vehicle-card:hover { border-color: var(--primary); }
        .traveler-card { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
        .traveler-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .gps-display-box { background: var(--bg); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-top: 16px; }
        .gps-display-box.has-location { border-color: var(--success); background: var(--success-light); }
        .gps-format-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .gps-format-tab { padding: 8px 16px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 13px; font-weight: 600; }
        .gps-format-tab:hover { border-color: var(--primary); }
        .gps-format-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .gps-value-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; font-family: monospace; font-size: 14px; }
        .gps-value-row .label { font-weight: 600; color: var(--text-light); min-width: 50px; font-family: 'Inter'; }
        .gps-value-row .value { flex: 1; word-break: break-all; }
        .gps-value-row .copy-btn { padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .gps-value-row .copy-btn.copied { background: var(--success); }
        .w3w-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--w3w); }
        .w3w-row .w3w-logo { width: 24px; height: 24px; background: var(--w3w); color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; }
        .w3w-row .value { flex: 1; font-weight: 600; color: var(--w3w); font-size: 15px; }
        .w3w-row .copy-btn { padding: 6px 12px; background: var(--w3w); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .location-btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .location-btn { padding: 12px 20px; border: 2px solid var(--border); border-radius: 10px; background: white; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .location-btn:hover { border-color: var(--primary); background: var(--bg); }
        .location-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .map-container { height: 350px; border-radius: 16px; overflow: hidden; border: 2px solid var(--border); margin-bottom: 24px; background: #e5e7eb; }
        .map-container.large { height: 500px; }
        .map-container > div { height: 100% !important; width: 100% !important; }
        .leaflet-container { height: 100% !important; width: 100% !important; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 16px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; background: var(--bg); padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; }
        .checkbox-item:hover { border-color: var(--primary); }
        .checkbox-item input { width: 20px; height: 20px; accent-color: var(--primary); }
        .checkbox-item label { cursor: pointer; font-size: 14px; font-weight: 500; }
        .radio-group { display: flex; gap: 16px; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; gap: 10px; background: var(--bg); padding: 14px 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; }
        .radio-item.selected { border-color: var(--primary); background: #eef2ff; }
        .sos-container { text-align: center; padding: 48px; background: linear-gradient(180deg, #fef2f2, #fee2e2); border-radius: 20px; margin-bottom: 24px; }
        .sos-button { width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(145deg, #ef4444, #b91c1c); border: 6px solid #fca5a5; color: white; font-size: 32px; font-weight: 800; cursor: pointer; box-shadow: 0 0 0 8px rgba(239,68,68,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; font-family: inherit; }
        .sos-button.holding { transform: scale(0.95); }
        .sos-button span { font-size: 13px; margin-top: 8px; opacity: 0.9; }
        .sos-progress { width: 200px; height: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; margin: 24px auto; overflow: hidden; }
        .sos-progress-bar { height: 100%; background: linear-gradient(90deg, #fca5a5, #ef4444); width: 0%; transition: width 0.1s linear; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 24px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px 28px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 22px; font-weight: 700; color: var(--primary); }
        .modal-close { background: var(--bg); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 28px; }
        .modal-footer { padding: 20px 28px; border-top: 2px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg); border-radius: 0 0 24px 24px; }
        .rating-buttons { display: flex; gap: 16px; justify-content: center; margin: 28px 0; }
        .rating-btn { padding: 24px 32px; border: 3px solid var(--border); border-radius: 16px; background: white; cursor: pointer; text-align: center; }
        .rating-btn.selected { border-width: 3px; }
        .rating-btn.positive.selected { border-color: var(--success); background: var(--success-light); }
        .rating-btn.neutral.selected { border-color: var(--warning); background: var(--warning-light); }
        .rating-btn.negative.selected { border-color: var(--danger); background: var(--danger-light); }
        .rating-btn .emoji { font-size: 42px; display: block; margin-bottom: 10px; }
        .rating-btn .label { font-size: 14px; font-weight: 700; }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 48px; color: var(--text-light); }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-light); text-decoration: none; font-size: 14px; font-weight: 600; margin-bottom: 20px; padding: 8px 16px; border-radius: 8px; }
        .back-link:hover { color: var(--primary); background: var(--bg); }
        .unread-badge { background: var(--danger); color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }
        .conversation-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border); }
        .conversation-item:hover { background: var(--bg); }
        .conversation-item.unread { background: #eff6ff; border-left: 3px solid var(--primary); }
        .conversation-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .conversation-info { flex: 1; min-width: 0; }
        .conversation-name { font-weight: 600; font-size: 14px; margin: 0; }
        .conversation-preview { font-size: 13px; color: var(--text-light); margin: 2px 0 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-meta { text-align: right; flex-shrink: 0; }
        .conversation-time { font-size: 11px; color: var(--text-light); }
        .conversation-unread-dot { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; margin-top: 4px; margin-left: auto; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; height: auto; padding: 16px 0; gap: 12px; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .map-container { height: 300px; }
            .rating-buttons { flex-direction: column; }
            .sos-button { width: 160px; height: 160px; font-size: 26px; }
            .location-btn-group { flex-direction: column; }
        }
        
        /* Pulsing SOS Tab - Heartbeat Animation */
        .sos-tab {
            position: relative;
            animation: heartbeat-standby 4s ease-in-out infinite;
            background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
            color: var(--danger) !important;
            font-weight: 700 !important;
        }
        .sos-tab.pulse-low {
            animation: heartbeat-low 3.5s ease-in-out infinite;
            background: linear-gradient(135deg, #fef3c7, #fde68a) !important;
        }
        .sos-tab.pulse-medium {
            animation: heartbeat-medium 2.5s ease-in-out infinite;
            background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
        }
        .sos-tab.pulse-high {
            animation: heartbeat-high 1.8s ease-in-out infinite;
            background: linear-gradient(135deg, #fecaca, #fca5a5) !important;
        }
        .sos-tab.pulse-critical {
            animation: heartbeat-critical 1.2s ease-in-out infinite;
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: white !important;
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes heartbeat-standby {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 8px 2px rgba(239, 68, 68, 0.4); }
        }
        @keyframes heartbeat-low {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 10px 3px rgba(245, 158, 11, 0.5); }
        }
        @keyframes heartbeat-medium {
            0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.5); }
            50% { box-shadow: 0 0 12px 4px rgba(249, 115, 22, 0.6); }
        }
        @keyframes heartbeat-high {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 0 14px 5px rgba(239, 68, 68, 0.7); }
        }
        @keyframes heartbeat-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            50% { box-shadow: 0 0 16px 6px rgba(220, 38, 38, 0.8); }
        }
        .sos-tab.has-requests::after {
            content: attr(data-count);
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo"><span class="logo-icon">ğŸŒ</span><div class="logo-text"><h1>Obonato</h1><span>I exist because you exist</span></div></a>
            <div class="header-right">
                <span id="connectionStatus" class="status-badge status-disconnected">Connecting...</span>
                <span id="pendingBadge" class="pending-badge hidden">âš ï¸ 0</span>
                <div id="userArea" class="hidden user-info">
                    <div id="userAvatar" class="user-avatar">?</div>
                    <span id="userDisplayName">User</span>
                    <button class="btn-signout" onclick="handleSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <a href="index.html" class="back-link">â† Back to Home</a>
        
        <div class="tabs">
            <button class="tab active" data-tab="auth" onclick="showTab('auth', this)">ğŸ” Welcome</button>
            <button class="tab hidden" data-tab="dashboard" onclick="showTab('dashboard', this)">ğŸ“Š Dashboard</button>
            <button class="tab hidden" data-tab="messages" onclick="showTab('messages', this)" id="messagesTab">ğŸ’¬ Messages<span id="unreadBadge" class="unread-badge hidden">0</span></button>
            <button class="tab hidden" data-tab="profile" onclick="showTab('profile', this)">ğŸ‘¤ Profile</button>
            <button class="tab hidden" data-tab="availability" onclick="showTab('availability', this)">ğŸ“ Availability</button>
            <button class="tab hidden" data-tab="travel" onclick="showTab('travel', this)">ğŸš— Travel</button>
            <button class="tab hidden" data-tab="helpers" onclick="showTab('helpers', this)">ğŸ—ºï¸ Find Helpers</button>
            <button class="tab hidden" data-tab="places" onclick="showTab('places', this)">ğŸª Places</button>
            <button class="tab hidden" data-tab="activity" onclick="showTab('activity', this)">ğŸ“‹ Activity</button>
            <button class="tab hidden sos-tab" data-tab="sos" onclick="showTab('sos', this)" id="sosTab">ğŸš¨ SOS</button>
        </div>
        
        <!-- Auth Tab -->
        <div id="auth" class="tab-content active">
            <div class="auth-container">
                <div id="signInCard" class="auth-card signin">
                    <div class="card-header"><div class="card-icon">ğŸ‘‹</div><h3 class="card-title">Welcome Back!</h3><p class="card-subtitle">Sign in to your account</p></div>
                    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="signInEmail" placeholder="your@email.com"></div>
                    <div class="form-group"><label>Password</label><input type="password" class="form-control" id="signInPassword"></div>
                    <button class="btn btn-primary btn-block" onclick="handleSignIn()">Sign In â†’</button>
                    <div id="signInResult" style="margin-top: 16px;"></div>
                    <div class="auth-toggle">Don't have an account? <a onclick="showSignUp()">Create one</a></div>
                </div>
                <div id="signUpCard" class="auth-card signup hidden">
                    <div class="card-header"><div class="card-icon">ğŸš€</div><h3 class="card-title">Join Obonato</h3><p class="card-subtitle">Create your free account</p></div>
                    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="signUpEmail" placeholder="your@email.com"></div>
                    <div class="form-group"><label>Password</label><input type="password" class="form-control" id="signUpPassword" placeholder="Min 6 characters"></div>
                    <div class="alert alert-info">ğŸ­ Your anonymous name will be auto-generated for privacy.</div>
                    <button class="btn btn-accent btn-block" onclick="handleSignUp()">Create Account â†’</button>
                    <div id="signUpResult" style="margin-top: 16px;"></div>
                    <div class="auth-toggle">Have an account? <a onclick="showSignIn()">Sign in</a></div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ“Š Dashboard</h3>
                <button class="btn btn-secondary" id="refreshDashboardBtn" onclick="refreshDashboard()" style="padding: 10px 20px;">ğŸ”„ Refresh</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statNearbyRequests">0</div><div class="stat-label">Nearby Requests</div></div>
                <div class="stat-card accent"><div class="stat-value" id="statNearbyTravelers">0</div><div class="stat-label">Travelers Nearby</div></div>
                <div class="stat-card success"><div class="stat-value" id="statHelpGiven">0</div><div class="stat-label">Help Given</div></div>
                <div class="stat-card danger" onclick="showTab('activity', document.querySelector('[data-tab=activity]'))"><div class="stat-value" id="statPendingFeedback">0</div><div class="stat-label">Pending Feedback</div></div>
            </div>
            
            <!-- People I'm Helping Section -->
            <div id="helpingSection" class="card hidden" style="margin-bottom: 20px; border: 2px solid var(--success); background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                <h3 style="color: var(--success);">ğŸš— People I'm Helping</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">Active help responses - they're waiting for you!</p>
                <div id="helpingList"></div>
            </div>
            
            <div class="grid-2">
                <div class="card"><h3>ğŸ†˜ Help Requests Near You</h3><div id="nearbyRequests"><p class="loading">Loading...</p></div></div>
                <div>
                    <div class="card"><h3>ğŸ—ºï¸ Your Area</h3><div class="map-container small"><div id="dashboardMap"></div></div></div>
                    <div class="card"><h3>ğŸ‘¥ Travelers Nearby</h3><div id="nearbyTravelers"><p class="loading">Loading...</p></div></div>
                </div>
            </div>
        </div>
        
        <!-- Messages Tab -->
        <div id="messages" class="tab-content">
            <div class="card">
                <h3>ğŸ’¬ Messages</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Your conversations with other travelers</p>
                <div id="conversationsList">
                    <p class="loading">Loading conversations...</p>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="card">
                <h3>ğŸ‘¤ Your Profile</h3>
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 20px;">
                    <div id="profileAvatar" class="user-avatar" style="width: 80px; height: 80px; font-size: 36px;">?</div>
                    <div><div style="font-size: 12px; opacity: 0.8;">Your Anonymous Identity</div><div id="profileDisplayName" style="font-size: 24px; font-weight: 800;">Loading...</div></div>
                </div>
                
                <h4>ğŸ“¸ Profile Photo <span style="color: var(--danger);">*</span></h4>
                <div style="display: flex; gap: 20px; margin-bottom: 24px; flex-wrap: wrap;">
                    <!-- Photo Upload Section -->
                    <div style="flex: 0 0 auto;">
                        <div id="profilePhotoPreview" style="width: 120px; height: 120px; border-radius: 50%; background: var(--bg-alt); border: 3px dashed var(--danger); display: flex; align-items: center; justify-content: center; font-size: 40px; color: var(--text-light); overflow: hidden; position: relative;">
                            <span id="photoPlaceholder">ğŸ“·</span>
                            <img id="profilePhotoImg" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('profilePhotoInput').click()">ğŸ“¤ Upload</button>
                            <button class="btn btn-danger btn-sm" id="removePhotoBtn" onclick="removeProfilePhoto()" style="display: none;">ğŸ—‘ï¸</button>
                        </div>
                        <p style="font-size: 11px; color: var(--text-light); margin-top: 4px; text-align: center;">Max 2MB â€¢ JPG, PNG</p>
                        <div id="photoUploadStatus"></div>
                    </div>
                    
                    <!-- Verification Status Section -->
                    <div style="flex: 1; min-width: 200px;">
                        <div id="verificationStatus" style="background: var(--bg); border-radius: 12px; padding: 16px;">
                            <h5 style="margin: 0 0 12px; font-size: 14px;">ğŸ›¡ï¸ Verification Status</h5>
                            <div id="verificationLevel" style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">
                                <span style="color: var(--danger);">âš ï¸ Unverified</span>
                            </div>
                            <div id="verificationProgress" style="background: #e5e7eb; border-radius: 10px; height: 8px; margin-bottom: 8px;">
                                <div id="verificationBar" style="background: var(--danger); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="verificationText" style="font-size: 12px; color: var(--text-light); margin: 0;">
                                Upload a photo to start verification
                            </p>
                        </div>
                        
                        <div class="alert alert-warning" style="margin-top: 12px; padding: 12px; font-size: 12px;">
                            âš ï¸ <strong>Important:</strong> Changing your photo will reset your verification status. You'll need 3 positive community verifications to become fully verified again.
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 8px; padding: 12px; font-size: 12px;">
                            ğŸ”’ Your photo is only shown to accepted helpers (so they can recognize you) and during feedback verification.
                        </div>
                    </div>
                </div>
                
                <!-- Verification Levels Legend -->
                <div style="background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <h5 style="margin: 0 0 12px; font-size: 13px; color: var(--text-light);">Verification Levels</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></span>
                            <span>Unverified (no photo)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></span>
                            <span>Photo Added (0 verifications)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #3b82f6;"></span>
                            <span>Verified x1-2</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></span>
                            <span>âœ“ Community Verified (3+)</span>
                        </div>
                    </div>
                </div>
                
                <h4>ğŸ“‹ Personal Information</h4>
                <div class="grid-3">
                    <div class="form-group"><label>First Name</label><input type="text" class="form-control" id="profileFirstName"></div>
                    <div class="form-group"><label>Surname</label><input type="text" class="form-control" id="profileSurname"></div>
                    <div class="form-group"><label>Mobile</label><input type="tel" class="form-control" id="profileMobile"></div>
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Gender</label>
                        <select class="form-control" id="profileGender">
                            <option value="">-- Select --</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                </div>
                
                <h4>ğŸ‘¥ Gender Preferences</h4>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">Set your preferences for who you're comfortable interacting with. These help filter matches but don't guarantee outcomes.</p>
                <div class="grid-3">
                    <div class="form-group">
                        <label>ğŸº Meetups/Catchups</label>
                        <select class="form-control" id="prefMeetupGender">
                            <option value="any">Any gender</option>
                            <option value="same">Same gender only</option>
                            <option value="male">Male only</option>
                            <option value="female">Female only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ†˜ SOS/Emergency Help</label>
                        <select class="form-control" id="prefSOSGender">
                            <option value="any">Any gender</option>
                            <option value="same">Same gender preferred</option>
                            <option value="male">Male only</option>
                            <option value="female">Female only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸš— Hitchhiking/Rides</label>
                        <select class="form-control" id="prefHitchGender">
                            <option value="any">Any gender</option>
                            <option value="same">Same gender only</option>
                            <option value="male">Male only</option>
                            <option value="female">Female only</option>
                        </select>
                    </div>
                </div>
                
                <h4>ğŸ  Home Address</h4>
                <div class="grid-2">
                    <div class="form-group"><label>Suburb</label><input type="text" class="form-control" id="profileSuburb"></div>
                    <div class="form-group"><label>City</label><input type="text" class="form-control" id="profileCity"></div>
                </div>
                <div class="grid-3">
                    <div class="form-group"><label>Country</label><input type="text" class="form-control" id="profileCountry"></div>
                    <div class="form-group"><label>Post Code</label><input type="text" class="form-control" id="profilePostCode"></div>
                </div>
                
                <h4>ğŸ“ Home Location (GPS)</h4>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">Get GPS coordinates from your address above, your device, or enter manually.</p>
                <div class="location-btn-group">
                    <button class="location-btn primary" onclick="geocodeHomeAddress()">ğŸ  From Address</button>
                    <button class="location-btn" onclick="captureHomeGPS()">ğŸ“ Device GPS</button>
                    <button class="location-btn" onclick="toggleManualEntry('home')">âœï¸ Manual</button>
                </div>
                <div id="homeManualEntry" class="hidden" style="margin-bottom: 16px;">
                    <div class="grid-2"><input type="text" class="form-control" id="profileHomeLat" placeholder="Latitude (e.g. -36.8485)" onchange="updateGPSDisplay('home')"><input type="text" class="form-control" id="profileHomeLng" placeholder="Longitude (e.g. 174.7633)" onchange="updateGPSDisplay('home')"></div>
                </div>
                <div class="grid-2">
                    <div id="homeGPSDisplay" class="gps-display-box hidden">
                        <div class="gps-format-tabs">
                            <button class="gps-format-tab active" onclick="setGPSFormat('home','dd')">DD</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('home','dms')">DMS</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('home','ddm')">DDM</button>
                        </div>
                        <div id="homeGPSValues"></div>
                        <div id="homeW3W" class="w3w-row" style="margin-top: 12px;"><div class="w3w-logo">///</div><span class="value" id="homeW3WValue">loading...</span><button class="copy-btn" onclick="copyValue('homeW3WValue',this)">Copy</button></div>
                    </div>
                    <div class="map-container"><div id="homeMap"></div></div>
                </div>
                
                <h4>ğŸ‘¤ How I Use Obonato</h4>
                <div class="radio-group" style="margin-bottom: 20px;">
                    <div class="radio-item" onclick="setUserType('local')">
                        <input type="radio" name="userType" value="local" id="userTypeLocal">
                        <label for="userTypeLocal">ğŸ  Local Helper - I help travelers in my area</label>
                    </div>
                    <div class="radio-item" onclick="setUserType('traveler')">
                        <input type="radio" name="userType" value="traveler" id="userTypeTraveler">
                        <label for="userTypeTraveler">ğŸŒ Traveler - I travel and may need/offer help</label>
                    </div>
                    <div class="radio-item" onclick="setUserType('both')">
                        <input type="radio" name="userType" value="both" id="userTypeBoth">
                        <label for="userTypeBoth">ğŸ”„ Both - I'm a local AND a traveler</label>
                    </div>
                </div>
                
                <div id="localHelperDates" class="hidden" style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 12px; color: var(--primary);">ğŸ“… When are you available to help?</h5>
                    <p style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">Leave blank if always available</p>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Available From (optional)</label>
                            <input type="date" class="form-control" id="availableFrom">
                        </div>
                        <div class="form-group">
                            <label>Available Until (optional)</label>
                            <input type="date" class="form-control" id="availableUntil">
                        </div>
                    </div>
                </div>
                
                <div id="travelerSection" class="hidden">
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h5 style="margin: 0 0 12px; color: var(--primary);">ğŸ“… Travel Dates</h5>
                        <p style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">When are you traveling? (From date optional)</p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Traveling From (optional)</label>
                                <input type="date" class="form-control" id="travelingFrom" placeholder="Leave blank if already traveling">
                            </div>
                            <div class="form-group">
                                <label>Traveling Until</label>
                                <input type="date" class="form-control" id="travelingUntil">
                            </div>
                        </div>
                        <div class="checkbox-item" style="margin-top: 8px;">
                            <input type="checkbox" id="travelingOpenEnded" onchange="toggleOpenEndedTravel()">
                            <label for="travelingOpenEnded">Open-ended travel (no fixed return)</label>
                        </div>
                    </div>
                    
                    <h5 style="margin: 0 0 12px; color: var(--primary);">ğŸš— Traveler Type</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="typeMoto"><label for="typeMoto">ğŸï¸ Motorcyclist</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeCyclist"><label for="typeCyclist">ğŸš´ Cyclist</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="type4wd"><label for="type4wd">ğŸš™ 4WD</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeYacht"><label for="typeYacht">â›µ Sailor</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeHiker"><label for="typeHiker">ğŸ¥¾ Hiker</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeTrucker"><label for="typeTrucker">ğŸš› Trucker</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeRV"><label for="typeRV">ğŸš RV</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeHitchhiker"><label for="typeHitchhiker">ğŸ‘ Hitchhiker</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="typeBackpacker"><label for="typeBackpacker">ğŸ’ Backpacker</label></div>
                    </div>
                </div>
                
                <h4>ğŸš™ My Vehicles</h4>
                <div id="vehiclesList"></div>
                <div class="add-vehicle-card" onclick="openVehicleModal()"><span style="font-size: 32px;">â•</span><p style="color: var(--text-light); margin-top: 8px;">Add Vehicle</p></div>
                
                <h4>ğŸš¨ Emergency Contacts</h4>
                <p style="color: var(--text-light); margin-bottom: 16px;">Add people who should be notified if you trigger an SOS. You can have contacts at home and locally.</p>
                
                <div id="emergencyContactsList"></div>
                
                <button class="btn btn-secondary" onclick="addEmergencyContact()" style="margin-top: 12px;">â• Add Emergency Contact</button>
                
                <div class="form-group" style="margin-top: 16px; padding: 16px; background: var(--bg); border-radius: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="autoNotifyEmergency" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: 600;">ğŸ“² Auto-notify when I send an SOS</span>
                    </label>
                    <p style="margin: 8px 0 0 32px; font-size: 13px; color: var(--text-light);">
                        When enabled, all your emergency contacts will automatically receive an email with your location when you trigger an Emergency SOS or Request Assistance.
                    </p>
                </div>
                
                <h4>ğŸ©º Medical Information (ICE)</h4>
                <p style="color: var(--text-light); margin-bottom: 16px;">In Case of Emergency - this information can be shared with helpers responding to medical/emergency SOS alerts.</p>
                
                <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="shareICEInEmergency" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #dc2626;">ğŸ†˜ Share medical info in emergencies</span>
                        </label>
                        <p style="margin: 8px 0 0 32px; font-size: 13px; color: var(--text-light);">
                            When enabled, helpers responding to your Emergency SOS will see your medical information.
                        </p>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>ğŸ©¸ Blood Type</label>
                        <select class="form-control" id="iceBloodType">
                            <option value="">-- Unknown --</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ ICE Contact Name</label>
                        <input type="text" class="form-control" id="iceContactName" placeholder="e.g. Partner, Parent">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ’Š Allergies</label>
                    <div id="iceAllergiesList" style="margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-control" id="iceNewAllergy" placeholder="e.g. Penicillin, Bee stings, Peanuts" style="flex: 1;">
                        <select class="form-control" id="iceNewAllergySeverity" style="width: 120px;">
                            <option value="mild">Mild</option>
                            <option value="moderate">Moderate</option>
                            <option value="severe">Severe âš ï¸</option>
                        </select>
                        <button class="btn btn-secondary" onclick="addICEAllergy()">+ Add</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ’‰ Current Medications</label>
                    <div id="iceMedicationsList" style="margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-control" id="iceNewMedication" placeholder="e.g. Insulin, Blood thinners" style="flex: 1;">
                        <input type="text" class="form-control" id="iceNewMedicationDosage" placeholder="Dosage" style="width: 120px;">
                        <button class="btn btn-secondary" onclick="addICEMedication()">+ Add</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ¥ Medical Conditions</label>
                    <div id="iceConditionsList" style="margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-control" id="iceNewCondition" placeholder="e.g. Diabetic, Epileptic, Asthmatic" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addICECondition()">+ Add</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ Emergency Notes</label>
                    <textarea class="form-control" id="iceEmergencyNotes" rows="2" placeholder="e.g. Carries EpiPen in left pannier, Pacemaker fitted, DNR order"></textarea>
                </div>
                
                <h4>âš™ï¸ Preferences</h4>
                <div class="grid-2">
                    <div class="form-group"><label>Distance</label><div class="radio-group"><div class="radio-item selected" onclick="selectRadio('unitDistance','km')"><input type="radio" name="unitDistance" value="km" checked><label>km</label></div><div class="radio-item" onclick="selectRadio('unitDistance','miles')"><input type="radio" name="unitDistance" value="miles"><label>miles</label></div></div></div>
                    <div class="form-group"><label>Temperature</label><div class="radio-group"><div class="radio-item selected" onclick="selectRadio('unitTemp','celsius')"><input type="radio" name="unitTemp" value="celsius" checked><label>Â°C</label></div><div class="radio-item" onclick="selectRadio('unitTemp','fahrenheit')"><input type="radio" name="unitTemp" value="fahrenheit"><label>Â°F</label></div></div></div>
                </div>
                
                <button class="btn btn-primary" onclick="handleSaveProfile()" style="margin-top: 24px;">ğŸ’¾ Save Profile</button>
                <div id="profileResult" style="margin-top: 16px;"></div>
                
                <!-- Community Guidelines -->
                <div style="margin-top: 32px; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 16px; border: 1px solid #86efac;">
                    <h4 style="margin: 0 0 16px; color: #166534; display: flex; align-items: center; gap: 8px;">
                        ğŸ¤ Community Guidelines
                    </h4>
                    
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 20px;">ğŸ’š</span>
                            <div>
                                <strong style="color: #166534;">Ubuntu: I exist because you exist</strong>
                                <p style="margin: 4px 0 0; font-size: 13px; color: #15803d;">This is a mutual aid community. We help each other because we're all travelers on the same journey.</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 20px;">ğŸš«ğŸ’°</span>
                            <div>
                                <strong style="color: #166534;">No payment expected or required</strong>
                                <p style="margin: 4px 0 0; font-size: 13px; color: #15803d;">Help is freely given. If you want to say thanks, pay it forward by helping someone else.</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 20px;">â­</span>
                            <div>
                                <strong style="color: #166534;">Feedback builds trust</strong>
                                <p style="margin: 4px 0 0; font-size: 13px; color: #15803d;">Always leave honest feedback after interactions. It helps keep our community safe.</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 20px;">ğŸš¨</span>
                            <div>
                                <strong style="color: #166534;">Report concerning behavior</strong>
                                <p style="margin: 4px 0 0; font-size: 13px; color: #15803d;">If anyone asks for payment, acts inappropriately, or makes you uncomfortable, report them immediately.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Safety Tips -->
                <div style="margin-top: 16px; padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; border: 1px solid #fcd34d;">
                    <h4 style="margin: 0 0 16px; color: #92400e; display: flex; align-items: center; gap: 8px;">
                        ğŸ›¡ï¸ Safety Tips for Meeting
                    </h4>
                    
                    <div style="display: grid; gap: 10px; font-size: 13px; color: #78350f;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span>ğŸ“</span>
                            <span><strong>Meet in public first</strong> - Cafe, petrol station, or busy area</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span>ğŸ“±</span>
                            <span><strong>Tell someone</strong> - Share your location with a friend or emergency contact</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span>âœ…</span>
                            <span><strong>Check verification</strong> - Prefer community-verified members when possible</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span>ğŸš—</span>
                            <span><strong>Have an exit</strong> - Keep your vehicle accessible, know how to leave</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span>ğŸ¯</span>
                            <span><strong>Trust your instincts</strong> - If something feels wrong, it probably is</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Availability Tab -->
        <div id="availability" class="tab-content">
            <div class="card">
                <h3>ğŸ“ Your Availability</h3>
                <div class="checkbox-item" style="background: var(--success-light); border-color: var(--success); margin-bottom: 24px;"><input type="checkbox" id="availActive" checked><label for="availActive" style="font-weight: 700; color: #065f46;">I am available to help others</label></div>
                
                <div class="form-group">
                    <label>ğŸ“¢ Your Status (shown to others)</label>
                    <select class="form-control" id="availStatusMessage">
                        <option value="Available">âœ… Available</option>
                        <option value="Happy to help">ğŸ˜Š Happy to help</option>
                        <option value="Free for a catch up">ğŸº Free for a catch up</option>
                        <option value="Traveling through">ğŸš— Traveling through</option>
                        <option value="Local expert">ğŸ—ºï¸ Local expert</option>
                        <option value="Can assist with repairs">ğŸ”§ Can assist with repairs</option>
                        <option value="Looking for company">ğŸ‘‹ Looking for company</option>
                        <option value="Busy but reachable">ğŸ“± Busy but reachable</option>
                    </select>
                </div>
                
                <h4>ğŸ“ Current Location</h4>
                <div class="location-btn-group">
                    <button class="location-btn primary" onclick="getLocation('avail','gps')">ğŸ“ Device GPS</button>
                    <button class="location-btn" onclick="getLocation('avail','home')">ğŸ  Use Home</button>
                    <button class="location-btn" onclick="toggleManualEntry('avail')">âœï¸ Manual</button>
                </div>
                <div id="availManualEntry" class="hidden" style="margin-bottom: 16px;">
                    <div class="grid-2"><input type="text" class="form-control" id="availLat" placeholder="Latitude" onchange="updateGPSDisplay('avail')"><input type="text" class="form-control" id="availLng" placeholder="Longitude" onchange="updateGPSDisplay('avail')"></div>
                </div>
                <div class="form-group"><label>Location Name</label><input type="text" class="form-control" id="availLocation" placeholder="Auckland CBD"></div>
                <div class="grid-2">
                    <div id="availGPSDisplay" class="gps-display-box hidden">
                        <div class="gps-format-tabs">
                            <button class="gps-format-tab active" onclick="setGPSFormat('avail','dd')">DD</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('avail','dms')">DMS</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('avail','ddm')">DDM</button>
                        </div>
                        <div id="availGPSValues"></div>
                        <div id="availW3W" class="w3w-row" style="margin-top: 12px;"><div class="w3w-logo">///</div><span class="value" id="availW3WValue">loading...</span><button class="copy-btn" onclick="copyValue('availW3WValue',this)">Copy</button></div>
                    </div>
                    <div class="map-container"><div id="availMap"></div></div>
                </div>
                
                <h4>ğŸ¤ Services You Offer</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="canPickup"><label for="canPickup">ğŸš— Pickup/Trailer</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canGarage"><label for="canGarage">ğŸ”§ Workshop</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canStay"><label for="canStay">ğŸ  Accommodation</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canMeet"><label for="canMeet">ğŸº Meetup</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canAdvice"><label for="canAdvice">ğŸ’¡ Advice</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canHelp"><label for="canHelp">ğŸ†˜ Help</label></div>
                </div>
                
                <div class="form-group" style="margin-top: 24px; max-width: 200px;"><label>Max Radius (km)</label><input type="number" class="form-control" id="availRadius" value="50"></div>
                <button class="btn btn-primary" onclick="handleSaveAvailability()">ğŸ’¾ Save</button>
                <div id="availResult" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <!-- Travel/Hitchhiking Tab -->
        <div id="travel" class="tab-content">
            <div class="card">
                <h3>ğŸš— Travel Plans & Ride Sharing</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 20px;">Share your travel plans to find companions or offer/request rides. Connect with others traveling the same route!</p>
                
                <div class="radio-group" style="margin-bottom: 24px;">
                    <div class="radio-item selected" onclick="setTravelMode('offering')">
                        <input type="radio" name="travelMode" value="offering" id="modeOffering" checked>
                        <label for="modeOffering">ğŸš— I can offer a ride</label>
                    </div>
                    <div class="radio-item" onclick="setTravelMode('seeking')">
                        <input type="radio" name="travelMode" value="seeking" id="modeSeeking">
                        <label for="modeSeeking">ğŸ‘ I'm looking for a ride</label>
                    </div>
                    <div class="radio-item" onclick="setTravelMode('companion')">
                        <input type="radio" name="travelMode" value="companion" id="modeCompanion">
                        <label for="modeCompanion">ğŸ¤ Looking for travel companion</label>
                    </div>
                </div>
                
                <h4>ğŸ“ Route</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label>ğŸ…°ï¸ From (Origin)</label>
                        <input type="text" class="form-control" id="travelFrom" placeholder="City, Town or Location name">
                        <div class="location-btn-group" style="margin-top: 8px;">
                            <button class="location-btn btn-sm" onclick="getTravelLocation('from','gps')">ğŸ“ GPS</button>
                            <button class="location-btn btn-sm" onclick="getTravelLocation('from','home')">ğŸ  Home</button>
                        </div>
                        <div class="grid-2" style="margin-top: 8px;">
                            <input type="text" class="form-control" id="travelFromLat" placeholder="Latitude" style="font-size: 12px;">
                            <input type="text" class="form-control" id="travelFromLng" placeholder="Longitude" style="font-size: 12px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ğŸ…±ï¸ To (Destination)</label>
                        <input type="text" class="form-control" id="travelTo" placeholder="City, Town or Location name">
                        <div class="location-btn-group" style="margin-top: 8px;">
                            <button class="location-btn btn-sm" onclick="getTravelLocation('to','gps')">ğŸ“ GPS</button>
                            <button class="location-btn btn-sm" onclick="geocodeTravelLocation('to')">ğŸ” Lookup</button>
                        </div>
                        <div class="grid-2" style="margin-top: 8px;">
                            <input type="text" class="form-control" id="travelToLat" placeholder="Latitude" style="font-size: 12px;">
                            <input type="text" class="form-control" id="travelToLng" placeholder="Longitude" style="font-size: 12px;">
                        </div>
                    </div>
                </div>
                
                <h4>ğŸ“… When</h4>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" id="travelDate">
                    </div>
                    <div class="form-group">
                        <label>Time (approx)</label>
                        <input type="time" class="form-control" id="travelTime">
                    </div>
                    <div class="form-group">
                        <label>Flexibility (Â± hours)</label>
                        <select class="form-control" id="travelFlex">
                            <option value="0">Exact time</option>
                            <option value="1">Â± 1 hour</option>
                            <option value="2" selected>Â± 2 hours</option>
                            <option value="4">Â± 4 hours</option>
                            <option value="8">Â± 8 hours (half day)</option>
                            <option value="24">Â± 1 day</option>
                            <option value="48">Â± 2 days</option>
                            <option value="168">Â± 1 week</option>
                        </select>
                    </div>
                </div>
                
                <div id="travelOfferingDetails">
                    <h4>ğŸš— Ride Details (for drivers)</h4>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Available Seats</label>
                            <select class="form-control" id="travelSeats">
                                <option value="1">1 passenger</option>
                                <option value="2">2 passengers</option>
                                <option value="3">3 passengers</option>
                                <option value="4">4+ passengers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Luggage Space</label>
                            <select class="form-control" id="travelLuggage">
                                <option value="small">Small (backpack)</option>
                                <option value="medium">Medium (suitcase)</option>
                                <option value="large">Large (multiple bags)</option>
                                <option value="bike">Can carry bicycle</option>
                                <option value="none">No luggage space</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cost Sharing</label>
                            <select class="form-control" id="travelCost">
                                <option value="free">Free ride</option>
                                <option value="share">Share fuel costs</option>
                                <option value="negotiable">Negotiable</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea class="form-control" id="travelNotes" rows="3" placeholder="Any additional info: stops along the way, pet-friendly, smoking/non-smoking, music preferences, etc."></textarea>
                </div>
                
                <div class="checkbox-group" style="margin-bottom: 24px;">
                    <div class="checkbox-item"><input type="checkbox" id="travelRecurring"><label for="travelRecurring">ğŸ”„ This is a recurring trip</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="travelWaypoints"><label for="travelWaypoints">ğŸ“ Open to detours/waypoints</label></div>
                </div>
                
                <button class="btn btn-primary" onclick="handleSaveTravel()">ğŸ“ Post Travel Plan</button>
                <div id="travelResult" style="margin-top: 16px;"></div>
            </div>
            
            <div class="card" style="margin-top: 24px;">
                <h3>ğŸ” Find Matching Travelers</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">Search for others with similar travel plans or routes.</p>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Search Near</label>
                        <input type="text" class="form-control" id="searchTravelLocation" placeholder="City or location">
                    </div>
                    <div class="form-group">
                        <label>Date Range</label>
                        <div class="grid-2">
                            <input type="date" class="form-control" id="searchTravelFrom">
                            <input type="date" class="form-control" id="searchTravelTo">
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group" style="margin-bottom: 16px;">
                    <div class="checkbox-item"><input type="checkbox" id="searchOffering" checked><label>ğŸš— Offering rides</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="searchSeeking" checked><label>ğŸ‘ Seeking rides</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="searchCompanions" checked><label>ğŸ¤ Companions</label></div>
                </div>
                
                <button class="btn btn-primary" onclick="handleSearchTravel()">ğŸ” Search</button>
                
                <div id="travelSearchResults" style="margin-top: 24px;">
                    <p class="loading">Enter search criteria to find travelers...</p>
                </div>
            </div>
            
            <div class="card" style="margin-top: 24px;">
                <h3>ğŸ“‹ Your Active Travel Plans</h3>
                <div id="myTravelPlans"><p class="loading">Loading your travel plans...</p></div>
            </div>
        </div>
        
        <!-- Find Helpers Tab -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>ğŸ—ºï¸ Find Nearby Helpers</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">Set your search location using GPS, your home address, or enter coordinates manually.</p>
                <div class="location-btn-group">
                    <button class="location-btn primary" onclick="getLocation('search','gps')">ğŸ“ Device GPS</button>
                    <button class="location-btn" onclick="getLocation('search','home')">ğŸ  Use Home</button>
                    <button class="location-btn" onclick="toggleManualEntry('search')">âœï¸ Manual</button>
                </div>
                <div id="searchManualEntry" class="hidden" style="margin-bottom: 16px;">
                    <div class="grid-2"><input type="text" class="form-control" id="searchLat" placeholder="Latitude" onchange="updateGPSDisplay('search')"><input type="text" class="form-control" id="searchLng" placeholder="Longitude" onchange="updateGPSDisplay('search')"></div>
                </div>
                <div class="grid-2" style="margin-bottom: 24px;">
                    <div id="searchGPSDisplay" class="gps-display-box hidden">
                        <div class="gps-format-tabs">
                            <button class="gps-format-tab active" onclick="setGPSFormat('search','dd')">DD</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('search','dms')">DMS</button>
                            <button class="gps-format-tab" onclick="setGPSFormat('search','ddm')">DDM</button>
                        </div>
                        <div id="searchGPSValues"></div>
                        <div id="searchW3W" class="w3w-row" style="margin-top: 12px;"><div class="w3w-logo">///</div><span class="value" id="searchW3WValue">loading...</span><button class="copy-btn" onclick="copyValue('searchW3WValue',this)">Copy</button></div>
                    </div>
                    <div class="form-group"><label>Search Radius (km)</label><input type="number" class="form-control" id="searchRadius" value="50"></div>
                </div>
                <div class="checkbox-group" style="margin-bottom: 24px;">
                    <div class="checkbox-item"><input type="checkbox" id="needPickup"><label>ğŸš— Pickup/Trailer</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needGarage"><label>ğŸ”§ Workshop</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needStay"><label>ğŸ  Accommodation</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needMeet"><label>ğŸº Meetup</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needAdvice"><label>ğŸ’¡ Advice</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needHelp"><label>ğŸ†˜ Help</label></div>
                </div>
                <button class="btn btn-primary" onclick="handleSearchHelpers()">ğŸ” Search Helpers</button>
            </div>
            <div class="map-container large"><div id="helpersMap"></div></div>
            <div id="helperResults" style="margin-top: 24px;"><p class="loading">Enter location to find helpers...</p></div>
        </div>
        
        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div class="card">
                <h3>ğŸ“‹ Your Activity</h3>
                <div id="pendingFeedbackAlert" class="alert alert-warning hidden">âš ï¸ Feedback Required</div>
                <h4>â³ Pending Feedback</h4><div id="pendingInteractions"><p class="loading">Loading...</p></div>
                <h4>ğŸ“œ Recent Activity</h4><div id="recentActivity"><p class="loading">Loading...</p></div>
            </div>
        </div>
        
        <!-- Places Tab -->
        <div id="places" class="tab-content">
            <div class="card">
                <h3>ğŸª Find & Review Places</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Find mechanics, cafes, campgrounds, and other traveler-friendly businesses recommended by the community.</p>
                
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Search</label>
                        <input type="text" class="form-control" id="placeSearch" placeholder="Business name or type...">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-control" id="placeCategory">
                            <option value="">All Categories</option>
                            <option value="mechanic">ğŸ”§ Mechanic / Workshop</option>
                            <option value="fuel">â›½ Fuel Station</option>
                            <option value="tyres">ğŸ› Tyre Shop</option>
                            <option value="accommodation">ğŸ¨ Accommodation</option>
                            <option value="camping">ğŸ•ï¸ Campground</option>
                            <option value="cafe">â˜• Cafe / Restaurant</option>
                            <option value="parts">ğŸ”© Parts / Accessories</option>
                            <option value="other">ğŸ“ Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="location-btn-group" style="margin-bottom: 20px;">
                    <button class="location-btn primary" onclick="searchPlacesNearMe()">ğŸ“ Near Me</button>
                    <button class="location-btn" onclick="searchAllPlaces()">ğŸŒ All Places</button>
                    <button class="btn btn-accent" onclick="openAddPlaceModal()">â• Add Place</button>
                </div>
                
                <div id="placesResults">
                    <p style="color: var(--text-light); text-align: center;">Search for places or click "Near Me" to find recommendations.</p>
                </div>
            </div>
            
            <!-- My Reviews -->
            <div class="card">
                <h3>â­ My Reviews</h3>
                <div id="myPlaceReviews">
                    <p style="color: var(--text-light);">You haven't reviewed any places yet.</p>
                </div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="alert alert-warning">âš ï¸ <strong>Life-threatening emergency?</strong> Call 111 (NZ) / 000 (AU) / 911 (US) first!</div>
            
            <!-- Incoming Help Section (for requesters) -->
            <div id="incomingHelpSection" class="card hidden" style="margin-bottom: 24px; border-left: 4px solid var(--success);">
                <h3>ğŸš— Help Is Coming!</h3>
                <div id="incomingHelpList"></div>
            </div>
            
            <!-- Active SOS Requests -->
            <div id="activeSOSSection" class="card hidden" style="margin-bottom: 24px; border-left: 4px solid var(--danger);">
                <h3>ğŸš¨ Your Active Requests</h3>
                <div id="activeSOSList"></div>
            </div>
            
            <!-- EMERGENCY SOS -->
            <div class="card" style="border: 2px solid var(--danger); background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                <h3 style="color: var(--danger);">ğŸ†˜ Emergency SOS</h3>
                <p style="color: var(--text-light); margin-bottom: 16px;">For urgent situations where you need immediate help from nearby Obonato members.</p>
                <div class="sos-container">
                    <button class="sos-button" id="sosButton" onmousedown="startSOS()" onmouseup="cancelSOS()" onmouseleave="cancelSOS()" ontouchstart="startSOS()" ontouchend="cancelSOS()">ğŸš¨ SOS<span>Hold 3 seconds</span></button>
                    <div class="sos-progress"><div class="sos-progress-bar" id="sosProgress"></div></div>
                    <p id="sosStatus" style="font-size: 16px; font-weight: 600;"></p>
                </div>
                <div class="alert alert-info" style="margin-top: 16px;">
                    <strong>What happens:</strong> Your location is broadcast to all nearby helpers. They'll see your emergency and can respond with their ETA. You'll see their photo so you can recognize them when they arrive.
                </div>
            </div>
            
            <!-- HELP REQUEST (Non-Emergency) -->
            <div class="card">
                <h3>ğŸ“ Request Assistance</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">For non-urgent help like breakdowns, needing fuel, finding a mechanic, or just wanting to meet up.</p>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>What do you need?</label>
                        <select class="form-control" id="sosType">
                            <option value="breakdown">ğŸ”§ Breakdown - mechanical issue</option>
                            <option value="fuel">â›½ Fuel - ran out or need to find</option>
                            <option value="stuck">ğŸš™ Stuck - bogged, flat tyre, etc</option>
                            <option value="accident">ğŸ’¥ Accident - minor, non-life-threatening</option>
                            <option value="medical">ğŸ¥ Medical - non-emergency health issue</option>
                            <option value="unsafe">âš ï¸ Unsafe - feeling uncomfortable</option>
                            <option value="directions">ğŸ—ºï¸ Directions - lost or need guidance</option>
                            <option value="meetup">ğŸº Meetup - looking for company</option>
                            <option value="other">â“ Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>How urgent?</label>
                        <select class="form-control" id="sosSeverity">
                            <option value="low">ğŸŸ¢ Low - can wait a few hours</option>
                            <option value="medium">ğŸŸ¡ Medium - within an hour ideally</option>
                            <option value="high">ğŸŸ  High - need help soon</option>
                            <option value="critical">ğŸ”´ Critical - urgent assistance needed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Vehicle (optional)</label>
                    <select class="form-control" id="sosVehicle"><option value="">-- Not vehicle related --</option></select>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="sosDescription" rows="3" placeholder="What's happened? What help do you need?"></textarea>
                </div>
                
                <h4>ğŸ“ Your Location</h4>
                <div class="location-btn-group">
                    <button class="location-btn primary" onclick="getLocation('sos','gps')">ğŸ“ Current GPS</button>
                    <button class="location-btn" onclick="getLocation('sos','home')">ğŸ  Use Home</button>
                </div>
                <div class="grid-2" style="margin-bottom: 16px;">
                    <input type="text" class="form-control" id="sosLat" placeholder="Latitude" onchange="updateGPSDisplay('sos')">
                    <input type="text" class="form-control" id="sosLng" placeholder="Longitude" onchange="updateGPSDisplay('sos')">
                </div>
                <div id="sosGPSDisplay" class="gps-display-box hidden">
                    <div class="gps-format-tabs">
                        <button class="gps-format-tab active" onclick="setGPSFormat('sos','dd')">DD</button>
                        <button class="gps-format-tab" onclick="setGPSFormat('sos','dms')">DMS</button>
                        <button class="gps-format-tab" onclick="setGPSFormat('sos','ddm')">DDM</button>
                    </div>
                    <div id="sosGPSValues"></div>
                    <div id="sosW3W" class="w3w-row" style="margin-top: 12px;"><div class="w3w-logo">///</div><span class="value" id="sosW3WValue">loading...</span><button class="copy-btn" onclick="copyValue('sosW3WValue',this)">Copy</button></div>
                </div>
                
                <button class="btn btn-danger" onclick="handleCreateSOS()" style="margin-top: 16px; width: 100%;">ğŸ“¤ Send Help Request</button>
                <div id="sosResult" style="margin-top: 16px;"></div>
                
                <div class="alert alert-info" style="margin-top: 16px;">
                    <strong>What happens:</strong> Nearby helpers matching your needs will be notified. When someone responds, you'll see their photo and ETA. After they help you, both parties leave feedback.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vehicle Modal -->
    <div class="modal-overlay" id="vehicleModal">
        <div class="modal">
            <div class="modal-header"><h2 id="vehicleModalTitle">Add Vehicle</h2><button class="modal-close" onclick="closeVehicleModal()">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="vehicleEditId">
                <div class="form-group"><label>Type</label><select class="form-control" id="vehicleType"><option value="motorcycle">ğŸï¸ Motorcycle</option><option value="car">ğŸš— Car</option><option value="4wd">ğŸš™ 4WD</option><option value="truck">ğŸš› Truck</option><option value="rv">ğŸš RV</option><option value="bicycle">ğŸš´ Bicycle</option><option value="boat">â›µ Boat</option></select></div>
                <div class="grid-2"><div class="form-group"><label>Make</label><input type="text" class="form-control" id="vehicleMake"></div><div class="form-group"><label>Model</label><input type="text" class="form-control" id="vehicleModel"></div></div>
                <div class="grid-2"><div class="form-group"><label>Year</label><input type="number" class="form-control" id="vehicleYear"></div><div class="form-group"><label>Fuel</label><select class="form-control" id="vehicleFuel"><option value="">--</option><option value="91">91</option><option value="95">95</option><option value="98">98</option><option value="diesel">Diesel</option><option value="lpg">LPG</option><option value="electric">Electric</option></select></div></div>
                <div class="grid-2"><div class="form-group"><label>Colour</label><input type="text" class="form-control" id="vehicleColour"></div><div class="form-group"><label>Rego</label><input type="text" class="form-control" id="vehicleRego"></div></div>
                <div class="form-group"><label>Notes</label><textarea class="form-control" id="vehicleNotes" rows="2"></textarea></div>
                <div class="checkbox-item"><input type="checkbox" id="vehicleActive" checked><label for="vehicleActive">Active</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeVehicleModal()">Cancel</button><button class="btn btn-danger hidden" id="vehicleDeleteBtn" onclick="deleteVehicle()">ğŸ—‘ï¸</button><button class="btn btn-primary" onclick="saveVehicle()">ğŸ’¾ Save</button></div>
        </div>
    </div>
    
    <!-- Emergency Contact Modal -->
    <div class="modal-overlay" id="emergencyContactModal">
        <div class="modal">
            <div class="modal-header"><h2 id="ecModalTitle">Add Emergency Contact</h2><button class="modal-close" onclick="closeEmergencyContactModal()">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="ecEditId">
                <div class="form-group">
                    <label>Contact Type</label>
                    <select class="form-control" id="ecType">
                        <option value="home">ğŸ  Home Contact - Family/friend at home</option>
                        <option value="local">ğŸ“ Local Contact - Someone where you're traveling</option>
                        <option value="travel_buddy">ğŸ§­ Travel Buddy - Someone traveling with you</option>
                        <option value="other">ğŸ‘¤ Other</option>
                    </select>
                </div>
                <div class="form-group"><label>Name *</label><input type="text" class="form-control" id="ecName" placeholder="e.g. Mum, John Smith"></div>
                <div class="form-group"><label>Relationship</label><input type="text" class="form-control" id="ecRelationship" placeholder="e.g. Mother, Friend, Partner"></div>
                <div class="grid-2">
                    <div class="form-group"><label>Phone</label><input type="tel" class="form-control" id="ecPhone" placeholder="+64 21 xxx xxxx"></div>
                    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="ecEmail" placeholder="email@example.com"></div>
                </div>
                <p style="font-size:12px;color:var(--text-light);margin-top:8px;">* At least phone or email is required</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmergencyContactModal()">Cancel</button>
                <button class="btn btn-danger hidden" id="ecDeleteBtn" onclick="deleteEmergencyContact(document.getElementById('ecEditId').value);closeEmergencyContactModal();">ğŸ—‘ï¸ Delete</button>
                <button class="btn btn-primary" onclick="saveEmergencyContact()">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
    
    <!-- Chat Modal -->
    <div class="modal-overlay" id="chatModal">
        <div class="modal" style="max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2>ğŸ’¬ <span id="chatUserName">Chat</span></h2>
                <button class="modal-close" onclick="closeChatModal()">Ã—</button>
            </div>
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-alt);">
                <!-- Messages will load here -->
            </div>
            <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-shrink: 0;">
                <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." style="flex: 1;">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal">
            <div class="modal-header"><h2>â­ Rate Interaction</h2><button class="modal-close" onclick="closeFeedbackModal()">Ã—</button></div>
            <div class="modal-body">
                <div id="feedbackPhotoSection" style="text-align: center; margin-bottom: 20px; padding: 20px; background: var(--bg); border-radius: 12px;">
                    <p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">Verify this is who you met:</p>
                    <div id="feedbackPhoto" style="width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 12px; border: 3px solid var(--primary); overflow: hidden; background: var(--bg-alt);">
                        <img id="feedbackPhotoImg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <div id="feedbackPhotoAvatar" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:32px;"></div>
                    </div>
                    <p id="feedbackUserName" style="font-weight: 700; font-size: 18px; margin: 0;">user</p>
                </div>
                <div class="rating-buttons">
                    <button class="rating-btn positive" onclick="selectRatingBtn('positive')"><span class="emoji">ğŸ˜Š</span><span class="label">Positive</span></button>
                    <button class="rating-btn neutral" onclick="selectRatingBtn('neutral')"><span class="emoji">ğŸ˜</span><span class="label">Neutral</span></button>
                    <button class="rating-btn negative" onclick="selectRatingBtn('negative')"><span class="emoji">ğŸ˜</span><span class="label">Negative</span></button>
                </div>
                <div class="form-group"><label>Comments</label><textarea class="form-control" id="feedbackComment" rows="3"></textarea></div>
                <div class="checkbox-item"><input type="checkbox" id="feedbackWouldAgain" checked><label for="feedbackWouldAgain">Would interact again</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button><button class="btn btn-primary" onclick="submitFeedback()">Submit</button></div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header"><h2>ğŸ“¨ Contact Helper</h2><button class="modal-close" onclick="closeContactModal()">Ã—</button></div>
            <div class="modal-body">
                <div id="contactHelperInfo"></div>
                <div class="form-group"><label>Type</label><select class="form-control" id="contactType"><option value="breakdown">ğŸ”§ Breakdown</option><option value="accommodation">ğŸ  Stay</option><option value="meetup">ğŸº Meetup</option><option value="advice">ğŸ’¡ Advice</option></select></div>
                <div class="form-group"><label>Message</label><textarea class="form-control" id="contactMessage" rows="4"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button><button class="btn btn-primary" onclick="sendContactRequest()">Send</button></div>
        </div>
    </div>
    
    <!-- Respond Modal -->
    <div class="modal-overlay" id="respondModal">
        <div class="modal">
            <div class="modal-header"><h2>ğŸ¤ Respond</h2><button class="modal-close" onclick="closeRespondModal()">Ã—</button></div>
            <div class="modal-body">
                <div id="respondRequestInfo"></div>
                <div id="respondPhotoReveal" class="hidden" style="text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, var(--success-light), #d1fae5); border-radius: 12px;">
                    <p style="color: var(--success); font-weight: 700; font-size: 18px; margin-bottom: 16px;">âœ… Help Confirmed!</p>
                    <div id="respondPhoto" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 12px; border: 4px solid var(--success); overflow: hidden; background: var(--bg-alt);">
                        <img id="respondPhotoImg" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <p id="respondPhotoName" style="font-weight: 700; font-size: 18px; margin: 0 0 4px;"></p>
                    <p style="color: var(--text-light); font-size: 13px; margin: 0 0 16px;">is waiting for you</p>
                    
                    <div id="respondLocationInfo" style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: left;">
                        <p style="font-weight: 600; margin: 0 0 8px;">ğŸ“ Their Location</p>
                        <p id="respondLocationCoords" style="font-size: 13px; color: var(--text-light); margin: 0 0 12px;"></p>
                        <a id="respondMapsLink" href="#" target="_blank" class="btn btn-primary" style="width: 100%; display: none;">ğŸ—ºï¸ Open in Maps</a>
                        <p id="respondNoLocation" style="color: var(--text-light); font-size: 13px; display: none;">Location not available - message them for details</p>
                    </div>
                    
                    <!-- ICE Medical Info (shown for emergencies) -->
                    <div id="respondICEInfo" class="hidden" style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: left;">
                        <p style="font-weight: 700; color: #dc2626; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                            ğŸ©º ICE - Medical Information
                        </p>
                        <div id="respondICEContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="openChatFromRespond()">ğŸ’¬ Message</button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="closeRespondModal()">Close</button>
                    </div>
                </div>
                <div id="respondFormSection">
                    <div class="form-group"><label>Response</label><textarea class="form-control" id="respondMessage" rows="4"></textarea></div>
                    <div class="form-group"><label>ETA</label><input type="text" class="form-control" id="respondETA" placeholder="30 minutes"></div>
                </div>
            </div>
            <div class="modal-footer" id="respondModalFooter">
                <button class="btn btn-secondary" onclick="closeRespondModal()">Close</button>
                <button class="btn btn-success" id="respondSubmitBtn" onclick="sendResponse()">âœ… I'll Help!</button>
            </div>
        </div>
    </div>
    
    <!-- Emergency SOS Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal" style="max-width: 450px; border: 3px solid var(--danger);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                <h2>ğŸ†˜ Emergency SOS</h2>
                <button class="modal-close" onclick="closeEmergencyModal()" style="color: white;">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="margin-bottom: 16px;">
                    <strong>âš ï¸ SOS is for life-threatening emergencies only.</strong><br>
                    For non-urgent help (flat tyre, out of fuel, etc.) use "Request Assistance" instead.
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 700;">What's happening? *</label>
                    <select class="form-control" id="emergencyType" style="font-size: 16px;">
                        <option value="">-- Select emergency type --</option>
                        <option value="ğŸš‘ Medical emergency">ğŸš‘ Medical emergency (injury, heart attack, etc.)</option>
                        <option value="ğŸ’¥ Crash/Accident">ğŸ’¥ Crash / Serious accident</option>
                        <option value="ğŸ”¥ Fire">ğŸ”¥ Fire</option>
                        <option value="âš ï¸ Unsafe/Threatened">âš ï¸ Feeling unsafe / Threatened</option>
                        <option value="ğŸŒŠ Man overboard">ğŸŒŠ Man overboard / Water emergency</option>
                        <option value="ğŸ Animal attack">ğŸ Animal attack (snake, dog, etc.)</option>
                        <option value="ğŸ”ï¸ Stranded/Trapped">ğŸ”ï¸ Stranded / Trapped</option>
                        <option value="â“ Other emergency">â“ Other life-threatening emergency</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Brief details (optional)</label>
                    <input type="text" class="form-control" id="emergencyDesc" placeholder="e.g. Snake bite on leg, need antivenin" maxlength="100" style="font-size: 16px;">
                </div>
                
                <div id="emergencyResult"></div>
                
                <p style="font-size: 12px; color: var(--text-light); margin-top: 16px; text-align: center;">
                    ğŸ“ Your current GPS location will be sent to nearby helpers.<br>
                    They will see your photo so they can find you.
                </p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 12px;">
                <button class="btn btn-danger" onclick="sendEmergencySOS()" style="width: 100%; padding: 16px; font-size: 18px; font-weight: 700;">
                    ğŸš¨ SEND EMERGENCY SOS
                </button>
                <button class="btn btn-secondary" onclick="closeEmergencyModal()" style="width: 100%;">Cancel - Not an emergency</button>
            </div>
        </div>
    </div>
    
    <!-- Add Place Modal -->
    <div class="modal-overlay" id="addPlaceModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header"><h2>â• Add a Place</h2><button class="modal-close" onclick="closeAddPlaceModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Business Name *</label>
                    <input type="text" class="form-control" id="placeName" placeholder="e.g. Bob's Motorcycle Workshop">
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select class="form-control" id="placeAddCategory">
                        <option value="">-- Select --</option>
                        <option value="mechanic">ğŸ”§ Mechanic / Workshop</option>
                        <option value="fuel">â›½ Fuel Station</option>
                        <option value="tyres">ğŸ› Tyre Shop</option>
                        <option value="accommodation">ğŸ¨ Accommodation</option>
                        <option value="camping">ğŸ•ï¸ Campground</option>
                        <option value="cafe">â˜• Cafe / Restaurant</option>
                        <option value="parts">ğŸ”© Parts / Accessories</option>
                        <option value="other">ğŸ“ Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" class="form-control" id="placeAddress" placeholder="123 Main Street">
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" class="form-control" id="placeCity">
                    </div>
                    <div class="form-group">
                        <label>Country *</label>
                        <input type="text" class="form-control" id="placeCountry" value="New Zealand">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="form-control" id="placePhone">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" class="form-control" id="placeWebsite" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Location (optional)</label>
                    <button class="btn btn-secondary btn-sm" onclick="getPlaceGPS()" style="margin-bottom: 8px;">ğŸ“ Use My Location</button>
                    <div class="grid-2">
                        <input type="text" class="form-control" id="placeLat" placeholder="Latitude">
                        <input type="text" class="form-control" id="placeLng" placeholder="Longitude">
                    </div>
                </div>
                <div id="addPlaceResult"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddPlaceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewPlace()">ğŸ’¾ Save Place</button>
            </div>
        </div>
    </div>
    
    <!-- Review Place Modal -->
    <div class="modal-overlay" id="reviewPlaceModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header"><h2>â­ Write Review</h2><button class="modal-close" onclick="closeReviewPlaceModal()">Ã—</button></div>
            <div class="modal-body">
                <div id="reviewPlaceInfo" style="background: var(--bg); padding: 16px; border-radius: 12px; margin-bottom: 20px;"></div>
                
                <p style="font-weight: 600; margin-bottom: 12px;">Your Rating</p>
                <div class="rating-buttons" id="placeRatingButtons">
                    <button class="rating-btn positive" onclick="selectPlaceRating('positive')"><span class="emoji">ğŸ‘</span><span class="label">Recommend</span></button>
                    <button class="rating-btn neutral" onclick="selectPlaceRating('neutral')"><span class="emoji">ğŸ˜</span><span class="label">Okay</span></button>
                    <button class="rating-btn negative" onclick="selectPlaceRating('negative')"><span class="emoji">ğŸ‘</span><span class="label">Avoid</span></button>
                </div>
                
                <div class="form-group">
                    <label>Services Used (select all that apply)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="tyres" class="serviceCheckbox"> Tyres</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="oil" class="serviceCheckbox"> Oil Change</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="brakes" class="serviceCheckbox"> Brakes</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="welding" class="serviceCheckbox"> Welding</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="electrical" class="serviceCheckbox"> Electrical</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="parts" class="serviceCheckbox"> Parts</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="fuel" class="serviceCheckbox"> Fuel</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="food" class="serviceCheckbox"> Food</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="accommodation" class="serviceCheckbox"> Stay</label>
                        <label class="checkbox-item" style="flex: 0 0 auto;"><input type="checkbox" value="camping" class="serviceCheckbox"> Camping</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>When did you visit?</label>
                    <input type="date" class="form-control" id="reviewVisitDate">
                </div>
                
                <div class="form-group">
                    <label>Your Review</label>
                    <textarea class="form-control" id="reviewComment" rows="3" placeholder="What was your experience?"></textarea>
                </div>
                
                <div class="checkbox-item">
                    <input type="checkbox" id="reviewRecommend" checked>
                    <label for="reviewRecommend">Would recommend to other travelers</label>
                </div>
                
                <div id="reviewPlaceResult"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReviewPlaceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPlaceReview()">ğŸ“¤ Submit Review</button>
            </div>
        </div>
    </div>
    
    <!-- View Request Modal -->
    <div class="modal-overlay" id="viewRequestModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header"><h2>ğŸ†˜ Help Request</h2><button class="modal-close" onclick="closeViewRequestModal()">Ã—</button></div>
            <div class="modal-body" id="viewRequestContent">
                <!-- Populated dynamically -->
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 12px;">
                <div style="display: flex; gap: 12px; width: 100%;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); messageFromViewRequest()" style="flex: 1;">ğŸ’¬ Message</button>
                    <button class="btn btn-success" onclick="event.stopPropagation(); helpFromViewRequest()" style="flex: 1;">ğŸš— I'll Help!</button>
                </div>
                <button class="btn btn-secondary" onclick="closeViewRequestModal()" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Universal Chat Modal -->
    <div class="modal-overlay" id="universalChatModal">
        <div class="modal" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="uniChatAvatar" style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white;"></div>
                    <div>
                        <p style="margin: 0; font-size: 12px; color: var(--text-light);">Chatting with</p>
                        <h2 id="uniChatName" style="margin: 0; font-size: 18px; font-weight: 700;">User</h2>
                        <p id="uniChatContext" style="margin: 2px 0 0; font-size: 11px; color: var(--text-light);"></p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeUniversalChat()">Ã—</button>
            </div>
            <div id="universalChatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-alt);">
                <p style="color: var(--text-light); text-align: center;">Loading messages...</p>
            </div>
            <div class="modal-footer" style="flex-shrink: 0; padding: 12px;">
                <div style="display: flex; gap: 8px; width: 100%;">
                    <button class="btn btn-secondary" onclick="closeUniversalChat()" style="padding: 12px 16px;">Cancel</button>
                    <input type="text" class="form-control" id="universalChatInput" placeholder="Type a message..." style="flex: 1;">
                    <button class="btn btn-primary" onclick="sendUniversalMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mozbpccxzfcoswvxjuym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vemJwY2N4emZjb3N3dnhqdXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODY4NTQsImV4cCI6MjA4NDY2Mjg1NH0.lfOM5ojN2B1MV6wMsntGWmI7OWL7fhUJV5E8b6I48N0';
        const W3W_API_KEY = 'X6FXORRH';
        const W3W_ENABLED = false; // Set to true when you have a valid API key
        
        let db=null,currentUser=null,userProfile=null,helpersMap=null,homeMap=null,availMap=null,dashboardMap=null;
        let markers=[],currentHelpers=[],selectedHelper=null,currentInteractionId=null,selectedRating=null;
        let homeMarker=null,availMarker=null,userVehicles=[],userEmergencyContacts=[],sosTimer=null,sosStartTime=null,currentRespondRequest=null;
        let userICEData={bloodType:'',contactName:'',emergencyNotes:'',shareInEmergency:false};
        let userAllergies=[],userMedications=[],userConditions=[];
        let gpsFormats={home:'dd',avail:'dd',sos:'dd',search:'dd'},gpsCoords={home:null,avail:null,sos:null,search:null};
        
        const ADJECTIVES=['Swift','Brave','Clever','Dusty','Epic','Fierce','Golden','Happy','Iron','Jolly','Keen','Lucky','Mighty','Noble','Ocean','Proud','Quick','Rusty','Shadow','Thunder','Urban','Velvet','Wild','Alpine','Blazing','Coastal','Desert','Eastern','Forest','Glacier','Harbor','Island','Jungle','Lunar','Misty','Nordic','Outback','Prairie','River','Solar','Tropic','Valley','Western','Azure','Crimson','Emerald'];
        const NOUNS=['Rider','Nomad','Voyager','Wanderer','Explorer','Traveler','Pioneer','Ranger','Scout','Drifter','Adventurer','Roamer','Trekker','Cruiser','Rambler','Wayfarer','Pilgrim','Pathfinder','Navigator','Hawk','Wolf','Bear','Eagle','Fox','Lion','Tiger','Falcon','Raven','Phoenix','Dragon','Panther','Cobra','Viper','Shark','Stallion','Mustang','Thunder','Storm','Blaze','Frost','Shadow','Phantom','Ghost','Knight','Warrior','Hunter','Seeker','Guardian'];
        const AVATAR_COLORS=['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#14b8a6','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#8b5cf6','#a855f7','#d946ef','#ec4899','#f43f5e'];
        const AVATAR_ICONS=['ğŸ¦Š','ğŸº','ğŸ¦','ğŸ¯','ğŸ¦…','ğŸ¦‰','ğŸ','ğŸ¦ˆ','ğŸ»','ğŸ¼','ğŸ¦Œ','ğŸ¦','ğŸ˜','ğŸ¦’','ğŸ†','ğŸ¦‡','ğŸ²','ğŸ¦‹','ğŸ¦©','ğŸ§','ğŸ¢','ğŸ¦€','ğŸ™','ğŸ¦‘','ğŸ¬','ğŸ³','ğŸ¦­','ğŸ','ğŸ¦„','ğŸ—'];
        
        // GPS Format Functions
        function convertToDD(lat,lng){return{lat:lat.toFixed(6),lng:lng.toFixed(6)}}
        function convertToDMS(lat,lng){
            function toDMS(c,isLat){const a=Math.abs(c),d=Math.floor(a),mf=(a-d)*60,m=Math.floor(mf),s=((mf-m)*60).toFixed(1),dir=isLat?(c>=0?'N':'S'):(c>=0?'E':'W');return`${d}Â°${m}'${s}"${dir}`}
            return{lat:toDMS(lat,true),lng:toDMS(lng,false)}
        }
        function convertToDDM(lat,lng){
            function toDDM(c,isLat){const a=Math.abs(c),d=Math.floor(a),m=((a-d)*60).toFixed(3),dir=isLat?(c>=0?'N':'S'):(c>=0?'E':'W');return`${d}Â°${m}'${dir}`}
            return{lat:toDDM(lat,true),lng:toDDM(lng,false)}
        }
        function formatGPS(lat,lng,fmt){return fmt==='dms'?convertToDMS(lat,lng):fmt==='ddm'?convertToDDM(lat,lng):convertToDD(lat,lng)}
        
        function renderGPSDisplay(target,lat,lng){
            gpsCoords[target]={lat,lng};const fmt=gpsFormats[target],f=formatGPS(lat,lng,fmt);
            document.getElementById(`${target}GPSValues`).innerHTML=`<div class="gps-value-row"><span class="label">Lat:</span><span class="value" id="${target}LatV">${f.lat}</span><button class="copy-btn" onclick="copyValue('${target}LatV',this)">Copy</button></div><div class="gps-value-row"><span class="label">Lng:</span><span class="value" id="${target}LngV">${f.lng}</span><button class="copy-btn" onclick="copyValue('${target}LngV',this)">Copy</button></div>`;
            document.getElementById(`${target}GPSDisplay`).classList.remove('hidden');
            document.getElementById(`${target}GPSDisplay`).classList.add('has-location');
            fetchW3W(lat,lng,target);
        }
        
        function setGPSFormat(target,fmt){
            gpsFormats[target]=fmt;
            document.querySelectorAll(`#${target}GPSDisplay .gps-format-tab`).forEach(t=>{t.classList.remove('active');if(t.textContent.toLowerCase()===fmt)t.classList.add('active')});
            if(gpsCoords[target])renderGPSDisplay(target,gpsCoords[target].lat,gpsCoords[target].lng);
        }
        
        // Real What3Words API Integration
        async function fetchW3W(lat,lng,target){
            const w3wDiv = document.getElementById(`${target}W3W`);
            const w3wValue = document.getElementById(`${target}W3WValue`);
            
            // Check if W3W is enabled
            if(!W3W_ENABLED){
                w3wDiv.classList.add('hidden');
                return;
            }
            
            w3wValue.textContent = 'loading...';
            w3wDiv.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://api.what3words.com/v3/convert-to-3wa?coordinates=${lat},${lng}&key=${W3W_API_KEY}`);
                const data = await response.json();
                if (data.words) {
                    w3wValue.textContent = `///${data.words}`;
                } else if (data.error) {
                    // Quota exceeded or other API error - hide quietly
                    w3wDiv.classList.add('hidden');
                }
            } catch (e) {
                console.log('W3W error:', e);
                w3wDiv.classList.add('hidden');
            }
        }
        
        function copyValue(id,btn){navigator.clipboard.writeText(document.getElementById(id).textContent).then(()=>{btn.textContent='âœ“';btn.classList.add('copied');setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied')},2000)})}
        function updateGPSDisplay(target){const lat=parseFloat(document.getElementById(target==='home'?'profileHomeLat':`${target}Lat`).value),lng=parseFloat(document.getElementById(target==='home'?'profileHomeLng':`${target}Lng`).value);if(!isNaN(lat)&&!isNaN(lng))renderGPSDisplay(target,lat,lng)}
        
        // Initialization
        let defaultMapLocation = [-36.8485, 174.7633]; // Default to Auckland, will be updated when user loads
        
        window.onload=function(){initDatabase();checkURLParams();setTimeout(initMaps,200)};
        function checkURLParams(){if(new URLSearchParams(window.location.search).get('mode')==='signup')showSignUp();else showSignIn()}
        function initDatabase(){try{db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);updateConnectionStatus(true);checkAuth()}catch(e){updateConnectionStatus(false)}}
        function initMaps(){
            const v = defaultMapLocation;
            try{
                helpersMap=L.map('helpersMap',{scrollWheelZoom:true}).setView(v,10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(helpersMap);
                
                homeMap=L.map('homeMap',{scrollWheelZoom:true}).setView(v,10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(homeMap);
                
                availMap=L.map('availMap',{scrollWheelZoom:true}).setView(v,10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(availMap);
                
                dashboardMap=L.map('dashboardMap',{scrollWheelZoom:true}).setView(v,10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(dashboardMap);
                
                // Force invalidate all maps after short delay
                setTimeout(()=>{
                    if(helpersMap)helpersMap.invalidateSize();
                    if(homeMap)homeMap.invalidateSize();
                    if(availMap)availMap.invalidateSize();
                    if(dashboardMap)dashboardMap.invalidateSize();
                },300);
            }catch(e){console.error('Map init error:',e)}
        }
        
        // Update all maps to user's location
        function updateMapsToUserLocation(lat, lng){
            defaultMapLocation = [lat, lng];
            if(helpersMap) helpersMap.setView([lat, lng], 11);
            if(availMap) availMap.setView([lat, lng], 12);
            if(dashboardMap) dashboardMap.setView([lat, lng], 11);
            // Don't update homeMap here - it gets updated specifically when home location is set
        }
        function updateConnectionStatus(c){const b=document.getElementById('connectionStatus');b.textContent=c?'Connected':'Disconnected';b.className='status-badge '+(c?'status-connected':'status-disconnected')}
        
        // Anonymous Name
        function generateAnonymousName(e){let h=0;for(let i=0;i<e.length;i++){h=((h<<5)-h)+e.charCodeAt(i);h=h&h}h=Math.abs(h);return`${ADJECTIVES[h%ADJECTIVES.length]}${NOUNS[(h>>8)%NOUNS.length]}${(h%999)+1}`}
        function generateAvatarData(e){let h=0;for(let i=0;i<e.length;i++){h=((h<<5)-h)+e.charCodeAt(i);h=h&h}h=Math.abs(h);return{color:AVATAR_COLORS[h%AVATAR_COLORS.length],icon:AVATAR_ICONS[(h>>4)%AVATAR_ICONS.length]}}
        function renderAvatar(e,el){const d=generateAvatarData(e);el.style.background=d.color;el.textContent=d.icon}
        
        // Auth
        function showSignIn(){document.getElementById('signInCard').classList.remove('hidden');document.getElementById('signUpCard').classList.add('hidden')}
        function showSignUp(){document.getElementById('signInCard').classList.add('hidden');document.getElementById('signUpCard').classList.remove('hidden')}
        function showTab(tabId,btn){
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            // Refresh maps with longer delay to ensure container is visible
            setTimeout(()=>{
                if(tabId==='helpers'&&helpersMap){helpersMap.invalidateSize();helpersMap.setView(helpersMap.getCenter(),helpersMap.getZoom());}
                if(tabId==='profile'&&homeMap){homeMap.invalidateSize();homeMap.setView(homeMap.getCenter(),homeMap.getZoom());}
                if(tabId==='availability'&&availMap){availMap.invalidateSize();availMap.setView(availMap.getCenter(),availMap.getZoom());}
                if(tabId==='dashboard'&&dashboardMap){dashboardMap.invalidateSize();dashboardMap.setView(dashboardMap.getCenter(),dashboardMap.getZoom());}
            },150);
            if(tabId==='activity')loadActivity();
            if(tabId==='dashboard')loadDashboard();
            if(tabId==='travel')loadMyTravelPlans();
            if(tabId==='sos')loadActiveSOSRequests();
            if(tabId==='places')loadMyPlaceReviews();
            if(tabId==='messages')loadConversations();
        }
        function showLoggedInTabs(){document.querySelectorAll('.tab[data-tab]').forEach(t=>{if(t.dataset.tab!=='auth')t.classList.remove('hidden')});document.querySelector('.tab[data-tab="auth"]').classList.add('hidden')}
        async function checkAuth(){if(!db)return;const{data}=await db.auth.getUser();if(data&&data.user){currentUser=data.user;await onUserLoggedIn()}}
        async function onUserLoggedIn(){
            const dn=generateAnonymousName(currentUser.id);
            document.getElementById('userArea').classList.remove('hidden');
            document.getElementById('userDisplayName').textContent=dn;
            renderAvatar(currentUser.id,document.getElementById('userAvatar'));
            document.getElementById('profileDisplayName').textContent=dn;
            renderAvatar(currentUser.id,document.getElementById('profileAvatar'));
            showLoggedInTabs();
            showTab('dashboard',document.querySelector('[data-tab="dashboard"]'));
            await loadProfile();
            await loadAvailability();
            await loadVehicles();
            await loadEmergencyContacts();
            await loadICEData();
            await checkPendingFeedback();
            await loadDashboard();
            
            // Setup realtime subscriptions for notifications
            setupRealtimeSubscriptions();
        }
        
        let sosSubscription = null;
        let interactionSubscription = null;
        
        function setupRealtimeSubscriptions(){
            // Subscribe to changes on interactions where I'm the requester (help coming!)
            interactionSubscription = db.channel('my-help-coming')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'interactions',
                    filter: `requester_id=eq.${currentUser.id}`
                }, async (payload) => {
                    console.log('New help response!', payload);
                    await notifyHelpComing(payload.new);
                })
                .subscribe();
            
            // Subscribe to changes on my SOS alerts (status changes)
            sosSubscription = db.channel('my-sos-updates')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'sos_alerts',
                    filter: `user_id=eq.${currentUser.id}`
                }, async (payload) => {
                    console.log('SOS alert updated!', payload);
                    if(payload.new.status === 'help_coming'){
                        // Refresh the SOS tab
                        await loadActiveSOSRequests();
                    }
                })
                .subscribe();
        }
        
        async function notifyHelpComing(interaction){
            // Play notification sound
            playNotificationSound();
            
            // Get helper info
            const helperName = generateAnonymousName(interaction.helper_id);
            
            // Show browser notification if permitted
            if(Notification.permission === 'granted'){
                new Notification('ğŸš— Help is on the way!', {
                    body: `${helperName} is coming to help you${interaction.eta ? ' - ETA: ' + interaction.eta : ''}`,
                    icon: 'ğŸ†˜',
                    tag: 'help-coming'
                });
            }
            
            // Show in-app notification banner
            showNotificationBanner(`ğŸš— ${helperName} is on their way!${interaction.eta ? ' ETA: ' + interaction.eta : ''}`, 'success');
            
            // Refresh the incoming help section
            await loadActiveSOSRequests();
            
            // If on SOS tab, scroll to incoming help
            if(document.getElementById('sos').classList.contains('active')){
                document.getElementById('incomingHelpSection').scrollIntoView({behavior: 'smooth'});
            }
        }
        
        function playNotificationSound(){
            // Create a simple notification beep using Web Audio API
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 880; // A5 note
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
                
                // Second beep
                setTimeout(() => {
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    osc2.frequency.value = 1100; // Higher note
                    osc2.type = 'sine';
                    gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc2.start(audioCtx.currentTime);
                    osc2.stop(audioCtx.currentTime + 0.5);
                }, 200);
            } catch(e) {
                console.log('Could not play notification sound:', e);
            }
        }
        
        function showNotificationBanner(message, type = 'info'){
            // Remove any existing banner
            const existing = document.getElementById('notificationBanner');
            if(existing) existing.remove();
            
            const colors = {
                success: {bg: '#dcfce7', border: '#22c55e', text: '#166534'},
                danger: {bg: '#fef2f2', border: '#ef4444', text: '#991b1b'},
                warning: {bg: '#fffbeb', border: '#f59e0b', text: '#92400e'},
                info: {bg: '#eff6ff', border: '#3b82f6', text: '#1e40af'}
            };
            const c = colors[type] || colors.info;
            
            const banner = document.createElement('div');
            banner.id = 'notificationBanner';
            banner.innerHTML = `
                <div style="position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:10000;
                    background:${c.bg};border:2px solid ${c.border};border-radius:12px;padding:16px 24px;
                    box-shadow:0 4px 20px rgba(0,0,0,0.15);display:flex;align-items:center;gap:12px;
                    max-width:90%;animation:slideDown 0.3s ease-out;">
                    <span style="font-size:24px;">ğŸš—</span>
                    <span style="font-weight:600;color:${c.text};">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;font-size:20px;cursor:pointer;padding:0 0 0 12px;">Ã—</button>
                </div>
            `;
            document.body.appendChild(banner);
            
            // Auto-remove after 10 seconds
            setTimeout(() => banner.remove(), 10000);
        }
        
        // Request notification permission on first visit
        function requestNotificationPermission(){
            if('Notification' in window && Notification.permission === 'default'){
                Notification.requestPermission();
            }
        }
        async function handleSignIn(){const e=document.getElementById('signInEmail').value,p=document.getElementById('signInPassword').value,r=document.getElementById('signInResult');if(!e||!p){r.innerHTML='<div class="alert alert-danger">Enter credentials</div>';return}r.innerHTML='<div class="alert alert-info">Signing in...</div>';const{data,error}=await db.auth.signInWithPassword({email:e,password:p});if(error)r.innerHTML='<div class="alert alert-danger">âŒ '+error.message+'</div>';else{currentUser=data.user;r.innerHTML='<div class="alert alert-success">âœ… Welcome!</div>';await onUserLoggedIn()}}
        async function handleSignUp(){const e=document.getElementById('signUpEmail').value,p=document.getElementById('signUpPassword').value,r=document.getElementById('signUpResult');if(!e||!p){r.innerHTML='<div class="alert alert-danger">Enter credentials</div>';return}r.innerHTML='<div class="alert alert-info">Creating...</div>';const{error}=await db.auth.signUp({email:e,password:p});r.innerHTML=error?'<div class="alert alert-danger">âŒ '+error.message+'</div>':`<div class="alert alert-success">âœ… Account created! Check your email to confirm, then sign in to see your anonymous identity.</div>`}
        async function handleSignOut(){await db.auth.signOut();currentUser=null;userProfile=null;document.getElementById('userArea').classList.add('hidden');document.querySelectorAll('.tab[data-tab]').forEach(t=>{if(t.dataset.tab!=='auth')t.classList.add('hidden')});document.querySelector('.tab[data-tab="auth"]').classList.remove('hidden');showTab('auth',document.querySelector('[data-tab="auth"]'));showSignIn()}
        
        // Location
        function toggleManualEntry(t){document.getElementById(`${t}ManualEntry`).classList.toggle('hidden')}
        
        async function geocodeHomeAddress(){
            const suburb = document.getElementById('profileSuburb').value;
            const city = document.getElementById('profileCity').value;
            const country = document.getElementById('profileCountry').value;
            const postCode = document.getElementById('profilePostCode').value;
            
            const addressParts = [suburb, city, postCode, country].filter(p => p && p.trim());
            if (addressParts.length < 2) {
                alert('Please enter at least City and Country in the Home Address section above.');
                return;
            }
            
            const address = addressParts.join(', ');
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
                    headers: { 'User-Agent': 'Obonato App' }
                });
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    document.getElementById('profileHomeLat').value = lat.toFixed(6);
                    document.getElementById('profileHomeLng').value = lng.toFixed(6);
                    document.getElementById('homeManualEntry').classList.remove('hidden');
                    
                    renderGPSDisplay('home', lat, lng);
                    homeMap.setView([lat, lng], 14);
                    if (homeMarker) homeMap.removeLayer(homeMarker);
                    homeMarker = L.marker([lat, lng]).addTo(homeMap);
                } else {
                    alert('Could not find coordinates for this address. Try adding more details or use Device GPS.');
                }
            } catch (e) {
                console.error('Geocoding error:', e);
                alert('Error looking up address. Please try Device GPS or enter coordinates manually.');
            }
        }
        
        function captureHomeGPS(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{const lat=p.coords.latitude,lng=p.coords.longitude;document.getElementById('profileHomeLat').value=lat.toFixed(6);document.getElementById('profileHomeLng').value=lng.toFixed(6);document.getElementById('homeManualEntry').classList.remove('hidden');renderGPSDisplay('home',lat,lng);homeMap.setView([lat,lng],14);if(homeMarker)homeMap.removeLayer(homeMarker);homeMarker=L.marker([lat,lng]).addTo(homeMap)},e=>alert('Error: '+e.message),{enableHighAccuracy:true})}
        
        function getLocation(target,source){
            if(source==='home'){
                // Check if we have home coordinates - either from userProfile or from the form fields
                let lat = userProfile?.home_latitude || parseFloat(document.getElementById('profileHomeLat')?.value);
                let lng = userProfile?.home_longitude || parseFloat(document.getElementById('profileHomeLng')?.value);
                
                if(!lat || !lng || isNaN(lat) || isNaN(lng)){
                    alert('Home location not set. Please set your Home Location in your Profile first, then Save Profile.');
                    return;
                }
                
                const locationName = `${userProfile?.suburb||''}, ${userProfile?.city||''}`.replace(/^,\s*|,\s*$/g,'').trim() || 'Home';
                
                if(target==='avail'){
                    document.getElementById('availLat').value=lat;
                    document.getElementById('availLng').value=lng;
                    document.getElementById('availManualEntry').classList.remove('hidden');
                    document.getElementById('availLocation').value=locationName;
                    renderGPSDisplay('avail',lat,lng);
                    availMap.setView([lat,lng],12);
                    if(availMarker)availMap.removeLayer(availMarker);
                    availMarker=L.marker([lat,lng]).addTo(availMap);
                }
                else if(target==='search'){
                    document.getElementById('searchLat').value=lat;
                    document.getElementById('searchLng').value=lng;
                    document.getElementById('searchManualEntry').classList.remove('hidden');
                    renderGPSDisplay('search',lat,lng);
                    helpersMap.setView([lat,lng],11);
                }
                else if(target==='sos'){
                    document.getElementById('sosLat').value=lat;
                    document.getElementById('sosLng').value=lng;
                    renderGPSDisplay('sos',lat,lng);
                }
            }
            else if(source==='gps'){
                if(!navigator.geolocation){
                    alert('Geolocation is not supported by your browser');
                    return;
                }
                navigator.geolocation.getCurrentPosition(p=>{
                    const lat=p.coords.latitude,lng=p.coords.longitude;
                    if(target==='avail'){
                        document.getElementById('availLat').value=lat.toFixed(6);
                        document.getElementById('availLng').value=lng.toFixed(6);
                        document.getElementById('availManualEntry').classList.remove('hidden');
                        renderGPSDisplay('avail',lat,lng);
                        availMap.setView([lat,lng],12);
                        if(availMarker)availMap.removeLayer(availMarker);
                        availMarker=L.marker([lat,lng]).addTo(availMap);
                    }
                    else if(target==='search'){
                        document.getElementById('searchLat').value=lat.toFixed(6);
                        document.getElementById('searchLng').value=lng.toFixed(6);
                        document.getElementById('searchManualEntry').classList.remove('hidden');
                        renderGPSDisplay('search',lat,lng);
                        helpersMap.setView([lat,lng],11);
                    }
                    else if(target==='sos'){
                        document.getElementById('sosLat').value=lat.toFixed(6);
                        document.getElementById('sosLng').value=lng.toFixed(6);
                        renderGPSDisplay('sos',lat,lng);
                    }
                },e=>alert('Error getting location: '+e.message),{enableHighAccuracy:true});
            }
        }
        
        // Profile
        async function loadProfile(){
            if(!currentUser)return;
            const{data}=await db.from('profiles').select('*').eq('id',currentUser.id).single();
            if(data){
                userProfile=data;
                document.getElementById('profileFirstName').value=data.first_name||'';
                document.getElementById('profileSurname').value=data.last_name||'';
                document.getElementById('profileMobile').value=data.phone||'';
                document.getElementById('profileGender').value=data.gender||'';
                document.getElementById('prefMeetupGender').value=data.pref_meetup_gender||'any';
                document.getElementById('prefSOSGender').value=data.pref_sos_gender||'any';
                document.getElementById('prefHitchGender').value=data.pref_hitch_gender||'any';
                document.getElementById('profileCountry').value=data.country||'';
                document.getElementById('profileSuburb').value=data.suburb||'';
                document.getElementById('profileCity').value=data.city||'';
                document.getElementById('profilePostCode').value=data.post_code||'';
                document.getElementById('autoNotifyEmergency').checked=data.auto_notify_emergency||false;
                if(data.home_latitude&&data.home_longitude){
                    document.getElementById('profileHomeLat').value=data.home_latitude;
                    document.getElementById('profileHomeLng').value=data.home_longitude;
                    document.getElementById('homeManualEntry').classList.remove('hidden');
                    renderGPSDisplay('home',data.home_latitude,data.home_longitude);
                    homeMap.setView([data.home_latitude,data.home_longitude],14);
                    if(homeMarker)homeMap.removeLayer(homeMarker);
                    homeMarker=L.marker([data.home_latitude,data.home_longitude]).addTo(homeMap);
                    updateMapsToUserLocation(data.home_latitude, data.home_longitude);
                }
                if(data.unit_distance)selectRadio('unitDistance',data.unit_distance);
                if(data.unit_temperature)selectRadio('unitTemp',data.unit_temperature);
                
                // Load user type and dates
                if(data.user_type){
                    setUserType(data.user_type);
                }
                if(data.available_from) document.getElementById('availableFrom').value = data.available_from;
                if(data.available_until) document.getElementById('availableUntil').value = data.available_until;
                if(data.traveling_from) document.getElementById('travelingFrom').value = data.traveling_from;
                if(data.traveling_until) document.getElementById('travelingUntil').value = data.traveling_until;
                if(data.traveling_open_ended){
                    document.getElementById('travelingOpenEnded').checked = true;
                    document.getElementById('travelingUntil').disabled = true;
                }
                
                // Load profile photo
                if(data.photo_url){
                    displayProfilePhoto(data.photo_url);
                }
                
                // Load verification status
                await loadVerificationStatus();
            }
        }
        
        async function loadVerificationStatus(){
            if(!currentUser) return;
            
            const hasPhoto = userProfile?.photo_url ? true : false;
            const photoUpdatedAt = userProfile?.photo_updated_at || '1970-01-01';
            
            // Count positive feedback received AFTER the photo was last updated
            // This ensures changing photo resets verification
            let query = db.from('feedback')
                .select('*')
                .eq('to_user_id', currentUser.id)
                .eq('rating', 'positive')
                .eq('would_interact_again', true);
            
            // Only count feedback after photo was updated
            if(userProfile?.photo_updated_at){
                query = query.gte('created_at', userProfile.photo_updated_at);
            }
            
            const{data: feedback, error} = await query;
            
            const verificationCount = feedback?.length || 0;
            
            updateVerificationDisplay(hasPhoto, verificationCount);
        }
        
        function updateVerificationDisplay(hasPhoto, count){
            const levelEl = document.getElementById('verificationLevel');
            const barEl = document.getElementById('verificationBar');
            const textEl = document.getElementById('verificationText');
            const previewEl = document.getElementById('profilePhotoPreview');
            
            let level, color, progress, text;
            
            if(!hasPhoto){
                level = 'âš ï¸ Unverified';
                color = '#ef4444';
                progress = 0;
                text = 'Upload a photo to start verification';
                previewEl.style.borderColor = '#ef4444';
                previewEl.style.borderStyle = 'dashed';
            } else if(count === 0){
                level = 'ğŸ“· Photo Added';
                color = '#f59e0b';
                progress = 25;
                text = 'Meet community members to get verified (0/3)';
                previewEl.style.borderColor = '#f59e0b';
                previewEl.style.borderStyle = 'solid';
            } else if(count === 1){
                level = 'ğŸ”µ Verified x1';
                color = '#3b82f6';
                progress = 50;
                text = '1 community verification (2 more needed)';
                previewEl.style.borderColor = '#3b82f6';
                previewEl.style.borderStyle = 'solid';
            } else if(count === 2){
                level = 'ğŸ”µ Verified x2';
                color = '#3b82f6';
                progress = 75;
                text = '2 community verifications (1 more needed)';
                previewEl.style.borderColor = '#3b82f6';
                previewEl.style.borderStyle = 'solid';
            } else {
                level = 'âœ… Community Verified';
                color = '#22c55e';
                progress = 100;
                text = `Fully verified by ${count} community member${count > 1 ? 's' : ''}`;
                previewEl.style.borderColor = '#22c55e';
                previewEl.style.borderStyle = 'solid';
            }
            
            levelEl.innerHTML = `<span style="color: ${color};">${level}</span>`;
            barEl.style.background = color;
            barEl.style.width = progress + '%';
            textEl.textContent = text;
        }
        
        // Profile Photo Functions
        async function handlePhotoSelect(event){
            const file = event.target.files[0];
            if(!file) return;
            
            const status = document.getElementById('photoUploadStatus');
            
            // Validate file
            if(!file.type.startsWith('image/')){
                status.innerHTML = '<span style="color:var(--danger)">âŒ Please select an image file</span>';
                return;
            }
            if(file.size > 2 * 1024 * 1024){
                status.innerHTML = '<span style="color:var(--danger)">âŒ File too large (max 2MB)</span>';
                return;
            }
            
            // Warn if changing existing photo (verification will reset)
            if(userProfile?.photo_url){
                const confirmChange = confirm('âš ï¸ Changing your photo will reset your verification status.\n\nYou will need 3 new positive community verifications to become fully verified again.\n\nDo you want to continue?');
                if(!confirmChange){
                    event.target.value = ''; // Clear file input
                    return;
                }
            }
            
            status.innerHTML = '<span style="color:var(--primary)">â³ Uploading...</span>';
            
            try {
                // Create unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/profile.${fileExt}`;
                
                // Upload to Supabase Storage
                const { data, error } = await db.storage
                    .from('profile-photos')
                    .upload(fileName, file, { 
                        cacheControl: '3600',
                        upsert: true 
                    });
                
                if(error) throw error;
                
                // Get public URL
                const { data: urlData } = db.storage
                    .from('profile-photos')
                    .getPublicUrl(fileName);
                
                const photoUrl = urlData.publicUrl + '?t=' + Date.now(); // Cache bust
                
                // Save URL to profile and reset verification timestamp
                await db.from('profiles').update({ 
                    photo_url: photoUrl,
                    photo_updated_at: new Date().toISOString()
                }).eq('id', currentUser.id);
                
                // Display photo
                displayProfilePhoto(photoUrl);
                userProfile.photo_url = photoUrl;
                userProfile.photo_updated_at = new Date().toISOString();
                
                status.innerHTML = '<span style="color:var(--success)">âœ… Photo uploaded!</span>';
                setTimeout(() => status.innerHTML = '', 3000);
                
                // Update verification display (will show as "Photo Added" since verifications reset)
                updateVerificationDisplay(true, 0);
                
            } catch(e) {
                console.error('Photo upload error:', e);
                status.innerHTML = `<span style="color:var(--danger)">âŒ ${e.message || 'Upload failed'}</span>`;
            }
        }
        
        function displayProfilePhoto(url){
            const img = document.getElementById('profilePhotoImg');
            const placeholder = document.getElementById('photoPlaceholder');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            img.src = url;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'inline-block';
        }
        
        async function removeProfilePhoto(){
            if(!confirm('Remove your profile photo?')) return;
            
            const status = document.getElementById('photoUploadStatus');
            status.innerHTML = '<span style="color:var(--primary)">â³ Removing...</span>';
            
            try {
                // Remove from storage
                const fileName = `${currentUser.id}/profile.jpg`;
                await db.storage.from('profile-photos').remove([fileName]);
                
                // Also try png
                const fileNamePng = `${currentUser.id}/profile.png`;
                await db.storage.from('profile-photos').remove([fileNamePng]);
                
                // Clear URL from profile
                await db.from('profiles').update({ photo_url: null }).eq('id', currentUser.id);
                
                // Reset UI
                const img = document.getElementById('profilePhotoImg');
                const placeholder = document.getElementById('photoPlaceholder');
                const removeBtn = document.getElementById('removePhotoBtn');
                
                img.src = '';
                img.style.display = 'none';
                placeholder.style.display = 'block';
                removeBtn.style.display = 'none';
                userProfile.photo_url = null;
                
                status.innerHTML = '<span style="color:var(--success)">âœ… Photo removed</span>';
                setTimeout(() => status.innerHTML = '', 3000);
                
            } catch(e) {
                console.error('Photo remove error:', e);
                status.innerHTML = `<span style="color:var(--danger)">âŒ ${e.message}</span>`;
            }
        }
        
        // Get photo URL for displaying to verified helpers only
        async function getPhotoForVerifiedUser(userId){
            const { data } = await db.from('profiles').select('photo_url').eq('id', userId).single();
            return data?.photo_url || null;
        }
        async function handleSaveProfile(){
            if(!currentUser)return;
            const r=document.getElementById('profileResult');
            r.innerHTML='<div class="alert alert-info">Saving...</div>';
            const lat=parseFloat(document.getElementById('profileHomeLat').value);
            const lng=parseFloat(document.getElementById('profileHomeLng').value);
            const d={
                id:currentUser.id,
                display_name:generateAnonymousName(currentUser.id),
                first_name:document.getElementById('profileFirstName').value,
                last_name:document.getElementById('profileSurname').value,
                phone:document.getElementById('profileMobile').value,
                gender:document.getElementById('profileGender').value||null,
                pref_meetup_gender:document.getElementById('prefMeetupGender').value,
                pref_sos_gender:document.getElementById('prefSOSGender').value,
                pref_hitch_gender:document.getElementById('prefHitchGender').value,
                user_type:document.querySelector('input[name="userType"]:checked')?.value||null,
                available_from:document.getElementById('availableFrom').value||null,
                available_until:document.getElementById('availableUntil').value||null,
                traveling_from:document.getElementById('travelingFrom').value||null,
                traveling_until:document.getElementById('travelingUntil').value||null,
                traveling_open_ended:document.getElementById('travelingOpenEnded').checked,
                country:document.getElementById('profileCountry').value,
                suburb:document.getElementById('profileSuburb').value,
                city:document.getElementById('profileCity').value,
                post_code:document.getElementById('profilePostCode').value,
                home_latitude:isNaN(lat)?null:lat,
                home_longitude:isNaN(lng)?null:lng,
                auto_notify_emergency:document.getElementById('autoNotifyEmergency').checked,
                unit_distance:document.querySelector('input[name="unitDistance"]:checked')?.value||'km',
                unit_temperature:document.querySelector('input[name="unitTemp"]:checked')?.value||'celsius',
                updated_at:new Date().toISOString()
            };
            const{error}=await db.from('profiles').upsert(d);
            
            // Also save ICE data
            await saveICEData();
            
            userProfile=d;
            r.innerHTML=error?'<div class="alert alert-danger">âŒ '+error.message+'</div>':'<div class="alert alert-success">âœ… Saved!</div>';
        }
        function selectRadio(name,val){document.querySelectorAll(`input[name="${name}"]`).forEach(r=>{r.checked=r.value===val;r.closest('.radio-item').classList.toggle('selected',r.checked)})}
        
        // User Type (Local/Traveler)
        function setUserType(type){
            document.querySelectorAll('input[name="userType"]').forEach(r=>{
                r.checked = r.value === type;
                r.closest('.radio-item').classList.toggle('selected', r.checked);
            });
            
            const localSection = document.getElementById('localHelperDates');
            const travelerSection = document.getElementById('travelerSection');
            
            if(type === 'local'){
                localSection.classList.remove('hidden');
                travelerSection.classList.add('hidden');
            } else if(type === 'traveler'){
                localSection.classList.add('hidden');
                travelerSection.classList.remove('hidden');
            } else if(type === 'both'){
                localSection.classList.remove('hidden');
                travelerSection.classList.remove('hidden');
            }
        }
        
        function toggleOpenEndedTravel(){
            const checkbox = document.getElementById('travelingOpenEnded');
            const untilField = document.getElementById('travelingUntil');
            if(checkbox.checked){
                untilField.value = '';
                untilField.disabled = true;
            } else {
                untilField.disabled = false;
            }
        }
        
        // Vehicles
        async function loadVehicles(){if(!currentUser)return;const{data}=await db.from('user_vehicles').select('*').eq('user_id',currentUser.id).order('is_active',{ascending:false});userVehicles=data||[];renderVehicles();populateVehicleDropdown()}
        function renderVehicles(){const div=document.getElementById('vehiclesList');if(userVehicles.length===0){div.innerHTML='<p style="color:var(--text-light)">No vehicles.</p>';return}const icons={motorcycle:'ğŸï¸',car:'ğŸš—','4wd':'ğŸš™',truck:'ğŸš›',rv:'ğŸš',bicycle:'ğŸš´',boat:'â›µ'};div.innerHTML=userVehicles.map(v=>`<div class="vehicle-card ${v.is_active?'':'inactive'}"><div class="vehicle-header"><span class="vehicle-icon">${icons[v.vehicle_type]||'ğŸš—'}</span><span class="vehicle-status ${v.is_active?'active':'inactive'}">${v.is_active?'Active':'Inactive'}</span></div><h5>${v.year||''} ${v.make} ${v.model}</h5><div class="vehicle-details"><span>â›½ ${v.fuel_type||'-'}</span><span>ğŸ¨ ${v.colour||'-'}</span></div><button class="btn btn-secondary btn-xs" onclick="editVehicle('${v.id}')" style="margin-top:12px">âœï¸ Edit</button></div>`).join('')}
        function populateVehicleDropdown(){const s=document.getElementById('sosVehicle');s.innerHTML='<option value="">-- Not vehicle related --</option>';userVehicles.filter(v=>v.is_active).forEach(v=>{s.innerHTML+=`<option value="${v.id}">${v.year||''} ${v.make} ${v.model}</option>`})}
        function openVehicleModal(){document.getElementById('vehicleModalTitle').textContent='Add Vehicle';document.getElementById('vehicleEditId').value='';document.getElementById('vehicleType').value='motorcycle';document.getElementById('vehicleMake').value='';document.getElementById('vehicleModel').value='';document.getElementById('vehicleYear').value='';document.getElementById('vehicleFuel').value='';document.getElementById('vehicleColour').value='';document.getElementById('vehicleRego').value='';document.getElementById('vehicleNotes').value='';document.getElementById('vehicleActive').checked=true;document.getElementById('vehicleDeleteBtn').classList.add('hidden');document.getElementById('vehicleModal').classList.add('active')}
        function editVehicle(id){const v=userVehicles.find(x=>x.id===id);if(!v)return;document.getElementById('vehicleModalTitle').textContent='Edit Vehicle';document.getElementById('vehicleEditId').value=v.id;document.getElementById('vehicleType').value=v.vehicle_type||'car';document.getElementById('vehicleMake').value=v.make||'';document.getElementById('vehicleModel').value=v.model||'';document.getElementById('vehicleYear').value=v.year||'';document.getElementById('vehicleFuel').value=v.fuel_type||'';document.getElementById('vehicleColour').value=v.colour||'';document.getElementById('vehicleRego').value=v.registration||'';document.getElementById('vehicleNotes').value=v.notes||'';document.getElementById('vehicleActive').checked=v.is_active;document.getElementById('vehicleDeleteBtn').classList.remove('hidden');document.getElementById('vehicleModal').classList.add('active')}
        function closeVehicleModal(){document.getElementById('vehicleModal').classList.remove('active')}
        async function saveVehicle(){const editId=document.getElementById('vehicleEditId').value,d={user_id:currentUser.id,vehicle_type:document.getElementById('vehicleType').value,make:document.getElementById('vehicleMake').value,model:document.getElementById('vehicleModel').value,year:parseInt(document.getElementById('vehicleYear').value)||null,fuel_type:document.getElementById('vehicleFuel').value,colour:document.getElementById('vehicleColour').value,registration:document.getElementById('vehicleRego').value,notes:document.getElementById('vehicleNotes').value,is_active:document.getElementById('vehicleActive').checked,updated_at:new Date().toISOString()};const{error}=editId?await db.from('user_vehicles').update(d).eq('id',editId):await db.from('user_vehicles').insert(d);if(error)alert('Error: '+error.message);else{closeVehicleModal();await loadVehicles()}}
        async function deleteVehicle(){const id=document.getElementById('vehicleEditId').value;if(!id||!confirm('Delete?'))return;const{error}=await db.from('user_vehicles').delete().eq('id',id);if(error)alert('Error: '+error.message);else{closeVehicleModal();await loadVehicles()}}
        
        // Emergency Contacts
        async function loadEmergencyContacts(){
            if(!currentUser)return;
            const{data}=await db.from('emergency_contacts').select('*').eq('user_id',currentUser.id).order('contact_type');
            userEmergencyContacts=data||[];
            renderEmergencyContacts();
            
            // Load auto-notify preference from profile
            if(userProfile?.auto_notify_emergency){
                document.getElementById('autoNotifyEmergency').checked = true;
            }
        }
        
        function renderEmergencyContacts(){
            const div=document.getElementById('emergencyContactsList');
            if(userEmergencyContacts.length===0){
                div.innerHTML='<p style="color:var(--text-light);padding:16px;background:var(--bg);border-radius:8px;">No emergency contacts added yet. Add at least one contact who can be notified in case of emergency.</p>';
                return;
            }
            
            const typeIcons = {home:'ğŸ ', local:'ğŸ“', travel_buddy:'ğŸ§­', other:'ğŸ‘¤'};
            const typeLabels = {home:'Home Contact', local:'Local Contact', travel_buddy:'Travel Buddy', other:'Other'};
            
            div.innerHTML=userEmergencyContacts.map((c,i)=>`
                <div style="background:var(--bg);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid ${c.contact_type==='home'?'var(--primary)':c.contact_type==='local'?'var(--success)':'var(--warning)'};">
                    <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:200px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                <span style="font-size:20px;">${typeIcons[c.contact_type]||'ğŸ‘¤'}</span>
                                <span style="font-weight:700;">${c.name}</span>
                                <span style="font-size:11px;background:var(--bg-alt);padding:2px 8px;border-radius:8px;">${typeLabels[c.contact_type]||'Other'}</span>
                            </div>
                            <div style="font-size:13px;color:var(--text-light);">
                                ${c.phone ? `<span style="margin-right:16px;">ğŸ“± ${c.phone}</span>` : ''}
                                ${c.email ? `<span>âœ‰ï¸ ${c.email}</span>` : ''}
                            </div>
                            ${c.relationship ? `<div style="font-size:12px;color:var(--text-light);margin-top:4px;">Relationship: ${c.relationship}</div>` : ''}
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-secondary btn-xs" onclick="editEmergencyContact(${i})">âœï¸</button>
                            <button class="btn btn-danger btn-xs" onclick="deleteEmergencyContact('${c.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function addEmergencyContact(){
            document.getElementById('ecEditId').value='';
            document.getElementById('ecName').value='';
            document.getElementById('ecPhone').value='';
            document.getElementById('ecEmail').value='';
            document.getElementById('ecType').value='home';
            document.getElementById('ecRelationship').value='';
            document.getElementById('ecModalTitle').textContent='Add Emergency Contact';
            document.getElementById('ecDeleteBtn').classList.add('hidden');
            document.getElementById('emergencyContactModal').classList.add('active');
        }
        
        function editEmergencyContact(index){
            const c = userEmergencyContacts[index];
            document.getElementById('ecEditId').value=c.id;
            document.getElementById('ecName').value=c.name||'';
            document.getElementById('ecPhone').value=c.phone||'';
            document.getElementById('ecEmail').value=c.email||'';
            document.getElementById('ecType').value=c.contact_type||'other';
            document.getElementById('ecRelationship').value=c.relationship||'';
            document.getElementById('ecModalTitle').textContent='Edit Emergency Contact';
            document.getElementById('ecDeleteBtn').classList.remove('hidden');
            document.getElementById('emergencyContactModal').classList.add('active');
        }
        
        function closeEmergencyContactModal(){
            document.getElementById('emergencyContactModal').classList.remove('active');
        }
        
        async function saveEmergencyContact(){
            const id = document.getElementById('ecEditId').value;
            const name = document.getElementById('ecName').value.trim();
            const phone = document.getElementById('ecPhone').value.trim();
            const email = document.getElementById('ecEmail').value.trim();
            const contactType = document.getElementById('ecType').value;
            const relationship = document.getElementById('ecRelationship').value.trim();
            
            if(!name){
                alert('Please enter a name');
                return;
            }
            if(!phone && !email){
                alert('Please enter at least a phone or email');
                return;
            }
            
            const contactData = {
                user_id: currentUser.id,
                name,
                phone: phone || null,
                email: email || null,
                contact_type: contactType,
                relationship: relationship || null
            };
            
            let error;
            if(id){
                ({error} = await db.from('emergency_contacts').update(contactData).eq('id', id));
            } else {
                ({error} = await db.from('emergency_contacts').insert(contactData));
            }
            
            if(error){
                alert('Error: ' + error.message);
            } else {
                closeEmergencyContactModal();
                await loadEmergencyContacts();
            }
        }
        
        async function deleteEmergencyContact(id){
            if(!confirm('Remove this emergency contact?')) return;
            const{error} = await db.from('emergency_contacts').delete().eq('id', id);
            if(error){
                alert('Error: ' + error.message);
            } else {
                await loadEmergencyContacts();
            }
        }
        
        // ICE Medical Information
        async function loadICEData(){
            if(!currentUser) return;
            
            // Load main ICE record
            const{data: iceData} = await db.from('user_medical').select('*').eq('user_id', currentUser.id).single();
            if(iceData){
                userICEData = iceData;
                document.getElementById('iceBloodType').value = iceData.blood_type || '';
                document.getElementById('iceContactName').value = iceData.ice_contact_name || '';
                document.getElementById('iceEmergencyNotes').value = iceData.emergency_notes || '';
                document.getElementById('shareICEInEmergency').checked = iceData.share_in_emergency || false;
            }
            
            // Load allergies
            const{data: allergies} = await db.from('user_allergies').select('*').eq('user_id', currentUser.id).order('severity', {ascending: false});
            userAllergies = allergies || [];
            renderICEAllergies();
            
            // Load medications
            const{data: meds} = await db.from('user_medications').select('*').eq('user_id', currentUser.id);
            userMedications = meds || [];
            renderICEMedications();
            
            // Load conditions
            const{data: conditions} = await db.from('user_conditions').select('*').eq('user_id', currentUser.id);
            userConditions = conditions || [];
            renderICEConditions();
        }
        
        function renderICEAllergies(){
            const div = document.getElementById('iceAllergiesList');
            if(userAllergies.length === 0){
                div.innerHTML = '<p style="color:var(--text-light);font-size:13px;">No allergies added</p>';
                return;
            }
            const severityColors = {mild: '#22c55e', moderate: '#f59e0b', severe: '#ef4444'};
            div.innerHTML = userAllergies.map(a => `
                <span style="display:inline-flex;align-items:center;gap:6px;background:${severityColors[a.severity]}22;border:1px solid ${severityColors[a.severity]};color:${severityColors[a.severity]};padding:4px 10px;border-radius:16px;margin:0 6px 6px 0;font-size:13px;">
                    ${a.severity === 'severe' ? 'âš ï¸ ' : ''}${a.allergy}
                    <button onclick="deleteICEAllergy('${a.id}')" style="background:none;border:none;cursor:pointer;font-size:14px;color:${severityColors[a.severity]};">Ã—</button>
                </span>
            `).join('');
        }
        
        function renderICEMedications(){
            const div = document.getElementById('iceMedicationsList');
            if(userMedications.length === 0){
                div.innerHTML = '<p style="color:var(--text-light);font-size:13px;">No medications added</p>';
                return;
            }
            div.innerHTML = userMedications.map(m => `
                <span style="display:inline-flex;align-items:center;gap:6px;background:#eff6ff;border:1px solid #3b82f6;color:#1d4ed8;padding:4px 10px;border-radius:16px;margin:0 6px 6px 0;font-size:13px;">
                    ğŸ’Š ${m.medication}${m.dosage ? ` (${m.dosage})` : ''}
                    <button onclick="deleteICEMedication('${m.id}')" style="background:none;border:none;cursor:pointer;font-size:14px;color:#1d4ed8;">Ã—</button>
                </span>
            `).join('');
        }
        
        function renderICEConditions(){
            const div = document.getElementById('iceConditionsList');
            if(userConditions.length === 0){
                div.innerHTML = '<p style="color:var(--text-light);font-size:13px;">No medical conditions added</p>';
                return;
            }
            div.innerHTML = userConditions.map(c => `
                <span style="display:inline-flex;align-items:center;gap:6px;background:#fef3c7;border:1px solid #f59e0b;color:#b45309;padding:4px 10px;border-radius:16px;margin:0 6px 6px 0;font-size:13px;">
                    ğŸ¥ ${c.condition}
                    <button onclick="deleteICECondition('${c.id}')" style="background:none;border:none;cursor:pointer;font-size:14px;color:#b45309;">Ã—</button>
                </span>
            `).join('');
        }
        
        async function addICEAllergy(){
            const allergy = document.getElementById('iceNewAllergy').value.trim();
            const severity = document.getElementById('iceNewAllergySeverity').value;
            if(!allergy) return;
            
            const{error} = await db.from('user_allergies').insert({
                user_id: currentUser.id,
                allergy,
                severity
            });
            
            if(error){
                alert('Error: ' + error.message);
            } else {
                document.getElementById('iceNewAllergy').value = '';
                await loadICEData();
            }
        }
        
        async function deleteICEAllergy(id){
            const{error} = await db.from('user_allergies').delete().eq('id', id);
            if(!error) await loadICEData();
        }
        
        async function addICEMedication(){
            const medication = document.getElementById('iceNewMedication').value.trim();
            const dosage = document.getElementById('iceNewMedicationDosage').value.trim();
            if(!medication) return;
            
            const{error} = await db.from('user_medications').insert({
                user_id: currentUser.id,
                medication,
                dosage: dosage || null
            });
            
            if(error){
                alert('Error: ' + error.message);
            } else {
                document.getElementById('iceNewMedication').value = '';
                document.getElementById('iceNewMedicationDosage').value = '';
                await loadICEData();
            }
        }
        
        async function deleteICEMedication(id){
            const{error} = await db.from('user_medications').delete().eq('id', id);
            if(!error) await loadICEData();
        }
        
        async function addICECondition(){
            const condition = document.getElementById('iceNewCondition').value.trim();
            if(!condition) return;
            
            const{error} = await db.from('user_conditions').insert({
                user_id: currentUser.id,
                condition
            });
            
            if(error){
                alert('Error: ' + error.message);
            } else {
                document.getElementById('iceNewCondition').value = '';
                await loadICEData();
            }
        }
        
        async function deleteICECondition(id){
            const{error} = await db.from('user_conditions').delete().eq('id', id);
            if(!error) await loadICEData();
        }
        
        async function saveICEData(){
            const iceData = {
                user_id: currentUser.id,
                blood_type: document.getElementById('iceBloodType').value || null,
                ice_contact_name: document.getElementById('iceContactName').value.trim() || null,
                emergency_notes: document.getElementById('iceEmergencyNotes').value.trim() || null,
                share_in_emergency: document.getElementById('shareICEInEmergency').checked,
                updated_at: new Date().toISOString()
            };
            
            // Upsert - insert or update
            const{data: existing} = await db.from('user_medical').select('id').eq('user_id', currentUser.id).single();
            
            let error;
            if(existing){
                ({error} = await db.from('user_medical').update(iceData).eq('user_id', currentUser.id));
            } else {
                ({error} = await db.from('user_medical').insert(iceData));
            }
            
            return !error;
        }
        
        // Availability
        async function loadAvailability(){
            if(!currentUser)return;
            const{data}=await db.from('user_availability').select('*').eq('user_id',currentUser.id).single();
            if(data){
                document.getElementById('availActive').checked=data.is_available;
                document.getElementById('availLocation').value=data.current_location_name||'';
                document.getElementById('availRadius').value=data.max_help_radius_km||50;
                document.getElementById('availStatusMessage').value=data.status_message||'Available';
                document.getElementById('canPickup').checked=data.can_pickup;
                document.getElementById('canGarage').checked=data.can_provide_garage;
                document.getElementById('canStay').checked=data.can_provide_accommodation;
                document.getElementById('canMeet').checked=data.can_meet_for_drinks;
                document.getElementById('canAdvice').checked=data.can_provide_local_advice;
                document.getElementById('canHelp').checked=data.can_provide_help;
                if(data.latitude&&data.longitude){
                    document.getElementById('availLat').value=data.latitude;
                    document.getElementById('availLng').value=data.longitude;
                    document.getElementById('availManualEntry').classList.remove('hidden');
                    renderGPSDisplay('avail',data.latitude,data.longitude);
                    availMap.setView([data.latitude,data.longitude],12);
                    if(availMarker)availMap.removeLayer(availMarker);
                    availMarker=L.marker([data.latitude,data.longitude]).addTo(availMap);
                    // Update other maps to user's current/availability location (overrides home)
                    updateMapsToUserLocation(data.latitude, data.longitude);
                }
            }
        }
        async function handleSaveAvailability(){
            if(!currentUser)return;
            const r=document.getElementById('availResult');
            r.innerHTML='<div class="alert alert-info">Saving...</div>';
            const lat=parseFloat(document.getElementById('availLat').value);
            const lng=parseFloat(document.getElementById('availLng').value);
            const d={
                user_id:currentUser.id,
                is_available:document.getElementById('availActive').checked,
                current_location_name:document.getElementById('availLocation').value,
                latitude:isNaN(lat)?null:lat,
                longitude:isNaN(lng)?null:lng,
                max_help_radius_km:parseInt(document.getElementById('availRadius').value)||50,
                status_message:document.getElementById('availStatusMessage').value,
                can_pickup:document.getElementById('canPickup').checked,
                can_provide_garage:document.getElementById('canGarage').checked,
                can_provide_accommodation:document.getElementById('canStay').checked,
                can_meet_for_drinks:document.getElementById('canMeet').checked,
                can_provide_local_advice:document.getElementById('canAdvice').checked,
                can_provide_help:document.getElementById('canHelp').checked,
                updated_at:new Date().toISOString()
            };
            const{error}=await db.from('user_availability').upsert(d,{onConflict:'user_id'});
            r.innerHTML=error?'<div class="alert alert-danger">âŒ '+error.message+'</div>':'<div class="alert alert-success">âœ… Saved!</div>';
        }
        
        // Travel/Hitchhiking
        let userTravelPlans = [];
        
        function setTravelMode(mode){
            document.querySelectorAll('input[name="travelMode"]').forEach(r=>{
                r.checked = r.value === mode;
                r.closest('.radio-item').classList.toggle('selected', r.checked);
            });
            // Show/hide driver-specific options
            const driverDetails = document.getElementById('travelOfferingDetails');
            if(driverDetails) driverDetails.style.display = mode === 'offering' ? 'block' : 'none';
        }
        
        function getTravelLocation(point, source){
            if(source === 'home'){
                let lat = userProfile?.home_latitude || parseFloat(document.getElementById('profileHomeLat')?.value);
                let lng = userProfile?.home_longitude || parseFloat(document.getElementById('profileHomeLng')?.value);
                if(!lat || !lng || isNaN(lat) || isNaN(lng)){
                    alert('Home location not set. Please set your Home Location in your Profile first.');
                    return;
                }
                document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lat`).value = lat;
                document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lng`).value = lng;
                document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}`).value = `${userProfile?.city||''}, ${userProfile?.country||''}`.replace(/^,\s*|,\s*$/g,'').trim();
            } else if(source === 'gps'){
                if(!navigator.geolocation){
                    alert('Geolocation not supported');
                    return;
                }
                navigator.geolocation.getCurrentPosition(p=>{
                    document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lat`).value = p.coords.latitude.toFixed(6);
                    document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lng`).value = p.coords.longitude.toFixed(6);
                }, e=>alert('Error: '+e.message), {enableHighAccuracy:true});
            }
        }
        
        async function geocodeTravelLocation(point){
            const locationName = document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}`).value;
            if(!locationName || locationName.trim().length < 2){
                alert('Enter a location name first');
                return;
            }
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`, {
                    headers: { 'User-Agent': 'Obonato App' }
                });
                const data = await response.json();
                if(data && data.length > 0){
                    document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lat`).value = parseFloat(data[0].lat).toFixed(6);
                    document.getElementById(`travel${point.charAt(0).toUpperCase()+point.slice(1)}Lng`).value = parseFloat(data[0].lon).toFixed(6);
                } else {
                    alert('Location not found. Try a more specific name.');
                }
            } catch(e){
                console.error('Geocode error:', e);
                alert('Error looking up location');
            }
        }
        
        async function handleSaveTravel(){
            if(!currentUser)return;
            const r = document.getElementById('travelResult');
            r.innerHTML = '<div class="alert alert-info">Saving travel plan...</div>';
            
            const fromLat = parseFloat(document.getElementById('travelFromLat').value);
            const fromLng = parseFloat(document.getElementById('travelFromLng').value);
            const toLat = parseFloat(document.getElementById('travelToLat').value);
            const toLng = parseFloat(document.getElementById('travelToLng').value);
            const travelDate = document.getElementById('travelDate').value;
            
            if(!document.getElementById('travelFrom').value || !document.getElementById('travelTo').value){
                r.innerHTML = '<div class="alert alert-danger">Please enter both origin and destination</div>';
                return;
            }
            if(!travelDate){
                r.innerHTML = '<div class="alert alert-danger">Please select a travel date</div>';
                return;
            }
            
            const d = {
                user_id: currentUser.id,
                travel_mode: document.querySelector('input[name="travelMode"]:checked')?.value || 'seeking',
                from_location_name: document.getElementById('travelFrom').value,
                from_latitude: isNaN(fromLat) ? null : fromLat,
                from_longitude: isNaN(fromLng) ? null : fromLng,
                to_location_name: document.getElementById('travelTo').value,
                to_latitude: isNaN(toLat) ? null : toLat,
                to_longitude: isNaN(toLng) ? null : toLng,
                travel_date: travelDate,
                travel_time: document.getElementById('travelTime').value || null,
                flexibility_hours: parseInt(document.getElementById('travelFlex').value) || 2,
                available_seats: document.querySelector('input[name="travelMode"]:checked')?.value === 'offering' ? parseInt(document.getElementById('travelSeats').value) : null,
                luggage_space: document.querySelector('input[name="travelMode"]:checked')?.value === 'offering' ? document.getElementById('travelLuggage').value : null,
                cost_sharing: document.querySelector('input[name="travelMode"]:checked')?.value === 'offering' ? document.getElementById('travelCost').value : null,
                notes: document.getElementById('travelNotes').value,
                is_recurring: document.getElementById('travelRecurring').checked,
                accepts_detours: document.getElementById('travelWaypoints').checked,
                status: 'active',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const{error} = await db.from('travel_plans').insert(d);
            if(error){
                r.innerHTML = '<div class="alert alert-danger">âŒ ' + error.message + '</div>';
            } else {
                r.innerHTML = '<div class="alert alert-success">âœ… Travel plan posted!</div>';
                await loadMyTravelPlans();
                // Clear form
                document.getElementById('travelFrom').value = '';
                document.getElementById('travelTo').value = '';
                document.getElementById('travelFromLat').value = '';
                document.getElementById('travelFromLng').value = '';
                document.getElementById('travelToLat').value = '';
                document.getElementById('travelToLng').value = '';
                document.getElementById('travelNotes').value = '';
            }
        }
        
        async function loadMyTravelPlans(){
            if(!currentUser)return;
            const div = document.getElementById('myTravelPlans');
            const{data, error} = await db.from('travel_plans').select('*').eq('user_id', currentUser.id).order('travel_date', {ascending: true});
            
            if(error){
                div.innerHTML = '<div class="alert alert-danger">Error loading travel plans</div>';
                return;
            }
            
            userTravelPlans = data || [];
            
            if(userTravelPlans.length === 0){
                div.innerHTML = '<p style="color:var(--text-light)">No active travel plans. Create one above!</p>';
                return;
            }
            
            const modeIcons = {offering: 'ğŸš—', seeking: 'ğŸ‘', companion: 'ğŸ¤'};
            div.innerHTML = userTravelPlans.map(t => {
                const dateStr = new Date(t.travel_date).toLocaleDateString('en-NZ', {weekday:'short', day:'numeric', month:'short'});
                const timeStr = t.travel_time ? ` at ${t.travel_time}` : '';
                const flexStr = t.flexibility_hours > 0 ? ` (Â±${t.flexibility_hours}h)` : '';
                return `
                <div class="request-card" style="margin-bottom: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 12px;">
                        <div>
                            <span style="font-size: 24px;">${modeIcons[t.travel_mode] || 'ğŸš—'}</span>
                            <span class="severity-badge severity-${t.status === 'active' ? 'low' : 'medium'}" style="margin-left: 8px;">${t.status}</span>
                        </div>
                        <button class="btn btn-danger btn-xs" onclick="deleteTravelPlan('${t.id}')">ğŸ—‘ï¸ Delete</button>
                    </div>
                    <h4 style="margin: 0 0 8px;">ğŸ…°ï¸ ${t.from_location_name} â†’ ğŸ…±ï¸ ${t.to_location_name}</h4>
                    <p style="color: var(--text-light); margin: 0;">ğŸ“… ${dateStr}${timeStr}${flexStr}</p>
                    ${t.notes ? `<p style="color: var(--text-light); margin-top: 8px; font-size: 13px;">${t.notes}</p>` : ''}
                </div>`;
            }).join('');
        }
        
        async function deleteTravelPlan(id){
            if(!confirm('Delete this travel plan?')) return;
            const{error} = await db.from('travel_plans').delete().eq('id', id);
            if(error) alert('Error: ' + error.message);
            else await loadMyTravelPlans();
        }
        
        async function handleSearchTravel(){
            const div = document.getElementById('travelSearchResults');
            div.innerHTML = '<p class="loading">ğŸ” Searching...</p>';
            
            const location = document.getElementById('searchTravelLocation').value;
            const fromDate = document.getElementById('searchTravelFrom').value;
            const toDate = document.getElementById('searchTravelTo').value;
            
            let query = db.from('travel_plans').select('*, profiles(id, email, gender)').eq('status', 'active').neq('user_id', currentUser.id);
            
            if(fromDate) query = query.gte('travel_date', fromDate);
            if(toDate) query = query.lte('travel_date', toDate);
            
            // Filter by travel mode
            const modes = [];
            if(document.getElementById('searchOffering').checked) modes.push('offering');
            if(document.getElementById('searchSeeking').checked) modes.push('seeking');
            if(document.getElementById('searchCompanions').checked) modes.push('companion');
            if(modes.length > 0 && modes.length < 3) query = query.in('travel_mode', modes);
            
            const{data, error} = await query.order('travel_date', {ascending: true}).limit(20);
            
            if(error){
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                return;
            }
            
            if(!data || data.length === 0){
                div.innerHTML = '<div class="alert alert-info">No matching travel plans found. Try adjusting your search criteria.</div>';
                return;
            }
            
            // Apply gender preference filter if set
            const hitchPref = userProfile?.pref_hitch_gender || 'any';
            const myGender = userProfile?.gender;
            
            const filtered = data.filter(t => {
                if(hitchPref === 'any') return true;
                const theirGender = t.profiles?.gender;
                if(!theirGender) return true; // Don't filter out unknown genders
                if(hitchPref === 'same') return theirGender === myGender;
                return theirGender === hitchPref;
            });
            
            if(filtered.length === 0){
                div.innerHTML = '<div class="alert alert-info">No travelers matching your gender preferences. Try adjusting filters.</div>';
                return;
            }
            
            const modeIcons = {offering: 'ğŸš— Offering ride', seeking: 'ğŸ‘ Seeking ride', companion: 'ğŸ¤ Seeking companion'};
            div.innerHTML = `<h4>${filtered.length} traveler(s) found</h4>` + filtered.map(t => {
                const e = t.user_id || 'unknown';
                const dn = generateAnonymousName(e);
                const av = generateAvatarData(e);
                const dateStr = new Date(t.travel_date).toLocaleDateString('en-NZ', {weekday:'short', day:'numeric', month:'short'});
                const timeStr = t.travel_time ? ` at ${t.travel_time}` : '';
                const flexStr = t.flexibility_hours > 0 ? ` (Â±${t.flexibility_hours}h)` : '';
                return `
                <div class="request-card" style="margin-bottom: 16px;">
                    <div class="request-user">
                        <div class="request-avatar" style="background:${av.color}">${av.icon}</div>
                        <div class="request-info">
                            <h4>${dn}</h4>
                            <p>${modeIcons[t.travel_mode] || t.travel_mode}</p>
                        </div>
                    </div>
                    <div style="margin: 12px 0;">
                        <p style="font-weight: 600;">ğŸ…°ï¸ ${t.from_location_name} â†’ ğŸ…±ï¸ ${t.to_location_name}</p>
                        <p style="color: var(--text-light);">ğŸ“… ${dateStr}${timeStr}${flexStr}</p>
                        ${t.available_seats ? `<p style="color: var(--text-light);">ğŸ’º ${t.available_seats} seat(s) available</p>` : ''}
                    </div>
                    ${t.notes ? `<p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">${t.notes}</p>` : ''}
                    <button class="btn btn-primary btn-sm" onclick="contactTraveler('${t.profiles?.id}', '${dn}')">ğŸ“¨ Contact</button>
                </div>`;
            }).join('');
        }
        
        function contactTraveler(userId, displayName){
            // Open contact modal or create interaction
            alert(`Contact feature coming soon! You want to reach: ${displayName}`);
            // TODO: Implement proper contact/messaging
        }
        
        // Dashboard
        let dashboardMarkers = [];
        
        async function refreshDashboard(){
            const btn = document.getElementById('refreshDashboardBtn');
            btn.textContent = 'â³ Loading...';
            btn.disabled = true;
            try {
                await loadDashboard();
                await checkPendingFeedback();
                btn.textContent = 'âœ… Done!';
                setTimeout(() => { btn.textContent = 'ğŸ”„ Refresh'; btn.disabled = false; }, 1500);
            } catch(e) {
                console.error('Dashboard refresh error:', e);
                btn.textContent = 'âŒ Error';
                setTimeout(() => { btn.textContent = 'ğŸ”„ Refresh'; btn.disabled = false; }, 2000);
            }
        }
        
        async function loadDashboard(){
            if(!currentUser) {
                console.log('loadDashboard: No current user');
                return;
            }
            console.log('loadDashboard: Starting...');
            
            const{data:avail, error:availError}=await db.from('user_availability').select('*').eq('user_id',currentUser.id).single();
            console.log('loadDashboard: My availability:', avail, 'Error:', availError);
            
            // Clear existing markers
            dashboardMarkers.forEach(m=>dashboardMap.removeLayer(m));
            dashboardMarkers=[];
            
            if(avail&&avail.latitude){
                dashboardMap.setView([avail.latitude,avail.longitude],11);
                
                // Add user's avatar marker
                const myAv = generateAvatarData(currentUser.email);
                const userMarker = L.marker([avail.latitude,avail.longitude],{
                    icon: L.divIcon({
                        className:'',
                        html:`<div style="background:${myAv.color};color:white;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)">${myAv.icon}</div>`,
                        iconAnchor:[22,22]
                    })
                }).addTo(dashboardMap);
                userMarker.bindPopup('<strong>You</strong>');
                dashboardMarkers.push(userMarker);
            } else {
                console.log('loadDashboard: No availability location set');
            }
            
            await loadPeopleImHelping();
            await loadNearbyRequests(avail);
            await loadNearbyTravelers(avail);
            await loadDashboardStats();
            console.log('loadDashboard: Complete');
        }
        
        // Load active interactions where I'm the helper
        async function loadPeopleImHelping(){
            const section = document.getElementById('helpingSection');
            const list = document.getElementById('helpingList');
            
            console.log('loadPeopleImHelping: Checking for active help...');
            
            // Get interactions where I'm helper and status is accepted (not completed)
            const{data: interactions, error} = await db.from('interactions')
                .select('*, sos_alerts(id, alert_type, description, latitude, longitude, created_at)')
                .eq('helper_id', currentUser.id)
                .eq('status', 'accepted')
                .order('created_at', {ascending: false});
            
            console.log('loadPeopleImHelping: Found', interactions?.length || 0, 'active interactions', error ? 'Error: ' + error.message : '');
            
            if(error || !interactions || interactions.length === 0){
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            
            list.innerHTML = interactions.map(i => {
                const av = generateAvatarData(i.requester_id);
                const name = generateAnonymousName(i.requester_id);
                const sos = i.sos_alerts;
                const typeIcons = {breakdown:'ğŸ”§', accident:'ğŸ’¥', medical:'ğŸ¥', stuck:'ğŸš™', fuel:'â›½', unsafe:'âš ï¸', emergency:'ğŸš¨', directions:'ğŸ—ºï¸', meetup:'ğŸº', other:'â“'};
                const icon = typeIcons[sos?.alert_type] || 'â“';
                
                const mapsUrl = sos?.latitude && sos?.longitude 
                    ? `https://maps.google.com/?q=${sos.latitude},${sos.longitude}&navigate=yes` 
                    : '';
                
                const timeAgo = sos?.created_at ? formatMessageTime(sos.created_at) : '';
                
                return `
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:white;border-radius:12px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                    <div style="width:48px;height:48px;border-radius:50%;background:${av.color};display:flex;align-items:center;justify-content:center;font-size:22px;color:white;flex-shrink:0;">${av.icon}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;font-size:14px;">${icon} ${name}</div>
                        <div style="font-size:12px;color:var(--text-light);margin-top:2px;">${sos?.description || sos?.alert_type || 'Help request'}</div>
                        <div style="font-size:11px;color:var(--text-light);margin-top:2px;">ğŸ• ${timeAgo}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        ${mapsUrl ? `<a href="${mapsUrl}" target="_blank" class="btn btn-primary btn-sm" style="font-size:11px;padding:6px 10px;">ğŸ—ºï¸ Navigate</a>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="openUniversalChat('${i.requester_id}','${name}',{type:'sos',id:'${sos?.id}',label:'${sos?.alert_type}'})" style="font-size:11px;padding:6px 10px;">ğŸ’¬ Message</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function loadNearbyRequests(avail){
            const div=document.getElementById('nearbyRequests');
            if(!avail||!avail.latitude){
                div.innerHTML='<p style="color:var(--text-light)">Set your location in Availability first.</p>';
                document.getElementById('statNearbyRequests').textContent = 0;
                return;
            }
            
            console.log('loadNearbyRequests: Fetching SOS alerts...');
            // Include gender from profiles for filtering, fetch both active and help_coming statuses
            const{data:reqs, error}=await db.from('sos_alerts').select('*, requester:profiles!sos_alerts_user_id_fkey(id, gender)').in('status', ['active', 'help_coming']);
            console.log('loadNearbyRequests: Found', reqs?.length || 0, 'alerts. Error:', error);
            
            if(error){
                div.innerHTML=`<p style="color:var(--danger)">Error: ${error.message}</p>`;
                return;
            }
            
            // Get user's SOS gender preference
            const prefSOS = userProfile?.pref_sos_gender || 'any';
            const userGender = userProfile?.gender;
            
            const nearby=(reqs||[]).filter(r=>{
                if(!r.latitude) {
                    console.log('loadNearbyRequests: Alert missing coords:', r.id);
                    return false;
                }
                r.distance=getDistance(avail.latitude,avail.longitude,r.latitude,r.longitude);
                const inRange = r.distance<=(avail.max_help_radius_km||50);
                console.log(`loadNearbyRequests: Alert ${r.id} is ${r.distance.toFixed(1)}km away, radius=${avail.max_help_radius_km}, inRange=${inRange}`);
                if(!inRange) return false;
                
                // Apply gender preference filter (same gender preferred for SOS)
                // Note: 'same' means preferred, not required for SOS - still show but could sort
                return true;
            });
            
            // Sort: Critical/Emergency first, then by severity, then by distance
            const severityOrder = {critical: 0, high: 1, medium: 2, low: 3};
            nearby.sort((a,b) => {
                // Emergency type always first
                if(a.alert_type === 'emergency' && b.alert_type !== 'emergency') return -1;
                if(b.alert_type === 'emergency' && a.alert_type !== 'emergency') return 1;
                // Then by severity
                if(severityOrder[a.severity] !== severityOrder[b.severity]) {
                    return severityOrder[a.severity] - severityOrder[b.severity];
                }
                // Then by distance
                return a.distance - b.distance;
            });
            
            console.log('loadNearbyRequests: Nearby alerts:', nearby.length);
            document.getElementById('statNearbyRequests').textContent=nearby.length;
            
            // Update SOS tab pulse based on most critical nearby request
            updateSOSTabPulse(nearby);
            
            // Store for filtering
            window.nearbySOSRequests = nearby;
            
            if(!nearby.length){
                div.innerHTML='<p style="color:var(--text-light)">No requests nearby. ğŸ‰</p>';
                return;
            }
            
            // Add SOS markers to dashboard map
            nearby.forEach(r=>{
                const e=r.user_id||'unknown';
                const av=generateAvatarData(e);
                const m=L.marker([r.latitude,r.longitude],{
                    icon:L.divIcon({
                        className:'',
                        html:`<div style="background:#ef4444;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3)">ğŸ†˜</div>`,
                        iconAnchor:[18,18]
                    })
                }).addTo(dashboardMap);
                m.bindPopup(`<strong>SOS: ${r.alert_type}</strong><br>ğŸ“ ${r.distance.toFixed(1)} km`);
                dashboardMarkers.push(m);
            });
            
            renderNearbyRequests(nearby, 'all');
        }
        
        function renderNearbyRequests(requests, filter){
            const div = document.getElementById('nearbyRequests');
            const typeIcons = {breakdown:'ğŸ”§', accident:'ğŸ’¥', medical:'ğŸ¥', stuck:'ğŸš™', fuel:'â›½', unsafe:'âš ï¸', emergency:'ğŸš¨', directions:'ğŸ—ºï¸', meetup:'ğŸº', other:'â“'};
            
            // Filter requests
            let filtered = requests;
            if(filter !== 'all'){
                filtered = requests.filter(r => r.alert_type === filter);
            }
            
            // Get unique types for filter buttons
            const types = [...new Set(requests.map(r => r.alert_type))];
            
            const filterButtons = `
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
                    <button class="btn btn-sm ${filter==='all'?'btn-primary':'btn-secondary'}" onclick="renderNearbyRequests(window.nearbySOSRequests,'all')" style="padding:4px 10px;font-size:12px;">All (${requests.length})</button>
                    ${types.map(t => `<button class="btn btn-sm ${filter===t?'btn-primary':'btn-secondary'}" onclick="renderNearbyRequests(window.nearbySOSRequests,'${t}')" style="padding:4px 10px;font-size:12px;">${typeIcons[t]||'â“'} ${filtered.filter(r=>r.alert_type===t).length || requests.filter(r=>r.alert_type===t).length}</button>`).join('')}
                </div>`;
            
            const cards = filtered.map(r=>{
                const e=r.user_id||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);
                const isUrgent = r.severity === 'critical' || r.alert_type === 'emergency';
                const isHigh = r.severity === 'high';
                const helpComing = r.status === 'help_coming';
                
                // Format timestamp in user's local timezone
                const created = new Date(r.created_at);
                const now = new Date();
                const diffMins = Math.floor((now - created) / 60000);
                let timeAgo;
                if(diffMins < 1) timeAgo = 'Just now';
                else if(diffMins < 60) timeAgo = `${diffMins}m ago`;
                else if(diffMins < 1440) timeAgo = `${Math.floor(diffMins/60)}h ago`;
                else timeAgo = created.toLocaleDateString('en-NZ', {day:'numeric', month:'short'});
                
                // Different styling if help is already coming
                let borderColor, bgColor;
                if(helpComing){
                    borderColor = '#22c55e'; // Green
                    bgColor = '#f0fdf4';     // Light green
                } else if(isUrgent){
                    borderColor = 'var(--danger)';
                    bgColor = '#fef2f2';
                } else if(isHigh){
                    borderColor = '#f97316';
                    bgColor = '#fff7ed';
                } else {
                    borderColor = 'var(--border)';
                    bgColor = 'white';
                }
                
                // Status badge
                const statusBadge = helpComing 
                    ? `<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:8px;font-size:10px;margin-left:6px;">ğŸš— Help coming</span>`
                    : '';
                
                // Button changes based on status
                const actionButton = helpComing
                    ? `<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();openRespondModal('${r.id}','${dn}','${r.alert_type}')" style="padding:6px 10px;font-size:12px;flex-shrink:0;" title="Someone is already responding, but you can also help">+Help</button>`
                    : `<button class="btn btn-success btn-sm" onclick="event.stopPropagation();openRespondModal('${r.id}','${dn}','${r.alert_type}')" style="padding:6px 10px;font-size:12px;flex-shrink:0;">Help</button>`;
                
                return `
                <div onclick="openViewRequestModal('${r.id}')" style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border-left:3px solid ${borderColor};background:${bgColor};margin-bottom:8px;cursor:pointer;transition:transform 0.1s, box-shadow 0.1s;" onmouseover="this.style.transform='translateX(4px)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                    <div style="width:36px;height:36px;border-radius:50%;background:${av.color};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">${av.icon}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
                            <span style="font-weight:600;font-size:13px;">${typeIcons[r.alert_type]||'â“'} ${dn}${statusBadge}</span>
                            <span style="font-size:11px;color:var(--text-light);">ğŸ“${r.distance.toFixed(1)}km</span>
                        </div>
                        <p style="margin:2px 0 0;font-size:12px;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.description||r.alert_type}</p>
                        <p style="margin:2px 0 0;font-size:10px;color:var(--text-light);">ğŸ• ${timeAgo}</p>
                    </div>
                    ${actionButton}
                </div>`;
            }).join('');
            
            div.innerHTML = filterButtons + 
                `<div style="max-height:calc(100vh - 400px);min-height:300px;overflow-y:auto;padding-right:4px;">
                    ${filtered.length ? cards : '<p style="color:var(--text-light);text-align:center;padding:20px;">No requests match this filter.</p>'}
                </div>`;
        }
        
        async function loadNearbyTravelers(avail){
            const div=document.getElementById('nearbyTravelers');
            if(!avail||!avail.latitude){
                div.innerHTML='<p style="color:var(--text-light)">Set location first.</p>';
                document.getElementById('statNearbyTravelers').textContent = 0;
                return;
            }
            
            console.log('loadNearbyTravelers: Fetching...');
            // Get travelers with their profile data for gender filtering
            const{data:travelers, error}=await db.from('user_availability').select('*, profiles(id, gender)').eq('is_available',true).neq('user_id',currentUser.id);
            console.log('loadNearbyTravelers: Found', travelers?.length || 0, 'available users. Error:', error);
            
            if(error){
                div.innerHTML=`<p style="color:var(--danger)">Error: ${error.message}</p>`;
                return;
            }
            
            // Get user's gender preferences
            const prefMeetup = userProfile?.pref_meetup_gender || 'any';
            const userGender = userProfile?.gender;
            
            let nearby=(travelers||[]).filter(t=>{
                if(!t.latitude) return false;
                t.distance=getDistance(avail.latitude,avail.longitude,t.latitude,t.longitude);
                if(t.distance > (avail.max_help_radius_km||50)) return false;
                
                // Apply gender preference filter for meetups
                if(prefMeetup === 'same' && userGender && t.profiles?.gender){
                    if(t.profiles.gender !== userGender) return false;
                }
                return true;
            }).sort((a,b)=>a.distance-b.distance);
            
            console.log('loadNearbyTravelers: Nearby:', nearby.length);
            document.getElementById('statNearbyTravelers').textContent=nearby.length;
            
            // Store for potential filtering
            window.nearbyTravelers = nearby;
            
            // Add traveler markers to dashboard map
            nearby.forEach(t=>{
                const e=t.user_id||'unknown';
                const dn=generateAnonymousName(e);
                const av=generateAvatarData(e);
                
                // Build services list for popup
                const services = [];
                if(t.can_pickup) services.push('ğŸš—');
                if(t.can_provide_garage) services.push('ğŸ”§');
                if(t.can_provide_accommodation) services.push('ğŸ ');
                if(t.can_meet_for_drinks) services.push('ğŸº');
                if(t.can_provide_local_advice) services.push('ğŸ’¡');
                if(t.can_provide_help) services.push('ğŸ¤');
                const servicesHtml = services.length ? `<div style="font-size:11px;margin:4px 0;">${services.join(' ')}</div>` : '';
                const statusText = t.status_message || 'Available';
                
                const m=L.marker([t.latitude,t.longitude],{
                    icon:L.divIcon({
                        className:'',
                        html:`<div style="background:${av.color};color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25)">${av.icon}</div>`,
                        iconAnchor:[18,18]
                    })
                }).addTo(dashboardMap);
                m.bindPopup(`<strong>${dn}</strong><br>ğŸ“ ${t.distance.toFixed(1)} km${servicesHtml}<div style="background:#22c55e;color:white;padding:2px 6px;border-radius:8px;font-size:10px;display:inline-block;">âœ“ ${statusText}</div>`);
                dashboardMarkers.push(m);
            });
            
            if(!nearby.length){
                div.innerHTML='<p style="color:var(--text-light)">No travelers nearby.</p>';
                return;
            }
            
            // Compact scrollable format matching alerts
            div.innerHTML = `<div style="max-height:calc(100vh - 500px);min-height:200px;overflow-y:auto;padding-right:4px;">` +
                nearby.map(t=>{
                    const e=t.user_id||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);
                    const services = [];
                    if(t.can_pickup) services.push('ğŸš—');
                    if(t.can_provide_garage) services.push('ğŸ”§');
                    if(t.can_provide_accommodation) services.push('ğŸ ');
                    if(t.can_meet_for_drinks) services.push('ğŸº');
                    if(t.can_provide_local_advice) services.push('ğŸ’¡');
                    if(t.can_provide_help) services.push('ğŸ¤');
                    const statusText = t.status_message || 'Available';
                    
                    // Calculate last active time
                    const lastUpdate = t.updated_at ? new Date(t.updated_at) : null;
                    let lastActive = '';
                    if(lastUpdate){
                        const now = new Date();
                        const diffMins = Math.floor((now - lastUpdate) / 60000);
                        if(diffMins < 5) lastActive = 'ğŸŸ¢ Active now';
                        else if(diffMins < 60) lastActive = `ğŸŸ¢ ${diffMins}m ago`;
                        else if(diffMins < 1440) lastActive = `ğŸŸ¡ ${Math.floor(diffMins/60)}h ago`;
                        else if(diffMins < 10080) lastActive = `ğŸŸ  ${Math.floor(diffMins/1440)}d ago`;
                        else lastActive = `âšª ${lastUpdate.toLocaleDateString('en-NZ', {day:'numeric', month:'short'})}`;
                    }
                    
                    return `
                    <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border-left:3px solid ${av.color};background:white;margin-bottom:8px;">
                        <div style="width:36px;height:36px;border-radius:50%;background:${av.color};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;color:white;">${av.icon}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <span style="font-weight:600;font-size:13px;">${dn}</span>
                                <span style="font-size:11px;color:var(--text-light);">ğŸ“${t.distance.toFixed(1)}km</span>
                            </div>
                            <p style="margin:2px 0 0;font-size:11px;color:var(--text-light);">${statusText} ${services.length ? 'â€¢ ' + services.join('') : ''}</p>
                            ${lastActive ? `<p style="margin:2px 0 0;font-size:10px;color:var(--text-light);">${lastActive}</p>` : ''}
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="messageNearbyTraveler('${e}','${dn}')" style="padding:6px 10px;font-size:12px;flex-shrink:0;">ğŸ’¬</button>
                    </div>`;
                }).join('') + `</div>`;
        }
        async function loadDashboardStats(){const{count}=await db.from('interactions').select('*',{count:'exact',head:true}).eq('helper_id',currentUser.id).eq('status','completed');document.getElementById('statHelpGiven').textContent=count||0;const{data}=await db.from('interactions').select('*').or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`).eq('status','completed');const pending=(data||[]).filter(i=>(i.requester_id===currentUser.id&&!i.requester_feedback_given)||(i.helper_id===currentUser.id&&!i.helper_feedback_given));document.getElementById('statPendingFeedback').textContent=pending.length}
        
        // Search Helpers
        async function handleSearchHelpers(){
            const r=document.getElementById('helperResults');
            r.innerHTML='<p class="loading">ğŸ” Searching...</p>';
            const lat=parseFloat(document.getElementById('searchLat').value);
            const lng=parseFloat(document.getElementById('searchLng').value);
            const radius=parseInt(document.getElementById('searchRadius').value)||50;
            
            if(isNaN(lat)||isNaN(lng)){
                r.innerHTML='<div class="alert alert-danger">Get location first</div>';
                return;
            }
            
            markers.forEach(m=>helpersMap.removeLayer(m));
            markers=[];
            
            // User's avatar marker (like Waze)
            const myAv = generateAvatarData(currentUser.email);
            const userMarker = L.marker([lat,lng],{
                icon: L.divIcon({
                    className:'',
                    html:`<div style="background:${myAv.color};color:white;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)">${myAv.icon}</div>`,
                    iconAnchor:[22,22]
                })
            }).addTo(helpersMap);
            userMarker.bindPopup('<strong>You</strong>');
            markers.push(userMarker);
            
            let q=db.from('user_availability').select('*, profiles(id, gender)').eq('is_available',true).neq('user_id',currentUser.id);
            if(document.getElementById('needPickup').checked)q=q.eq('can_pickup',true);
            if(document.getElementById('needGarage').checked)q=q.eq('can_provide_garage',true);
            if(document.getElementById('needStay').checked)q=q.eq('can_provide_accommodation',true);
            if(document.getElementById('needMeet').checked)q=q.eq('can_meet_for_drinks',true);
            if(document.getElementById('needAdvice').checked)q=q.eq('can_provide_local_advice',true);
            if(document.getElementById('needHelp').checked)q=q.eq('can_provide_help',true);
            
            const{data,error}=await q;
            if(error){
                r.innerHTML='<div class="alert alert-danger">'+error.message+'</div>';
                return;
            }
            
            // Get user's gender preferences
            const prefMeetup = userProfile?.pref_meetup_gender || 'any';
            const userGender = userProfile?.gender;
            const needsMeetup = document.getElementById('needMeet').checked;
            
            currentHelpers=(data||[]).filter(h=>{
                if(!h.latitude)return false;
                h.distance=getDistance(lat,lng,h.latitude,h.longitude);
                if(h.distance > radius) return false;
                
                // Apply gender filter if searching for meetup and preference is same gender only
                if(needsMeetup && prefMeetup === 'same' && userGender && h.profiles?.gender){
                    if(h.profiles.gender !== userGender) return false;
                }
                return true;
            }).sort((a,b)=>a.distance-b.distance);
            
            if(!currentHelpers.length){
                r.innerHTML='<div class="alert alert-info">No helpers found.</div>';
                return;
            }
            
            currentHelpers.forEach((h,i)=>{
                const e=h.user_id||'unknown';
                const dn=generateAnonymousName(e);
                const av=generateAvatarData(e);
                
                // Build services list
                const services = [];
                if(h.can_pickup) services.push('ğŸš— Pickup');
                if(h.can_provide_garage) services.push('ğŸ”§ Garage');
                if(h.can_provide_accommodation) services.push('ğŸ  Stay');
                if(h.can_meet_for_drinks) services.push('ğŸº Meetup');
                if(h.can_provide_local_advice) services.push('ğŸ’¡ Advice');
                if(h.can_provide_help) services.push('ğŸ¤ Help');
                const servicesHtml = services.length ? `<div style="font-size:11px;color:#666;margin:4px 0;">${services.join(' â€¢ ')}</div>` : '';
                
                // Status badge
                const statusText = h.status_message || 'Available';
                const statusHtml = `<div style="background:#22c55e;color:white;padding:2px 8px;border-radius:10px;font-size:11px;display:inline-block;margin-top:4px;">âœ“ ${statusText}</div>`;
                
                const m=L.marker([h.latitude,h.longitude],{
                    icon:L.divIcon({
                        className:'',
                        html:`<div style="background:${av.color};color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25)">${av.icon}</div>`,
                        iconAnchor:[20,20]
                    })
                }).addTo(helpersMap);
                m.bindPopup(`
                    <div style="min-width:180px;">
                        <strong>${dn}</strong><br>
                        ğŸ“ ${h.distance.toFixed(1)} km away
                        ${servicesHtml}
                        ${statusHtml}
                        <br><button onclick="openContactModal(${i})" style="margin-top:8px;padding:8px 16px;background:#1F4788;color:white;border:none;border-radius:8px;cursor:pointer;width:100%">ğŸ“¨ Contact</button>
                    </div>
                `);
                markers.push(m);
            });
            
            helpersMap.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
            r.innerHTML=`<h4>${currentHelpers.length} helper(s)</h4>`+currentHelpers.map((h,i)=>{
                const e=h.user_id||'unknown';
                const dn=generateAnonymousName(e);
                const av=generateAvatarData(e);
                const services = [];
                if(h.can_pickup) services.push('ğŸš—');
                if(h.can_provide_garage) services.push('ğŸ”§');
                if(h.can_provide_accommodation) services.push('ğŸ ');
                if(h.can_meet_for_drinks) services.push('ğŸº');
                if(h.can_provide_local_advice) services.push('ğŸ’¡');
                if(h.can_provide_help) services.push('ğŸ¤');
                return`<div class="request-card" onclick="focusHelper(${i})" style="cursor:pointer">
                    <div class="request-user">
                        <div class="request-avatar" style="background:${av.color}">${av.icon}</div>
                        <div class="request-info">
                            <h4>${dn}</h4>
                            <p>ğŸ“ ${h.distance.toFixed(1)} km ${services.length ? 'â€¢ ' + services.join('') : ''}</p>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openContactModal(${i})">ğŸ“¨</button>
                </div>`;
            }).join('');
        }
        function focusHelper(i){const h=currentHelpers[i];helpersMap.setView([h.latitude,h.longitude],14);markers[i+1].openPopup()}
        
        // Contact & Respond
        function openContactModal(i){selectedHelper=currentHelpers[i];const e=selectedHelper.user_id||'unknown',dn=generateAnonymousName(e),av=generateAvatarData(e);document.getElementById('contactHelperInfo').innerHTML=`<div style="text-align:center;padding:20px;background:var(--bg);border-radius:12px;margin-bottom:20px"><div style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;margin:0 auto 12px;background:${av.color}">${av.icon}</div><h3>${dn}</h3><p style="color:var(--text-light)">ğŸ“ ${selectedHelper.distance.toFixed(1)} km</p></div>`;document.getElementById('contactModal').classList.add('active')}
        function closeContactModal(){document.getElementById('contactModal').classList.remove('active');selectedHelper=null}
        async function sendContactRequest(){if(!currentUser||!selectedHelper)return;const{error}=await db.from('interactions').insert({requester_id:currentUser.id,helper_id:selectedHelper.profiles.id,interaction_type:document.getElementById('contactType').value,status:'pending',notes:document.getElementById('contactMessage').value});if(error)alert('Error: '+error.message);else{alert('âœ… Sent!');closeContactModal();document.getElementById('contactMessage').value=''}}
        
        function openRespondModal(id,name,type,requesterId){
            console.log('openRespondModal: SOS ID =', id, 'Name =', name, 'Type =', type);
            currentRespondRequest={id,name,type,requesterId};
            document.getElementById('respondRequestInfo').innerHTML=`<div style="background:var(--bg);padding:20px;border-radius:12px;margin-bottom:20px"><h4 style="margin:0 0 8px;border:none;padding:0">Helping: ${name}</h4><p style="margin:0;color:var(--text-light)">${type}</p></div>`;
            // Reset modal state
            document.getElementById('respondPhotoReveal').classList.add('hidden');
            document.getElementById('respondFormSection').classList.remove('hidden');
            document.getElementById('respondModalFooter').classList.remove('hidden');
            document.getElementById('respondMessage').value = '';
            document.getElementById('respondETA').value = '';
            document.getElementById('respondModal').classList.add('active');
        }
        
        function closeRespondModal(){
            document.getElementById('respondModal').classList.remove('active');
            currentRespondRequest=null;
        }
        
        let lastCreatedInteractionId = null;
        let lastRespondRequesterId = null;
        
        async function sendResponse(){
            if(!currentRespondRequest) return;
            
            console.log('sendResponse: currentRespondRequest =', currentRespondRequest);
            console.log('sendResponse: Using SOS ID =', currentRespondRequest.id);
            
            // Get requester's user_id and location from the SOS alert
            const {data: sosData} = await db.from('sos_alerts').select('user_id, status, latitude, longitude, alert_type').eq('id', currentRespondRequest.id).single();
            if(!sosData){
                alert('Error: Could not find request');
                return;
            }
            
            console.log('sendResponse: Found SOS data =', sosData);
            
            const responseMessage = document.getElementById('respondMessage').value.trim();
            const eta = document.getElementById('respondETA').value.trim();
            
            console.log('sendResponse: Creating interaction with sos_alert_id =', currentRespondRequest.id);
            
            const {data: insertData, error} = await db.from('interactions').insert({
                requester_id: sosData.user_id,
                helper_id: currentUser.id,
                interaction_type: currentRespondRequest.type,
                sos_alert_id: currentRespondRequest.id,
                status: 'accepted',
                notes: responseMessage,
                eta: eta
            }).select().single();
            
            console.log('sendResponse: Interaction created =', insertData, error ? 'Error: ' + error.message : '');
            
            if(error){
                alert('Error: '+error.message);
                return;
            }
            
            // Store for chat
            lastCreatedInteractionId = insertData.id;
            lastRespondRequesterId = sosData.user_id;
            
            // Send response as first message in chat
            let messageContent = `ğŸš— I'm on my way to help!`;
            if(eta) messageContent += `\nâ±ï¸ ETA: ${eta}`;
            if(responseMessage) messageContent += `\n\n${responseMessage}`;
            
            await db.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: sosData.user_id,
                content: messageContent,
                sos_alert_id: currentRespondRequest.id
            });
            
            // Update SOS alert status to show help is on the way
            await db.from('sos_alerts').update({
                status: 'help_coming',
                helper_responding_id: currentUser.id,
                response_time: new Date().toISOString()
            }).eq('id', currentRespondRequest.id);
            
            // Hide form, show photo reveal
            document.getElementById('respondFormSection').classList.add('hidden');
            document.getElementById('respondModalFooter').classList.add('hidden');
            
            // Load requester's photo
            const photoUrl = await getPhotoForVerifiedUser(sosData.user_id);
            const photoReveal = document.getElementById('respondPhotoReveal');
            const photoImg = document.getElementById('respondPhotoImg');
            const photoName = document.getElementById('respondPhotoName');
            
            if(photoUrl){
                photoImg.src = photoUrl;
                photoImg.style.display = 'block';
            } else {
                // Show avatar if no photo
                const av = generateAvatarData(sosData.user_id);
                document.getElementById('respondPhoto').innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:${av.color};font-size:48px;color:white;">${av.icon}</div>`;
            }
            photoName.textContent = currentRespondRequest.name;
            
            // Populate location info
            const coordsEl = document.getElementById('respondLocationCoords');
            const mapsLink = document.getElementById('respondMapsLink');
            const noLocation = document.getElementById('respondNoLocation');
            
            if(sosData.latitude && sosData.longitude){
                coordsEl.textContent = `${sosData.latitude.toFixed(5)}, ${sosData.longitude.toFixed(5)}`;
                mapsLink.href = `https://maps.google.com/?q=${sosData.latitude},${sosData.longitude}&navigate=yes`;
                mapsLink.style.display = 'block';
                noLocation.style.display = 'none';
            } else {
                coordsEl.textContent = '';
                mapsLink.style.display = 'none';
                noLocation.style.display = 'block';
            }
            
            // Load ICE data for emergency/medical alerts
            const iceSection = document.getElementById('respondICEInfo');
            const iceContent = document.getElementById('respondICEContent');
            const isEmergency = ['emergency', 'medical', 'accident'].includes(sosData.alert_type);
            
            if(isEmergency){
                // Load their ICE data
                const{data: iceData} = await db.from('user_medical').select('*').eq('user_id', sosData.user_id).eq('share_in_emergency', true).single();
                const{data: allergies} = await db.from('user_allergies').select('*').eq('user_id', sosData.user_id);
                const{data: medications} = await db.from('user_medications').select('*').eq('user_id', sosData.user_id);
                const{data: conditions} = await db.from('user_conditions').select('*').eq('user_id', sosData.user_id);
                
                if(iceData || (allergies && allergies.length) || (medications && medications.length) || (conditions && conditions.length)){
                    let html = '';
                    
                    if(iceData?.blood_type){
                        html += `<div style="margin-bottom:8px;"><strong>ğŸ©¸ Blood Type:</strong> <span style="font-size:16px;font-weight:700;color:#dc2626;">${iceData.blood_type}</span></div>`;
                    }
                    
                    if(allergies && allergies.length){
                        const severeAllergies = allergies.filter(a => a.severity === 'severe');
                        const otherAllergies = allergies.filter(a => a.severity !== 'severe');
                        html += `<div style="margin-bottom:8px;"><strong>âš ï¸ Allergies:</strong><br>`;
                        if(severeAllergies.length){
                            html += severeAllergies.map(a => `<span style="display:inline-block;background:#fecaca;color:#dc2626;padding:2px 8px;border-radius:8px;margin:2px 4px 2px 0;font-weight:600;">âš ï¸ ${a.allergy}</span>`).join('');
                        }
                        if(otherAllergies.length){
                            html += otherAllergies.map(a => `<span style="display:inline-block;background:#fef3c7;color:#b45309;padding:2px 8px;border-radius:8px;margin:2px 4px 2px 0;">${a.allergy}</span>`).join('');
                        }
                        html += `</div>`;
                    }
                    
                    if(medications && medications.length){
                        html += `<div style="margin-bottom:8px;"><strong>ğŸ’Š Medications:</strong><br>`;
                        html += medications.map(m => `<span style="display:inline-block;background:#eff6ff;color:#1d4ed8;padding:2px 8px;border-radius:8px;margin:2px 4px 2px 0;">${m.medication}${m.dosage ? ` (${m.dosage})` : ''}</span>`).join('');
                        html += `</div>`;
                    }
                    
                    if(conditions && conditions.length){
                        html += `<div style="margin-bottom:8px;"><strong>ğŸ¥ Conditions:</strong><br>`;
                        html += conditions.map(c => `<span style="display:inline-block;background:#fef3c7;color:#b45309;padding:2px 8px;border-radius:8px;margin:2px 4px 2px 0;">${c.condition}</span>`).join('');
                        html += `</div>`;
                    }
                    
                    if(iceData?.emergency_notes){
                        html += `<div style="margin-top:8px;padding:8px;background:#fff;border-radius:8px;"><strong>ğŸ“ Notes:</strong> ${iceData.emergency_notes}</div>`;
                    }
                    
                    if(iceData?.ice_contact_name){
                        html += `<div style="margin-top:8px;"><strong>ğŸ“ ICE Contact:</strong> ${iceData.ice_contact_name}</div>`;
                    }
                    
                    iceContent.innerHTML = html;
                    iceSection.classList.remove('hidden');
                } else {
                    iceSection.classList.add('hidden');
                }
            } else {
                iceSection.classList.add('hidden');
            }
            
            photoReveal.classList.remove('hidden');
            
            loadDashboard();
        }
        
        function openChatFromRespond(){
            if(!lastCreatedInteractionId || !lastRespondRequesterId) return;
            const name = currentRespondRequest?.name || 'User';
            closeRespondModal();
            openChatModal(lastRespondRequesterId, name, lastCreatedInteractionId);
        }
        
        // Activity & Feedback
        async function checkPendingFeedback(){
            if(!currentUser) return;
            
            console.log('checkPendingFeedback: Checking for user', currentUser.id);
            
            const{data, error} = await db.from('interactions')
                .select('*')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .eq('status','completed');
            
            console.log('checkPendingFeedback: Found', data?.length || 0, 'completed interactions', error ? 'Error: ' + error.message : '');
            if(data) console.log('checkPendingFeedback: Interactions:', data);
            
            const pending = (data||[]).filter(i => 
                (i.requester_id===currentUser.id && !i.requester_feedback_given) || 
                (i.helper_id===currentUser.id && !i.helper_feedback_given)
            );
            
            console.log('checkPendingFeedback: Pending feedback:', pending.length);
            
            const badge = document.getElementById('pendingBadge');
            if(pending.length > 0){
                badge.classList.remove('hidden');
                badge.textContent = 'âš ï¸ ' + pending.length;
                
                // Force feedback modal for first pending interaction
                const first = pending[0];
                const isRequester = first.requester_id === currentUser.id;
                const otherUserId = isRequester ? first.helper_id : first.requester_id;
                const name = generateAnonymousName(otherUserId || 'unknown');
                
                console.log('checkPendingFeedback: Showing modal for interaction', first.id, 'with', name);
                
                // Show blocking feedback modal
                showFeedbackBlockingModal(first.id, name, otherUserId, pending.length);
            } else {
                badge.classList.add('hidden');
                hideFeedbackBlockingModal();
            }
        }
        
        function showFeedbackBlockingModal(interactionId, name, otherUserId, totalPending){
            currentInteractionId = interactionId;
            
            let modal = document.getElementById('feedbackBlockingModal');
            if(!modal){
                // Create blocking modal if doesn't exist
                modal = document.createElement('div');
                modal.id = 'feedbackBlockingModal';
                modal.className = 'modal-overlay active';
                modal.style.cssText = 'z-index: 2000;';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--warning), #d97706); color: white;">
                            <h2>âš ï¸ Feedback Required</h2>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <p style="font-size: 16px; margin-bottom: 12px;">Before continuing, please rate your interaction with:</p>
                                <p id="blockingFeedbackName" style="font-size: 20px; font-weight: 700;"></p>
                                <p id="blockingFeedbackCount" style="color: var(--text-light); font-size: 13px; margin-top: 8px;"></p>
                            </div>
                            
                            <p style="font-weight: 600; margin-bottom: 12px; text-align: center;">How was your experience?</p>
                            <div class="rating-buttons" id="blockingRatingButtons" style="margin-bottom: 20px;">
                                <button class="rating-btn positive" onclick="selectBlockingRating('positive')"><span class="emoji">ğŸ‘</span><span class="label">Positive</span></button>
                                <button class="rating-btn neutral" onclick="selectBlockingRating('neutral')"><span class="emoji">ğŸ˜</span><span class="label">Neutral</span></button>
                                <button class="rating-btn negative" onclick="selectBlockingRating('negative')"><span class="emoji">ğŸ‘</span><span class="label">Negative</span></button>
                            </div>
                            
                            <div class="form-group">
                                <label>Comment (optional)</label>
                                <textarea class="form-control" id="blockingFeedbackComment" rows="2" placeholder="Share your experience..."></textarea>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="blockingWouldAgain" checked>
                                <label for="blockingWouldAgain">Would interact with this person again</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary btn-block" id="blockingSubmitBtn" onclick="submitBlockingFeedback()" disabled style="opacity: 0.5;">
                                â­ Submit Feedback to Continue
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('blockingFeedbackName').textContent = name;
            document.getElementById('blockingFeedbackCount').textContent = totalPending > 1 
                ? `(${totalPending} feedback${totalPending > 1 ? 's' : ''} pending)` 
                : '';
            
            // Reset state
            window.blockingSelectedRating = null;
            window.blockingOtherUserId = otherUserId;
            document.querySelectorAll('#blockingRatingButtons .rating-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('blockingFeedbackComment').value = '';
            document.getElementById('blockingWouldAgain').checked = true;
            document.getElementById('blockingSubmitBtn').disabled = true;
            document.getElementById('blockingSubmitBtn').style.opacity = '0.5';
            
            modal.classList.add('active');
        }
        
        function hideFeedbackBlockingModal(){
            const modal = document.getElementById('feedbackBlockingModal');
            if(modal) modal.classList.remove('active');
        }
        
        function selectBlockingRating(rating){
            window.blockingSelectedRating = rating;
            document.querySelectorAll('#blockingRatingButtons .rating-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`#blockingRatingButtons .rating-btn.${rating}`).classList.add('selected');
            document.getElementById('blockingSubmitBtn').disabled = false;
            document.getElementById('blockingSubmitBtn').style.opacity = '1';
        }
        
        async function submitBlockingFeedback(){
            if(!window.blockingSelectedRating || !currentInteractionId) return;
            
            const{data: interaction} = await db.from('interactions').select('*').eq('id', currentInteractionId).single();
            if(!interaction) return;
            
            const isRequester = interaction.requester_id === currentUser.id;
            
            // Insert feedback
            await db.from('feedback').insert({
                interaction_id: currentInteractionId,
                from_user_id: currentUser.id,
                to_user_id: window.blockingOtherUserId,
                rating: window.blockingSelectedRating,
                comment: document.getElementById('blockingFeedbackComment').value,
                would_interact_again: document.getElementById('blockingWouldAgain').checked,
                interaction_type: interaction.interaction_type
            });
            
            // Update interaction to mark feedback given
            await db.from('interactions').update({
                [isRequester ? 'requester_feedback_given' : 'helper_feedback_given']: true
            }).eq('id', currentInteractionId);
            
            // Update verification count for the other user
            await updateVerificationCount(window.blockingOtherUserId);
            
            // Check for more pending feedback
            await checkPendingFeedback();
            
            // Refresh stats
            loadDashboardStats();
        }
        async function loadActivity(){
            if(!currentUser) return;
            const{data} = await db.from('interactions')
                .select('*, requester:requester_id(id), helper:helper_id(id)')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .order('created_at',{ascending:false});
            
            const all = data || [];
            const pending = all.filter(i => i.status==='completed' && 
                ((i.requester_id===currentUser.id && !i.requester_feedback_given) || 
                 (i.helper_id===currentUser.id && !i.helper_feedback_given)));
            
            const pendingDiv = document.getElementById('pendingInteractions');
            
            if(pending.length > 0){
                document.getElementById('pendingFeedbackAlert').classList.remove('hidden');
                pendingDiv.innerHTML = pending.map(i => {
                    const isRequester = i.requester_id === currentUser.id;
                    const otherUserId = isRequester ? i.helper_id : i.requester_id;
                    const n = generateAnonymousName(otherUserId || 'unknown');
                    return `<div class="request-card" style="border-color:var(--warning);background:var(--warning-light)">
                        <p><strong>With:</strong> ${n}</p>
                        <p style="color:var(--text-light);font-size:13px">${i.interaction_type}</p>
                        <button class="btn btn-accent btn-sm" onclick="openFeedbackModal('${i.id}','${n}','${otherUserId}')" style="margin-top:12px">â­ Feedback</button>
                    </div>`;
                }).join('');
            } else {
                document.getElementById('pendingFeedbackAlert').classList.add('hidden');
                pendingDiv.innerHTML = '<p style="color:var(--success)">âœ… All done!</p>';
            }
            
            const recentDiv = document.getElementById('recentActivity');
            recentDiv.innerHTML = all.length > 0 ? all.slice(0,10).map(i => {
                const isRequester = i.requester_id === currentUser.id;
                const otherUserId = isRequester ? i.helper_id : i.requester_id;
                const n = generateAnonymousName(otherUserId || 'unknown');
                return `<div class="request-card">
                    <p><strong>${isRequester ? 'Requested from' : 'Helped'}:</strong> ${n}</p>
                    <p style="color:var(--text-light);font-size:13px">${i.interaction_type} â€¢ ${i.status}</p>
                </div>`;
            }).join('') : '<p style="color:var(--text-light)">No activity.</p>';
        }
        async function openFeedbackModal(id, name, otherUserId){
            currentInteractionId = id;
            selectedRating = null;
            document.getElementById('feedbackUserName').textContent = name;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('feedbackComment').value = '';
            document.getElementById('feedbackWouldAgain').checked = true;
            
            // Load other user's photo for verification
            const photoImg = document.getElementById('feedbackPhotoImg');
            const photoAvatar = document.getElementById('feedbackPhotoAvatar');
            
            if(otherUserId){
                const photoUrl = await getPhotoForVerifiedUser(otherUserId);
                if(photoUrl){
                    photoImg.src = photoUrl;
                    photoImg.style.display = 'block';
                    photoAvatar.style.display = 'none';
                } else {
                    const av = generateAvatarData(otherUserId);
                    photoAvatar.innerHTML = av.icon;
                    photoAvatar.style.background = av.color;
                    photoAvatar.style.color = 'white';
                    photoImg.style.display = 'none';
                    photoAvatar.style.display = 'flex';
                }
            }
            
            document.getElementById('feedbackModal').classList.add('active');
        }
        function closeFeedbackModal(){document.getElementById('feedbackModal').classList.remove('active');currentInteractionId=null}
        function selectRatingBtn(r){selectedRating=r;document.querySelectorAll('.rating-btn').forEach(b=>b.classList.remove('selected'));document.querySelector('.rating-btn.'+r).classList.add('selected')}
        async function submitFeedback(){if(!selectedRating){alert('Select rating');return}const{data:interaction}=await db.from('interactions').select('*').eq('id',currentInteractionId).single();if(!interaction)return;const isReq=interaction.requester_id===currentUser.id;await db.from('feedback').insert({interaction_id:currentInteractionId,from_user_id:currentUser.id,to_user_id:isReq?interaction.helper_id:interaction.requester_id,rating:selectedRating,comment:document.getElementById('feedbackComment').value,would_interact_again:document.getElementById('feedbackWouldAgain').checked,interaction_type:interaction.interaction_type});await db.from('interactions').update({[isReq?'requester_feedback_given':'helper_feedback_given']:true}).eq('id',currentInteractionId);closeFeedbackModal();checkPendingFeedback();loadActivity();loadDashboardStats();alert('âœ… Thanks!')}
        
        // SOS
        function updateSOSTabPulse(nearbyRequests){
            const sosTab = document.getElementById('sosTab');
            if(!sosTab) return;
            
            // Remove all pulse classes
            sosTab.classList.remove('pulse-low', 'pulse-medium', 'pulse-high', 'pulse-critical', 'has-requests');
            sosTab.removeAttribute('data-count');
            
            if(!nearbyRequests || nearbyRequests.length === 0) return;
            
            // Find the most critical severity
            const severityOrder = {critical: 4, high: 3, medium: 2, low: 1};
            let maxSeverity = 'low';
            nearbyRequests.forEach(r => {
                if(severityOrder[r.severity] > severityOrder[maxSeverity]){
                    maxSeverity = r.severity;
                }
            });
            
            // Apply pulse class based on most critical request
            sosTab.classList.add(`pulse-${maxSeverity}`);
            sosTab.classList.add('has-requests');
            sosTab.setAttribute('data-count', nearbyRequests.length);
        }
        
        function startSOS(){document.getElementById('sosButton').classList.add('holding');sosStartTime=Date.now();document.getElementById('sosStatus').textContent='Hold...';document.getElementById('sosStatus').style.color='var(--danger)';sosTimer=setInterval(()=>{const elapsed=Date.now()-sosStartTime;document.getElementById('sosProgress').style.width=Math.min((elapsed/3000)*100,100)+'%';if(elapsed>=3000){cancelSOS();triggerSOS()}},50)}
        function cancelSOS(){document.getElementById('sosButton').classList.remove('holding');document.getElementById('sosProgress').style.width='0%';if(sosTimer){clearInterval(sosTimer);sosTimer=null}if(!sosStartTime||Date.now()-sosStartTime<3000)document.getElementById('sosStatus').textContent=''}
        function triggerSOS(){
            document.getElementById('sosStatus').textContent='';
            // Show emergency details modal
            document.getElementById('emergencyModal').classList.add('active');
        }
        
        function closeEmergencyModal(){
            document.getElementById('emergencyModal').classList.remove('active');
        }
        
        async function sendEmergencySOS(){
            const emergencyType = document.getElementById('emergencyType').value;
            const emergencyDesc = document.getElementById('emergencyDesc').value.trim();
            const result = document.getElementById('emergencyResult');
            
            if(!emergencyType){
                result.innerHTML = '<div class="alert alert-danger">Please select what\'s happening</div>';
                return;
            }
            
            // Request notification permission so they can be alerted when help responds
            requestNotificationPermission();
            
            result.innerHTML = '<div class="alert alert-info">ğŸ“¡ Sending SOS...</div>';
            
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(async p => {
                    const {error} = await db.from('sos_alerts').insert({
                        user_id: currentUser.id,
                        alert_type: 'emergency',
                        severity: 'critical',
                        description: `ğŸ†˜ EMERGENCY: ${emergencyType}${emergencyDesc ? ' - ' + emergencyDesc : ''}`,
                        latitude: p.coords.latitude,
                        longitude: p.coords.longitude,
                        status: 'active',
                        emergency_type: emergencyType
                    });
                    
                    if(error){
                        result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                    } else {
                        result.innerHTML = '<div class="alert alert-success">âœ… SOS sent! Help is being notified.<br><small>You\'ll be notified when someone responds.</small></div>';
                        document.getElementById('sosStatus').textContent = 'âœ… SOS sent!';
                        document.getElementById('sosStatus').style.color = 'var(--success)';
                        setTimeout(() => {
                            closeEmergencyModal();
                            loadActiveSOSRequests();
                        }, 2000);
                    }
                }, () => {
                    result.innerHTML = '<div class="alert alert-danger">âš ï¸ Could not get location. Enable GPS and try again.</div>';
                }, {enableHighAccuracy: true});
            } else {
                result.innerHTML = '<div class="alert alert-danger">âš ï¸ Geolocation not supported</div>';
            }
        }
        async function handleCreateSOS(){
            if(!currentUser)return;
            const r=document.getElementById('sosResult');
            r.innerHTML='<div class="alert alert-info">Sending...</div>';
            
            // Request notification permission
            requestNotificationPermission();
            
            const vid=document.getElementById('sosVehicle').value;
            let vinfo='';
            if(vid){
                const v=userVehicles.find(x=>x.id===vid);
                if(v)vinfo=`\nğŸš— Vehicle: ${v.year||''} ${v.make} ${v.model} (${v.fuel_type||'Unknown'})`;
            }
            
            const{error}=await db.from('sos_alerts').insert({
                user_id:currentUser.id,
                alert_type:document.getElementById('sosType').value,
                severity:document.getElementById('sosSeverity').value,
                description:document.getElementById('sosDescription').value+vinfo,
                latitude:parseFloat(document.getElementById('sosLat').value)||null,
                longitude:parseFloat(document.getElementById('sosLng').value)||null,
                status:'active'
            });
            
            r.innerHTML=error
                ? '<div class="alert alert-danger">âŒ '+error.message+'</div>'
                : '<div class="alert alert-success">âœ… Help request sent!<br><small>You\'ll be notified when someone responds.</small></div>';
            
            if(!error){
                document.getElementById('sosDescription').value='';
                loadActiveSOSRequests();
            }
        }
        
        async function loadActiveSOSRequests(){
            if(!currentUser)return;
            
            // Load user's active SOS requests
            const section = document.getElementById('activeSOSSection');
            const list = document.getElementById('activeSOSList');
            
            const{data, error} = await db.from('sos_alerts')
                .select('*')
                .eq('user_id', currentUser.id)
                .in('status', ['active', 'help_coming'])
                .order('created_at', {ascending: false});
            
            if(error || !data || data.length === 0){
                section.classList.add('hidden');
            } else {
                section.classList.remove('hidden');
                
                const typeIcons = {breakdown:'ğŸ”§', accident:'ğŸ’¥', medical:'ğŸ¥', stuck:'ğŸš™', fuel:'â›½', unsafe:'âš ï¸', emergency:'ğŸš¨', directions:'ğŸ—ºï¸', meetup:'ğŸº', other:'â“'};
                const severityColors = {low:'#22c55e', medium:'#f59e0b', high:'#f97316', critical:'#ef4444'};
                
                list.innerHTML = data.map(s => {
                    const created = new Date(s.created_at).toLocaleString('en-NZ', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
                    const isHelpComing = s.status === 'help_coming';
                    return `
                    <div class="request-card" style="margin-bottom: 16px; border-left: 4px solid ${isHelpComing ? 'var(--success)' : (severityColors[s.severity] || '#ccc')}; ${isHelpComing ? 'background: linear-gradient(135deg, #f0fdf4, #dcfce7);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 8px;">${typeIcons[s.alert_type] || 'â“'} ${s.alert_type.charAt(0).toUpperCase() + s.alert_type.slice(1)}</h4>
                                ${isHelpComing ? `<p style="color: var(--success); font-weight: 700; margin: 0 0 8px;">ğŸš— Help is on the way!</p>` : ''}
                                <p style="color: var(--text-light); font-size: 13px; margin: 0 0 8px;">ğŸ“… ${created}</p>
                                ${s.description ? `<p style="margin: 0; color: var(--text-light);">${s.description}</p>` : ''}
                            </div>
                            <span class="severity-badge severity-${s.severity}">${s.severity}</span>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-success btn-sm" onclick="markSOSResolved('${s.id}')">âœ… Resolved</button>
                            <button class="btn btn-danger btn-sm" onclick="cancelSOSRequest('${s.id}')">âŒ Cancel</button>
                        </div>
                    </div>`;
                }).join('');
            }
            
            // Load incoming help (responses to my SOS requests)
            await loadIncomingHelp();
        }
        
        async function loadIncomingHelp(){
            if(!currentUser)return;
            
            const section = document.getElementById('incomingHelpSection');
            const list = document.getElementById('incomingHelpList');
            
            // Get interactions where I'm the requester and status is accepted (helper coming)
            const{data, error} = await db.from('interactions')
                .select('*, sos_alerts(*)')
                .eq('requester_id', currentUser.id)
                .eq('status', 'accepted')
                .order('created_at', {ascending: false});
            
            if(error || !data || data.length === 0){
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            
            // Build the list with helper photos
            let html = '';
            for(const i of data){
                const helperName = generateAnonymousName(i.helper_id);
                const helperAv = generateAvatarData(i.helper_id);
                const photoUrl = await getPhotoForVerifiedUser(i.helper_id);
                const created = new Date(i.created_at).toLocaleString('en-NZ', {hour:'2-digit', minute:'2-digit'});
                
                html += `
                <div class="request-card" style="margin-bottom: 16px; border-left: 4px solid var(--success); background: var(--success-light);">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div style="width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 3px solid var(--success); flex-shrink: 0;">
                            ${photoUrl 
                                ? `<img src="${photoUrl}" style="width:100%;height:100%;object-fit:cover;">` 
                                : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:${helperAv.color};font-size:28px;color:white;">${helperAv.icon}</div>`
                            }
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 4px; color: var(--success);">${helperName} is coming!</h4>
                            ${i.eta ? `<p style="margin: 0 0 4px; font-weight: 600;">ğŸ• ETA: ${i.eta}</p>` : ''}
                            ${i.notes ? `<p style="margin: 0; color: var(--text-light); font-size: 13px;">"${i.notes}"</p>` : ''}
                            <p style="margin: 4px 0 0; color: var(--text-light); font-size: 12px;">Responded at ${created}</p>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-sm" onclick="openChatModal('${i.helper_id}', '${helperName}', '${i.id}')">ğŸ’¬ Chat</button>
                        <button class="btn btn-success btn-sm" onclick="markInteractionComplete('${i.id}', '${helperName}', '${i.helper_id}')">âœ… They Arrived - Complete</button>
                    </div>
                </div>`;
            }
            
            list.innerHTML = html;
        }
        
        async function markInteractionComplete(interactionId, helperName, helperId){
            if(!confirm(`Confirm ${helperName} has helped you? This will mark the interaction complete and prompt for feedback.`)) return;
            
            const{error} = await db.from('interactions')
                .update({status: 'completed', updated_at: new Date().toISOString()})
                .eq('id', interactionId);
            
            if(error){
                alert('Error: ' + error.message);
                return;
            }
            
            // Refresh the lists
            await loadActiveSOSRequests();
            await checkPendingFeedback();
            
            // Open feedback modal immediately
            openFeedbackModal(interactionId, helperName, helperId);
        }
        
        async function cancelSOSRequest(id){
            if(!confirm('Cancel this SOS request?')) return;
            const{error} = await db.from('sos_alerts').update({status: 'cancelled', updated_at: new Date().toISOString()}).eq('id', id);
            if(error){
                alert('Error: ' + error.message);
            } else {
                loadActiveSOSRequests();
            }
        }
        
        async function markSOSResolved(id){
            if(!confirm('Mark this request as resolved?')) return;
            
            console.log('markSOSResolved: Starting for SOS', id);
            
            // Get any interactions (helpers who responded)
            const{data: interactions, error: intError} = await db.from('interactions')
                .select('*')
                .eq('sos_alert_id', id)
                .eq('status', 'accepted');
            
            console.log('markSOSResolved: Found interactions:', interactions, intError ? 'Error: ' + intError.message : '');
            
            // Update SOS alert
            const{error} = await db.from('sos_alerts').update({status: 'resolved', updated_at: new Date().toISOString()}).eq('id', id);
            if(error){
                alert('Error: ' + error.message);
                console.log('markSOSResolved: SOS update error:', error.message);
                return;
            }
            console.log('markSOSResolved: SOS status updated to resolved');
            
            // Mark each interaction as completed by its own ID
            if(interactions && interactions.length > 0){
                for(const interaction of interactions){
                    console.log('markSOSResolved: Updating interaction', interaction.id, 'to completed');
                    const{error: intUpdateError} = await db.from('interactions')
                        .update({status: 'completed', updated_at: new Date().toISOString()})
                        .eq('id', interaction.id);
                    
                    console.log('markSOSResolved: Interaction', interaction.id, 'update result:', intUpdateError ? 'Error: ' + intUpdateError.message : 'Success');
                }
            }
            
            loadActiveSOSRequests();
            
            // If there were helpers, prompt for feedback on each
            if(interactions && interactions.length > 0){
                console.log('markSOSResolved: Opening feedback for', interactions.length, 'helpers');
                for(const i of interactions){
                    const helperName = generateAnonymousName(i.helper_id);
                    openFeedbackModal(i.id, helperName, i.helper_id);
                    break; // Open first one, others will show in pending
                }
            }
            
            checkPendingFeedback();
            loadDashboardStats();
        }
        
        // In-App Messaging
        let currentChatUserId = null;
        let currentChatInteractionId = null;
        let messageSubscription = null;
        
        function openChatModal(userId, userName, interactionId){
            currentChatUserId = userId;
            currentChatInteractionId = interactionId;
            document.getElementById('chatUserName').textContent = userName;
            document.getElementById('chatMessages').innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">Loading messages...</p>';
            document.getElementById('chatInput').value = '';
            document.getElementById('chatModal').classList.add('active');
            loadMessages();
            subscribeToMessages();
        }
        
        function closeChatModal(){
            document.getElementById('chatModal').classList.remove('active');
            if(messageSubscription){
                messageSubscription.unsubscribe();
                messageSubscription = null;
            }
            currentChatUserId = null;
            currentChatInteractionId = null;
        }
        
        async function loadMessages(){
            if(!currentChatInteractionId) return;
            
            const{data, error} = await db.from('messages')
                .select('*')
                .eq('interaction_id', currentChatInteractionId)
                .order('created_at', {ascending: true});
            
            if(error){
                document.getElementById('chatMessages').innerHTML = `<p style="color:var(--danger)">Error loading messages</p>`;
                return;
            }
            
            renderMessages(data || []);
        }
        
        function renderMessages(messages){
            const div = document.getElementById('chatMessages');
            
            if(messages.length === 0){
                div.innerHTML = `
                    <div style="text-align:center;padding:40px;color:var(--text-light);">
                        <p style="font-size:24px;margin-bottom:8px;">ğŸ’¬</p>
                        <p>No messages yet. Say hello!</p>
                    </div>`;
                return;
            }
            
            div.innerHTML = messages.map(m => {
                const isMe = m.sender_id === currentUser.id;
                const time = new Date(m.created_at).toLocaleTimeString('en-NZ', {hour:'2-digit', minute:'2-digit'});
                return `
                    <div style="display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};margin-bottom:8px;">
                        <div style="max-width:75%;padding:10px 14px;border-radius:16px;
                            background:${isMe ? 'var(--primary)' : 'var(--bg)'};
                            color:${isMe ? 'white' : 'var(--text)'};
                            border-bottom-${isMe ? 'right' : 'left'}-radius:4px;">
                            <p style="margin:0;word-wrap:break-word;">${escapeHtml(m.content)}</p>
                            <p style="margin:4px 0 0;font-size:10px;opacity:0.7;text-align:right;">${time}</p>
                        </div>
                    </div>`;
            }).join('');
            
            // Scroll to bottom
            div.scrollTop = div.scrollHeight;
        }
        
        function escapeHtml(text){
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function sendMessage(){
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if(!content || !currentChatInteractionId) return;
            
            input.value = '';
            
            const{error} = await db.from('messages').insert({
                interaction_id: currentChatInteractionId,
                sender_id: currentUser.id,
                receiver_id: currentChatUserId,
                content: content
            });
            
            if(error){
                alert('Failed to send: ' + error.message);
                input.value = content;
            }
        }
        
        function subscribeToMessages(){
            if(!currentChatInteractionId) return;
            
            messageSubscription = db.channel(`chat-${currentChatInteractionId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `interaction_id=eq.${currentChatInteractionId}`
                }, (payload) => {
                    // Add new message to chat
                    const div = document.getElementById('chatMessages');
                    const m = payload.new;
                    const isMe = m.sender_id === currentUser.id;
                    const time = new Date(m.created_at).toLocaleTimeString('en-NZ', {hour:'2-digit', minute:'2-digit'});
                    
                    // Remove "no messages" placeholder if present
                    if(div.querySelector('p')?.textContent?.includes('No messages')){
                        div.innerHTML = '';
                    }
                    
                    div.innerHTML += `
                        <div style="display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};margin-bottom:8px;">
                            <div style="max-width:75%;padding:10px 14px;border-radius:16px;
                                background:${isMe ? 'var(--primary)' : 'var(--bg)'};
                                color:${isMe ? 'white' : 'var(--text)'};
                                border-bottom-${isMe ? 'right' : 'left'}-radius:4px;">
                                <p style="margin:0;word-wrap:break-word;">${escapeHtml(m.content)}</p>
                                <p style="margin:4px 0 0;font-size:10px;opacity:0.7;text-align:right;">${time}</p>
                            </div>
                        </div>`;
                    div.scrollTop = div.scrollHeight;
                    
                    // Play sound if message is from other user
                    if(!isMe) playNotificationSound();
                })
                .subscribe();
        }
        
        // Handle Enter key in chat
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if(chatInput){
                    chatInput.addEventListener('keypress', (e) => {
                        if(e.key === 'Enter' && !e.shiftKey){
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                }
            }, 1000);
        });

        // Places & Business Reviews
        let currentPlaces = [];
        let selectedPlace = null;
        let selectedPlaceRating = null;
        
        async function searchPlacesNearMe(){
            if(!navigator.geolocation){
                alert('Geolocation not supported');
                return;
            }
            navigator.geolocation.getCurrentPosition(async p => {
                await searchPlaces(p.coords.latitude, p.coords.longitude);
            }, e => alert('Location error: ' + e.message), {enableHighAccuracy: true});
        }
        
        async function searchAllPlaces(){
            await searchPlaces(null, null);
        }
        
        async function searchPlaces(lat, lng){
            const resultsDiv = document.getElementById('placesResults');
            resultsDiv.innerHTML = '<p style="text-align:center;color:var(--text-light)">ğŸ” Searching...</p>';
            
            const searchText = document.getElementById('placeSearch').value.toLowerCase();
            const category = document.getElementById('placeCategory').value;
            
            let query = db.from('businesses').select('*, business_reviews(rating)');
            if(category) query = query.eq('category', category);
            
            const {data, error} = await query.order('name');
            
            if(error){
                resultsDiv.innerHTML = `<p style="color:var(--danger)">Error: ${error.message}</p>`;
                return;
            }
            
            let places = data || [];
            
            // Filter by search text
            if(searchText){
                places = places.filter(p => 
                    p.name.toLowerCase().includes(searchText) || 
                    (p.city && p.city.toLowerCase().includes(searchText)) ||
                    (p.address && p.address.toLowerCase().includes(searchText))
                );
            }
            
            // Calculate distance if we have location
            if(lat && lng){
                places.forEach(p => {
                    if(p.latitude && p.longitude){
                        p.distance = getDistance(lat, lng, p.latitude, p.longitude);
                    } else {
                        p.distance = 99999;
                    }
                });
                places.sort((a,b) => a.distance - b.distance);
            }
            
            currentPlaces = places;
            
            if(!places.length){
                resultsDiv.innerHTML = '<p style="text-align:center;color:var(--text-light)">No places found. Try a different search or add a new place!</p>';
                return;
            }
            
            const categoryIcons = {mechanic:'ğŸ”§', fuel:'â›½', tyres:'ğŸ›', accommodation:'ğŸ¨', camping:'ğŸ•ï¸', cafe:'â˜•', parts:'ğŸ”©', other:'ğŸ“'};
            
            resultsDiv.innerHTML = `<p style="margin-bottom:16px;color:var(--text-light)">${places.length} place(s) found</p>` + 
                places.map((p, i) => {
                    // Calculate rating summary
                    const reviews = p.business_reviews || [];
                    const positive = reviews.filter(r => r.rating === 'positive').length;
                    const total = reviews.length;
                    const ratingText = total > 0 ? `ğŸ‘ ${positive}/${total}` : 'No reviews yet';
                    
                    return `
                    <div class="request-card" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 6px;">${categoryIcons[p.category] || 'ğŸ“'} ${p.name}</h4>
                                <p style="color: var(--text-light); font-size: 13px; margin: 0;">
                                    ${p.city || ''}${p.city && p.country ? ', ' : ''}${p.country || ''}
                                    ${p.distance < 99999 ? ` â€¢ ğŸ“ ${p.distance.toFixed(1)} km` : ''}
                                </p>
                                <p style="margin: 8px 0 0; font-size: 14px;">${ratingText}</p>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="viewPlace(${i})">ğŸ‘ï¸ View</button>
                            <button class="btn btn-accent btn-sm" onclick="openReviewPlaceModal(${i})">â­ Review</button>
                            ${p.phone ? `<a href="tel:${p.phone}" class="btn btn-secondary btn-sm">ğŸ“ Call</a>` : ''}
                        </div>
                    </div>`;
                }).join('');
        }
        
        function viewPlace(index){
            const p = currentPlaces[index];
            const reviews = p.business_reviews || [];
            const categoryIcons = {mechanic:'ğŸ”§', fuel:'â›½', tyres:'ğŸ›', accommodation:'ğŸ¨', camping:'ğŸ•ï¸', cafe:'â˜•', parts:'ğŸ”©', other:'ğŸ“'};
            
            let details = `
                <h3>${categoryIcons[p.category] || 'ğŸ“'} ${p.name}</h3>
                <p>${p.address || ''} ${p.city || ''}, ${p.country || ''}</p>
                ${p.phone ? `<p>ğŸ“ ${p.phone}</p>` : ''}
                ${p.website ? `<p>ğŸŒ <a href="${p.website}" target="_blank">${p.website}</a></p>` : ''}
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border);">
                <h4>Reviews (${reviews.length})</h4>
            `;
            
            if(reviews.length === 0){
                details += '<p style="color:var(--text-light)">No reviews yet. Be the first!</p>';
            }
            
            alert(details); // Simple for now - could make a proper modal
        }
        
        function openAddPlaceModal(){
            document.getElementById('placeName').value = '';
            document.getElementById('placeAddCategory').value = '';
            document.getElementById('placeAddress').value = '';
            document.getElementById('placeCity').value = '';
            document.getElementById('placeCountry').value = 'New Zealand';
            document.getElementById('placePhone').value = '';
            document.getElementById('placeWebsite').value = '';
            document.getElementById('placeLat').value = '';
            document.getElementById('placeLng').value = '';
            document.getElementById('addPlaceResult').innerHTML = '';
            document.getElementById('addPlaceModal').classList.add('active');
        }
        
        function closeAddPlaceModal(){
            document.getElementById('addPlaceModal').classList.remove('active');
        }
        
        function getPlaceGPS(){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(p => {
                    document.getElementById('placeLat').value = p.coords.latitude.toFixed(6);
                    document.getElementById('placeLng').value = p.coords.longitude.toFixed(6);
                }, e => alert('Error: ' + e.message), {enableHighAccuracy: true});
            }
        }
        
        async function saveNewPlace(){
            const name = document.getElementById('placeName').value.trim();
            const category = document.getElementById('placeAddCategory').value;
            const city = document.getElementById('placeCity').value.trim();
            const country = document.getElementById('placeCountry').value.trim();
            const result = document.getElementById('addPlaceResult');
            
            if(!name || !category || !city || !country){
                result.innerHTML = '<div class="alert alert-danger">Please fill in required fields (Name, Category, City, Country)</div>';
                return;
            }
            
            result.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            const {error} = await db.from('businesses').insert({
                name: name,
                category: category,
                address: document.getElementById('placeAddress').value.trim() || null,
                city: city,
                country: country,
                phone: document.getElementById('placePhone').value.trim() || null,
                website: document.getElementById('placeWebsite').value.trim() || null,
                latitude: parseFloat(document.getElementById('placeLat').value) || null,
                longitude: parseFloat(document.getElementById('placeLng').value) || null,
                added_by: currentUser.id
            });
            
            if(error){
                result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } else {
                result.innerHTML = '<div class="alert alert-success">âœ… Place added!</div>';
                setTimeout(() => {
                    closeAddPlaceModal();
                    searchAllPlaces();
                }, 1500);
            }
        }
        
        function openReviewPlaceModal(index){
            selectedPlace = currentPlaces[index];
            selectedPlaceRating = null;
            
            const categoryIcons = {mechanic:'ğŸ”§', fuel:'â›½', tyres:'ğŸ›', accommodation:'ğŸ¨', camping:'ğŸ•ï¸', cafe:'â˜•', parts:'ğŸ”©', other:'ğŸ“'};
            document.getElementById('reviewPlaceInfo').innerHTML = `
                <h4 style="margin: 0 0 4px;">${categoryIcons[selectedPlace.category] || 'ğŸ“'} ${selectedPlace.name}</h4>
                <p style="margin: 0; color: var(--text-light);">${selectedPlace.city || ''}, ${selectedPlace.country || ''}</p>
            `;
            
            // Reset form
            document.querySelectorAll('#placeRatingButtons .rating-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.serviceCheckbox').forEach(c => c.checked = false);
            document.getElementById('reviewVisitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('reviewComment').value = '';
            document.getElementById('reviewRecommend').checked = true;
            document.getElementById('reviewPlaceResult').innerHTML = '';
            
            document.getElementById('reviewPlaceModal').classList.add('active');
        }
        
        function closeReviewPlaceModal(){
            document.getElementById('reviewPlaceModal').classList.remove('active');
            selectedPlace = null;
        }
        
        function selectPlaceRating(rating){
            selectedPlaceRating = rating;
            document.querySelectorAll('#placeRatingButtons .rating-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`#placeRatingButtons .rating-btn.${rating}`).classList.add('selected');
        }
        
        async function submitPlaceReview(){
            if(!selectedPlace || !selectedPlaceRating){
                alert('Please select a rating');
                return;
            }
            
            const result = document.getElementById('reviewPlaceResult');
            result.innerHTML = '<div class="alert alert-info">Submitting...</div>';
            
            // Gather selected services
            const services = [];
            document.querySelectorAll('.serviceCheckbox:checked').forEach(c => services.push(c.value));
            
            const {error} = await db.from('business_reviews').insert({
                business_id: selectedPlace.id,
                user_id: currentUser.id,
                rating: selectedPlaceRating,
                comment: document.getElementById('reviewComment').value.trim() || null,
                services_used: services.length > 0 ? services : null,
                would_recommend: document.getElementById('reviewRecommend').checked,
                visit_date: document.getElementById('reviewVisitDate').value || null
            });
            
            if(error){
                result.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } else {
                result.innerHTML = '<div class="alert alert-success">âœ… Review submitted!</div>';
                setTimeout(() => {
                    closeReviewPlaceModal();
                    searchAllPlaces(); // Refresh to show updated ratings
                    loadMyPlaceReviews();
                }, 1500);
            }
        }
        
        async function loadMyPlaceReviews(){
            if(!currentUser) return;
            const div = document.getElementById('myPlaceReviews');
            
            const {data, error} = await db.from('business_reviews')
                .select('*, businesses(name, city)')
                .eq('user_id', currentUser.id)
                .order('created_at', {ascending: false});
            
            if(error || !data || data.length === 0){
                div.innerHTML = '<p style="color: var(--text-light)">You haven\'t reviewed any places yet.</p>';
                return;
            }
            
            const ratingIcons = {positive: 'ğŸ‘', neutral: 'ğŸ˜', negative: 'ğŸ‘'};
            
            div.innerHTML = data.map(r => `
                <div class="request-card" style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>${r.businesses?.name || 'Unknown'}</strong>
                            <span style="margin-left: 8px;">${ratingIcons[r.rating] || ''}</span>
                        </div>
                        <span style="color: var(--text-light); font-size: 12px;">${r.visit_date || ''}</span>
                    </div>
                    ${r.comment ? `<p style="margin: 8px 0 0; color: var(--text-light); font-size: 13px;">"${r.comment}"</p>` : ''}
                </div>
            `).join('');
        }
        
        // ==================== MESSAGING SYSTEM ====================
        // Variables currentChatUserId and messageSubscription already declared above
        let currentChatContext = null; // {type: 'sos'|'traveler'|'general', id: sosAlertId or null}
        
        // Load conversations for Messages tab
        async function loadConversations(){
            if(!currentUser) return;
            const div = document.getElementById('conversationsList');
            
            // Get all messages involving current user
            const{data: messages, error} = await db.from('messages')
                .select('*')
                .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                .order('created_at', {ascending: false});
            
            if(error){
                div.innerHTML = `<p style="color: var(--danger);">Error loading messages</p>`;
                return;
            }
            
            if(!messages || messages.length === 0){
                div.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</p>
                        <p>No conversations yet</p>
                        <p style="font-size: 13px;">Message a nearby traveler or respond to a help request to start chatting</p>
                    </div>`;
                return;
            }
            
            // Group by conversation partner
            const conversations = {};
            messages.forEach(m => {
                const partnerId = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
                if(!conversations[partnerId]){
                    conversations[partnerId] = {
                        partnerId,
                        lastMessage: m,
                        unread: m.receiver_id === currentUser.id && !m.read_at
                    };
                } else if(!m.read_at && m.receiver_id === currentUser.id){
                    conversations[partnerId].unread = true;
                }
            });
            
            // Convert to array and sort by last message time
            const convList = Object.values(conversations).sort((a,b) => 
                new Date(b.lastMessage.created_at) - new Date(a.lastMessage.created_at)
            );
            
            // Count total unread
            const totalUnread = convList.filter(c => c.unread).length;
            updateUnreadBadge(totalUnread);
            
            // Render conversation list
            div.innerHTML = convList.map(c => {
                const av = generateAvatarData(c.partnerId);
                const name = generateAnonymousName(c.partnerId);
                const preview = c.lastMessage.content.length > 40 
                    ? c.lastMessage.content.substring(0, 40) + '...' 
                    : c.lastMessage.content;
                const isFromMe = c.lastMessage.sender_id === currentUser.id;
                const time = formatMessageTime(c.lastMessage.created_at);
                
                return `
                <div class="conversation-item ${c.unread ? 'unread' : ''}" onclick="openUniversalChat('${c.partnerId}', '${name}', null)">
                    <div class="conversation-avatar" style="background: ${av.color}; color: white;">${av.icon}</div>
                    <div class="conversation-info">
                        <p class="conversation-name">${name}</p>
                        <p class="conversation-preview">${isFromMe ? 'You: ' : ''}${escapeHtml(preview)}</p>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${time}</div>
                        ${c.unread ? '<div class="conversation-unread-dot"></div>' : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        function updateUnreadBadge(count){
            const badge = document.getElementById('unreadBadge');
            if(count > 0){
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function formatMessageTime(timestamp){
            const date = new Date(timestamp);
            const now = new Date();
            const diffMins = Math.floor((now - date) / 60000);
            
            if(diffMins < 1) return 'Now';
            if(diffMins < 60) return `${diffMins}m`;
            if(diffMins < 1440) return `${Math.floor(diffMins/60)}h`;
            if(diffMins < 10080) return `${Math.floor(diffMins/1440)}d`;
            return date.toLocaleDateString('en-NZ', {day: 'numeric', month: 'short'});
        }
        
        function formatChatTimestamp(timestamp){
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const messageDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const time = date.toLocaleTimeString('en-NZ', {hour: '2-digit', minute: '2-digit'});
            
            if(messageDay.getTime() === today.getTime()){
                return time; // Just time for today
            } else if(messageDay.getTime() === yesterday.getTime()){
                return `Yesterday ${time}`;
            } else if(now - date < 7 * 24 * 60 * 60 * 1000){
                // Within last week - show day name
                return date.toLocaleDateString('en-NZ', {weekday: 'short'}) + ' ' + time;
            } else {
                // Older - show full date
                return date.toLocaleDateString('en-NZ', {day: 'numeric', month: 'short'}) + ' ' + time;
            }
        }
        
        // View Request Modal
        let viewRequestData = null;
        
        function openViewRequestModal(requestId){
            const request = window.nearbySOSRequests?.find(r => r.id === requestId);
            if(!request){
                alert('Request not found');
                return;
            }
            viewRequestData = request;
            
            const av = generateAvatarData(request.user_id);
            const name = generateAnonymousName(request.user_id);
            const typeIcons = {breakdown:'ğŸ”§', accident:'ğŸ’¥', medical:'ğŸ¥', stuck:'ğŸš™', fuel:'â›½', unsafe:'âš ï¸', emergency:'ğŸš¨', directions:'ğŸ—ºï¸', meetup:'ğŸº', other:'â“'};
            const severityColors = {low:'#22c55e', medium:'#f59e0b', high:'#f97316', critical:'#ef4444'};
            
            const created = new Date(request.created_at);
            const timeAgo = formatMessageTime(request.created_at);
            const fullTime = created.toLocaleString('en-NZ', {
                weekday: 'short', day: 'numeric', month: 'short', 
                hour: '2-digit', minute: '2-digit'
            });
            
            const mapsUrl = request.latitude && request.longitude 
                ? `https://maps.google.com/?q=${request.latitude},${request.longitude}` 
                : '';
            
            document.getElementById('viewRequestContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: ${av.color}; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white;">${av.icon}</div>
                    <div>
                        <h3 style="margin: 0 0 4px;">${name}</h3>
                        <p style="margin: 0; color: var(--text-light); font-size: 13px;">ğŸ“ ${request.distance?.toFixed(1) || '?'} km away</p>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, ${severityColors[request.severity]}22, ${severityColors[request.severity]}11); border-left: 4px solid ${severityColors[request.severity]}; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 18px; font-weight: 700;">${typeIcons[request.alert_type] || 'â“'} ${request.alert_type?.charAt(0).toUpperCase() + request.alert_type?.slice(1)}</span>
                        <span style="background: ${severityColors[request.severity]}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase;">${request.severity}</span>
                    </div>
                    ${request.description ? `<p style="margin: 0; color: var(--text);">${escapeHtml(request.description)}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 10px;">
                        <p style="margin: 0; font-size: 12px; color: var(--text-light);">ğŸ• Posted</p>
                        <p style="margin: 4px 0 0; font-weight: 600;">${timeAgo}</p>
                        <p style="margin: 2px 0 0; font-size: 11px; color: var(--text-light);">${fullTime}</p>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 10px;">
                        <p style="margin: 0; font-size: 12px; color: var(--text-light);">ğŸ“ Location</p>
                        ${mapsUrl ? `
                            <a href="${mapsUrl}" target="_blank" style="display: inline-block; margin-top: 4px; font-size: 13px; color: var(--primary);">Open in Maps â†’</a>
                        ` : `<p style="margin: 4px 0 0; font-size: 13px; color: var(--text-light);">Not available</p>`}
                    </div>
                </div>
                
                ${request.status === 'help_coming' ? `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; padding: 12px; border-radius: 10px; text-align: center;">
                        <p style="margin: 0; color: #22c55e; font-weight: 600;">ğŸš— Help is already on the way</p>
                        <p style="margin: 4px 0 0; font-size: 12px; color: var(--text-light);">You can still offer additional help</p>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('viewRequestModal').classList.add('active');
        }
        
        function closeViewRequestModal(){
            document.getElementById('viewRequestModal').classList.remove('active');
            viewRequestData = null;
        }
        
        function messageFromViewRequest(){
            if(!viewRequestData) return;
            
            // Capture data before closing modal
            const userId = viewRequestData.user_id;
            const sosId = viewRequestData.id;
            const alertType = viewRequestData.alert_type;
            const name = generateAnonymousName(userId);
            
            // Close the view modal first
            document.getElementById('viewRequestModal').classList.remove('active');
            viewRequestData = null;
            
            // Then open chat
            openUniversalChat(userId, name, {type: 'sos', id: sosId, label: alertType});
        }
        
        function helpFromViewRequest(){
            if(!viewRequestData) return;
            // Capture data before closing modal
            const sosId = viewRequestData.id;
            const alertType = viewRequestData.alert_type;
            const name = generateAnonymousName(viewRequestData.user_id);
            
            // Close and open respond modal
            document.getElementById('viewRequestModal').classList.remove('active');
            openRespondModal(sosId, name, alertType);
            
            // Now clear it
            viewRequestData = null;
        }
        
        // Universal Chat
        async function openUniversalChat(userId, userName, context){
            currentChatUserId = userId;
            currentChatContext = context;
            
            const av = generateAvatarData(userId);
            document.getElementById('uniChatAvatar').style.background = av.color;
            document.getElementById('uniChatAvatar').innerHTML = av.icon;
            document.getElementById('uniChatName').textContent = userName;
            document.getElementById('uniChatContext').textContent = context?.label 
                ? `Re: ${context.label}` 
                : '';
            
            document.getElementById('universalChatInput').value = '';
            document.getElementById('universalChatModal').classList.add('active');
            
            await loadChatMessages();
            subscribeToChat();
            
            // Mark messages as read
            await db.from('messages')
                .update({read_at: new Date().toISOString()})
                .eq('sender_id', userId)
                .eq('receiver_id', currentUser.id)
                .is('read_at', null);
        }
        
        function closeUniversalChat(){
            document.getElementById('universalChatModal').classList.remove('active');
            if(messageSubscription){
                messageSubscription.unsubscribe();
                messageSubscription = null;
            }
            currentChatUserId = null;
            currentChatContext = null;
            loadConversations(); // Refresh conversation list
        }
        
        async function loadChatMessages(){
            const div = document.getElementById('universalChatMessages');
            
            const{data: messages, error} = await db.from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUserId}),and(sender_id.eq.${currentChatUserId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', {ascending: true});
            
            if(error || !messages || messages.length === 0){
                div.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p>No messages yet</p>
                        <p style="font-size: 13px;">Send a message to start the conversation</p>
                    </div>`;
                return;
            }
            
            div.innerHTML = messages.map(m => {
                const isMe = m.sender_id === currentUser.id;
                const time = formatChatTimestamp(m.created_at);
                
                return `
                <div style="display: flex; justify-content: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 8px;">
                    <div style="max-width: 75%; padding: 10px 14px; border-radius: 16px;
                        background: ${isMe ? 'var(--primary)' : 'white'};
                        color: ${isMe ? 'white' : 'var(--text)'};
                        border-bottom-${isMe ? 'right' : 'left'}-radius: 4px;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        <p style="margin: 0; word-wrap: break-word;">${escapeHtml(m.content)}</p>
                        <p style="margin: 4px 0 0; font-size: 10px; opacity: 0.7; text-align: right;">${time}</p>
                    </div>
                </div>`;
            }).join('');
            
            div.scrollTop = div.scrollHeight;
        }
        
        function subscribeToChat(){
            if(messageSubscription) messageSubscription.unsubscribe();
            
            messageSubscription = db.channel(`chat-${currentChatUserId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    const m = payload.new;
                    // Only show if it's part of this conversation
                    if((m.sender_id === currentUser.id && m.receiver_id === currentChatUserId) ||
                       (m.sender_id === currentChatUserId && m.receiver_id === currentUser.id)){
                        appendChatMessage(m);
                        
                        // Mark as read if from other user
                        if(m.sender_id === currentChatUserId){
                            db.from('messages').update({read_at: new Date().toISOString()}).eq('id', m.id);
                            playNotificationSound();
                        }
                    }
                })
                .subscribe();
        }
        
        function appendChatMessage(m){
            const div = document.getElementById('universalChatMessages');
            const isMe = m.sender_id === currentUser.id;
            const time = formatChatTimestamp(m.created_at);
            
            // Remove "no messages" placeholder if present
            if(div.querySelector('div[style*="text-align: center"]')){
                div.innerHTML = '';
            }
            
            div.innerHTML += `
            <div style="display: flex; justify-content: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 8px;">
                <div style="max-width: 75%; padding: 10px 14px; border-radius: 16px;
                    background: ${isMe ? 'var(--primary)' : 'white'};
                    color: ${isMe ? 'white' : 'var(--text)'};
                    border-bottom-${isMe ? 'right' : 'left'}-radius: 4px;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    <p style="margin: 0; word-wrap: break-word;">${escapeHtml(m.content)}</p>
                    <p style="margin: 4px 0 0; font-size: 10px; opacity: 0.7; text-align: right;">${time}</p>
                </div>
            </div>`;
            
            div.scrollTop = div.scrollHeight;
        }
        
        async function sendUniversalMessage(){
            const input = document.getElementById('universalChatInput');
            const content = input.value.trim();
            
            if(!content || !currentChatUserId) return;
            
            input.value = '';
            
            const messageData = {
                sender_id: currentUser.id,
                receiver_id: currentChatUserId,
                content: content,
                sos_alert_id: currentChatContext?.type === 'sos' ? currentChatContext.id : null
            };
            
            const{error} = await db.from('messages').insert(messageData);
            
            if(error){
                alert('Failed to send message: ' + error.message);
                input.value = content; // Restore message
            }
        }
        
        // Message from Travelers Nearby
        function messageNearbyTraveler(userId, userName){
            openUniversalChat(userId, userName, {type: 'traveler', label: 'Nearby traveler'});
        }
        
        // Handle Enter key in universal chat
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const chatInput = document.getElementById('universalChatInput');
                if(chatInput){
                    chatInput.addEventListener('keypress', (e) => {
                        if(e.key === 'Enter' && !e.shiftKey){
                            e.preventDefault();
                            sendUniversalMessage();
                        }
                    });
                }
            }, 1000);
        });
        
        // Utilities
        function getDistance(lat1,lng1,lat2,lng2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
    </script>
</body>
</html>
