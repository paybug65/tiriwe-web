<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #7c3aed;
            --primary-dark: #5b21b6;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-light: #94a3b8;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }
        
        .logo h1 { font-size: 22px; font-weight: 700; }
        .logo span { font-size: 11px; opacity: 0.8; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 12px 12px 0 0;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab:hover { color: var(--text); background: var(--bg-hover); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            background: var(--bg-card);
            padding: 30px;
            border-radius: 0 0 12px 12px;
            min-height: 600px;
        }
        .tab-content.active { display: block; }
        
        /* Cards */
        .card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-card .label {
            color: var(--text-light);
            font-size: 14px;
            margin-top: 8px;
        }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }
        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        
        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .alert-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); }
        .alert-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .alert-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
        .alert-info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-hover); font-weight: 600; font-size: 13px; color: var(--text-light); }
        tr:hover { background: var(--bg-hover); }
        
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tabs { flex-wrap: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>üîê Obonato Admin</h1>
                <span>Database Management Portal</span>
            </div>
            <div class="header-right">
                <span id="connectionStatus" class="status-badge status-disconnected">Not Connected</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('users')">üë• Users</button>
            <button class="tab" onclick="showTab('helpers')">ü§ù Helpers</button>
            <button class="tab" onclick="showTab('sos')">üö® SOS Alerts</button>
            <button class="tab" onclick="showTab('feedback')">‚≠ê Feedback</button>
            <button class="tab" onclick="showTab('sql')">üíª SQL Console</button>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content active">
            <div class="card">
                <h3>‚öôÔ∏è Database Connection</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Admin Portal:</strong> Use your <strong>service_role</strong> key here for full database access. This key bypasses Row Level Security - keep it secret!
                </div>
                
                <div class="form-group">
                    <label>Supabase Project URL</label>
                    <input type="text" class="form-control" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                </div>
                
                <div class="form-group">
                    <label>Supabase Service Role Key</label>
                    <input type="password" class="form-control" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    <div class="form-hint">Found in Settings ‚Üí API ‚Üí service_role (secret)</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="testConnection()">üîç Test Connection</button>
                    <button class="btn btn-success" onclick="saveConnection()">üíæ Save & Connect</button>
                    <button class="btn btn-secondary" onclick="clearConnection()">üóëÔ∏è Clear</button>
                </div>
                
                <div id="connectionResult" style="margin-top: 20px;"></div>
            </div>
            
            <div class="card">
                <h3>üìä Database Tables</h3>
                <div id="tableStatus">
                    <p class="loading">Connect to see table status...</p>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="number" id="statUsers">-</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statHelpers">-</div>
                    <div class="label">Active Helpers</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statSOS">-</div>
                    <div class="label">Active SOS</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statFeedback">-</div>
                    <div class="label">Feedback Given</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Recent Activity</h3>
                <div id="recentActivity">
                    <p class="loading">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="card">
                <h3>üë• User Management</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh Users</button>
                    <button class="btn btn-success" onclick="showAddUser()">‚ûï Add Test User</button>
                </div>
                <div id="usersList">
                    <p class="loading">Click refresh to load users...</p>
                </div>
            </div>
        </div>
        
        <!-- Helpers Tab -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>ü§ù Helper Availability</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadHelpers()">üîÑ Refresh</button>
                </div>
                <div id="helpersList">
                    <p class="loading">Click refresh to load helpers...</p>
                </div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="card">
                <h3>üö® SOS Alerts</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadSOSAlerts()">üîÑ Refresh</button>
                    <button class="btn btn-danger" onclick="createTestSOS()">‚ûï Create Test SOS</button>
                </div>
                <div id="sosList">
                    <p class="loading">Click refresh to load alerts...</p>
                </div>
            </div>
        </div>
        
        <!-- Feedback Tab -->
        <div id="feedback" class="tab-content">
            <div class="card">
                <h3>‚≠ê User Feedback</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadFeedback()">üîÑ Refresh</button>
                </div>
                <div id="feedbackList">
                    <p class="loading">Click refresh to load feedback...</p>
                </div>
            </div>
        </div>
        
        <!-- SQL Console Tab -->
        <div id="sql" class="tab-content">
            <div class="card">
                <h3>üíª SQL Console</h3>
                <div class="alert alert-warning">
                    ‚ö†Ô∏è Be careful! These queries run directly against your database.
                </div>
                
                <div class="form-group">
                    <label>SQL Query</label>
                    <textarea class="form-control" id="sqlQuery" rows="6" placeholder="SELECT * FROM profiles LIMIT 10;"></textarea>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runSQL()">‚ñ∂Ô∏è Run Query</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('sqlQuery').value = ''">üóëÔ∏è Clear</button>
                </div>
                
                <h4 style="margin: 24px 0 12px; color: var(--text-light);">Quick Queries</h4>
                <div class="btn-group" style="flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="setQuery('SELECT * FROM profiles LIMIT 20')">All Profiles</button>
                    <button class="btn btn-sm btn-secondary" onclick="setQuery('SELECT * FROM user_availability WHERE is_available = true')">Active Helpers</button>
                    <button class="btn btn-sm btn-secondary" onclick="setQuery('SELECT * FROM sos_alerts ORDER BY created_at DESC LIMIT 20')">Recent SOS</button>
                    <button class="btn btn-sm btn-secondary" onclick="setQuery('SELECT * FROM feedback ORDER BY created_at DESC LIMIT 20')">Recent Feedback</button>
                    <button class="btn btn-sm btn-secondary" onclick="setQuery('SELECT * FROM messages ORDER BY created_at DESC LIMIT 20')">Recent Messages</button>
                </div>
                
                <div id="sqlResult" style="margin-top: 24px;"></div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        
        // Tab navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabId === 'dashboard') loadDashboard();
        }
        
        // Load saved credentials
        window.onload = function() {
            const savedUrl = localStorage.getItem('obonato_admin_url');
            const savedKey = localStorage.getItem('obonato_admin_key');
            
            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseKey').value = savedKey;
                initSupabase(savedUrl, savedKey);
            }
        };
        
        // Initialize Supabase
        function initSupabase(url, key) {
            try {
                supabase = window.supabase.createClient(url, key);
                updateStatus(true);
                loadTableStatus();
                return true;
            } catch (error) {
                console.error('Init error:', error);
                updateStatus(false);
                return false;
            }
        }
        
        // Test connection
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const result = document.getElementById('connectionResult');
            
            if (!url || !key) {
                result.innerHTML = '<div class="alert alert-danger">Enter both URL and Key</div>';
                return;
            }
            
            result.innerHTML = '<div class="alert alert-info">Testing...</div>';
            
            try {
                const testClient = window.supabase.createClient(url, key);
                const { data, error } = await testClient.from('profiles').select('count', { count: 'exact', head: true });
                
                if (error && !error.message.includes('does not exist')) throw error;
                
                result.innerHTML = '<div class="alert alert-success">‚úÖ Connected! Click Save to continue.</div>';
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
            }
        }
        
        // Save connection
        function saveConnection() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            localStorage.setItem('obonato_admin_url', url);
            localStorage.setItem('obonato_admin_key', key);
            
            if (initSupabase(url, key)) {
                document.getElementById('connectionResult').innerHTML = '<div class="alert alert-success">‚úÖ Connected and saved!</div>';
            }
        }
        
        // Clear connection
        function clearConnection() {
            localStorage.removeItem('obonato_admin_url');
            localStorage.removeItem('obonato_admin_key');
            document.getElementById('supabaseUrl').value = '';
            document.getElementById('supabaseKey').value = '';
            supabase = null;
            updateStatus(false);
        }
        
        // Update status badge
        function updateStatus(connected) {
            const badge = document.getElementById('connectionStatus');
            badge.textContent = connected ? 'Connected' : 'Not Connected';
            badge.className = 'status-badge ' + (connected ? 'status-connected' : 'status-disconnected');
        }
        
        // Load table status
        async function loadTableStatus() {
            if (!supabase) return;
            
            const div = document.getElementById('tableStatus');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            const tables = ['profiles', 'user_availability', 'sos_alerts', 'messages', 'feedback', 'user_traveler_types', 'user_interests'];
            let html = '<table><tr><th>Table</th><th>Status</th><th>Records</th></tr>';
            
            for (const table of tables) {
                try {
                    const { count, error } = await supabase.from(table).select('*', { count: 'exact', head: true });
                    html += `<tr><td>${table}</td><td>${error ? '‚ùå' : '‚úÖ'}</td><td>${error ? '-' : count}</td></tr>`;
                } catch (e) {
                    html += `<tr><td>${table}</td><td>‚ùå</td><td>-</td></tr>`;
                }
            }
            
            html += '</table>';
            div.innerHTML = html;
        }
        
        // Load dashboard
        async function loadDashboard() {
            if (!supabase) return;
            
            try {
                // Get counts
                const [users, helpers, sos, feedback] = await Promise.all([
                    supabase.from('profiles').select('*', { count: 'exact', head: true }),
                    supabase.from('user_availability').select('*', { count: 'exact', head: true }).eq('is_available', true),
                    supabase.from('sos_alerts').select('*', { count: 'exact', head: true }).eq('status', 'active'),
                    supabase.from('feedback').select('*', { count: 'exact', head: true })
                ]);
                
                document.getElementById('statUsers').textContent = users.count || 0;
                document.getElementById('statHelpers').textContent = helpers.count || 0;
                document.getElementById('statSOS').textContent = sos.count || 0;
                document.getElementById('statFeedback').textContent = feedback.count || 0;
                
                // Recent activity
                const { data: recent } = await supabase
                    .from('sos_alerts')
                    .select('*, profiles(display_name)')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                let html = '<table><tr><th>Time</th><th>Type</th><th>User</th><th>Status</th></tr>';
                if (recent && recent.length) {
                    recent.forEach(a => {
                        html += `<tr>
                            <td>${new Date(a.created_at).toLocaleString()}</td>
                            <td>${a.alert_type}</td>
                            <td>${a.profiles?.display_name || 'Unknown'}</td>
                            <td>${a.status}</td>
                        </tr>`;
                    });
                } else {
                    html += '<tr><td colspan="4">No recent activity</td></tr>';
                }
                html += '</table>';
                document.getElementById('recentActivity').innerHTML = html;
                
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        // Load users
        async function loadUsers() {
            if (!supabase) {
                alert('Connect to database first');
                return;
            }
            
            const div = document.getElementById('usersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No users found.</div>';
                    return;
                }
                
                let html = '<table><tr><th>Name</th><th>Email</th><th>Phone</th><th>Country</th><th>Created</th><th>Actions</th></tr>';
                data.forEach(u => {
                    html += `<tr>
                        <td>${u.display_name || u.first_name || '-'}</td>
                        <td>${u.email || '-'}</td>
                        <td>${u.phone || '-'}</td>
                        <td>${u.country || '-'}</td>
                        <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewUser('${u.id}')">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Load helpers
        async function loadHelpers() {
            if (!supabase) return;
            
            const div = document.getElementById('helpersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('user_availability')
                    .select('*, profiles(display_name, first_name)')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No helper availability records.</div>';
                    return;
                }
                
                let html = '<table><tr><th>User</th><th>Location</th><th>Available</th><th>Services</th><th>Radius</th></tr>';
                data.forEach(h => {
                    const services = [];
                    if (h.can_pickup) services.push('üöó');
                    if (h.can_provide_garage) services.push('üîß');
                    if (h.can_provide_accommodation) services.push('üè†');
                    if (h.can_meet_for_drinks) services.push('üç∫');
                    if (h.can_provide_local_advice) services.push('üí°');
                    
                    html += `<tr>
                        <td>${h.profiles?.display_name || h.profiles?.first_name || '-'}</td>
                        <td>${h.current_location_name || '-'}</td>
                        <td>${h.is_available ? '‚úÖ' : '‚ùå'}</td>
                        <td>${services.join(' ') || '-'}</td>
                        <td>${h.max_help_radius_km || '-'} km</td>
                    </tr>`;
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Load SOS alerts
        async function loadSOSAlerts() {
            if (!supabase) return;
            
            const div = document.getElementById('sosList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('sos_alerts')
                    .select('*, profiles(display_name)')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No SOS alerts.</div>';
                    return;
                }
                
                let html = '<table><tr><th>Time</th><th>User</th><th>Type</th><th>Severity</th><th>Status</th><th>Actions</th></tr>';
                data.forEach(a => {
                    const sevColor = a.severity === 'critical' ? 'var(--danger)' : (a.severity === 'high' ? 'var(--warning)' : 'inherit');
                    html += `<tr>
                        <td>${new Date(a.created_at).toLocaleString()}</td>
                        <td>${a.profiles?.display_name || '-'}</td>
                        <td>${a.alert_type}</td>
                        <td style="color: ${sevColor}">${a.severity}</td>
                        <td>${a.status}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="resolveAlert('${a.id}')">‚úÖ Resolve</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAlert('${a.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Load feedback
        async function loadFeedback() {
            if (!supabase) return;
            
            const div = document.getElementById('feedbackList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('feedback')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No feedback yet.</div>';
                    return;
                }
                
                let html = '<table><tr><th>Time</th><th>Rating</th><th>Comment</th></tr>';
                data.forEach(f => {
                    const stars = '‚≠ê'.repeat(f.rating || 0);
                    html += `<tr>
                        <td>${new Date(f.created_at).toLocaleString()}</td>
                        <td>${stars || '-'}</td>
                        <td>${f.comment || '-'}</td>
                    </tr>`;
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // SQL Console
        function setQuery(query) {
            document.getElementById('sqlQuery').value = query;
        }
        
        async function runSQL() {
            if (!supabase) {
                alert('Connect to database first');
                return;
            }
            
            const query = document.getElementById('sqlQuery').value.trim();
            const div = document.getElementById('sqlResult');
            
            if (!query) {
                div.innerHTML = '<div class="alert alert-warning">Enter a query</div>';
                return;
            }
            
            div.innerHTML = '<p class="loading">Running query...</p>';
            
            try {
                // Parse simple SELECT queries
                const match = query.match(/SELECT\s+(.+?)\s+FROM\s+(\w+)(?:\s+(.*))?/i);
                
                if (!match) {
                    div.innerHTML = '<div class="alert alert-danger">Only SELECT queries are supported in this console. Use Supabase dashboard for other operations.</div>';
                    return;
                }
                
                const [, columns, table, rest] = match;
                let queryBuilder = supabase.from(table).select(columns === '*' ? '*' : columns);
                
                // Parse WHERE clause (basic)
                if (rest) {
                    const whereMatch = rest.match(/WHERE\s+(\w+)\s*=\s*['"]?([^'"]+)['"]?/i);
                    if (whereMatch) {
                        queryBuilder = queryBuilder.eq(whereMatch[1], whereMatch[2]);
                    }
                }
                
                // Parse LIMIT
                const limitMatch = rest?.match(/LIMIT\s+(\d+)/i);
                if (limitMatch) {
                    queryBuilder = queryBuilder.limit(parseInt(limitMatch[1]));
                }
                
                // Parse ORDER BY
                const orderMatch = rest?.match(/ORDER\s+BY\s+(\w+)(?:\s+(ASC|DESC))?/i);
                if (orderMatch) {
                    queryBuilder = queryBuilder.order(orderMatch[1], { ascending: orderMatch[2]?.toUpperCase() !== 'DESC' });
                }
                
                const { data, error } = await queryBuilder;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No results</div>';
                    return;
                }
                
                // Build table from results
                const cols = Object.keys(data[0]);
                let html = `<p style="margin-bottom: 12px; color: var(--text-light);">${data.length} rows returned</p>`;
                html += '<div style="overflow-x: auto;"><table><tr>';
                cols.forEach(c => html += `<th>${c}</th>`);
                html += '</tr>';
                
                data.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => {
                        let val = row[c];
                        if (val === null) val = '<span style="color: var(--text-light)">null</span>';
                        else if (typeof val === 'object') val = JSON.stringify(val).substring(0, 50);
                        else if (typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
                        html += `<td>${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</table></div>';
                div.innerHTML = html;
                
            } catch (error) {
                div.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Helper functions
        function viewUser(id) {
            alert('View user: ' + id);
        }
        
        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            const { error } = await supabase.from('profiles').delete().eq('id', id);
            if (error) alert('Error: ' + error.message);
            else loadUsers();
        }
        
        async function resolveAlert(id) {
            const { error } = await supabase.from('sos_alerts').update({ status: 'resolved' }).eq('id', id);
            if (error) alert('Error: ' + error.message);
            else loadSOSAlerts();
        }
        
        async function deleteAlert(id) {
            if (!confirm('Delete this alert?')) return;
            const { error } = await supabase.from('sos_alerts').delete().eq('id', id);
            if (error) alert('Error: ' + error.message);
            else loadSOSAlerts();
        }
        
        async function createTestSOS() {
            if (!supabase) return;
            
            const { error } = await supabase.from('sos_alerts').insert({
                alert_type: 'breakdown',
                severity: 'medium',
                description: 'Test SOS alert - please ignore',
                status: 'active',
                latitude: -36.8485 + (Math.random() - 0.5) * 0.1,
                longitude: 174.7633 + (Math.random() - 0.5) * 0.1,
                created_at: new Date().toISOString()
            });
            
            if (error) alert('Error: ' + error.message);
            else {
                alert('Test SOS created!');
                loadSOSAlerts();
            }
        }
        
        function showAddUser() {
            alert('To add users:\n\n1. Go to the User Portal\n2. Use the Sign Up form\n\nOr use the Supabase dashboard to create users directly.');
        }
    </script>
</body>
</html>
