<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1F4788;
            --primary-dark: #163560;
            --primary-light: #2d5aa3;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --bg: #f8fafc;
            --bg-alt: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo h1 { font-size: 24px; font-weight: 800; color: white; }
        .logo span { font-size: 11px; opacity: 0.8; color: white; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        
        .admin-badge {
            background: var(--accent);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 16px 16px 0 0;
            overflow-x: auto;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tab {
            padding: 18px 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover { color: var(--primary); background: var(--bg); }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
            background: white;
        }
        
        .tab-content {
            display: none;
            background: var(--bg-card);
            padding: 32px;
            border-radius: 0 0 16px 16px;
            min-height: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .tab-content.active { display: block; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }
        .card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            color: white;
        }
        .stat-card.accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); }
        .stat-card.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }
        .stat-card .number {
            font-size: 36px;
            font-weight: 800;
        }
        .stat-card .label {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }
        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(31,71,136,0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: var(--accent-dark); }
        .btn-secondary { background: var(--bg-alt); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--primary); }
        .btn-sm { padding: 10px 18px; font-size: 13px; }
        .btn-xs { padding: 6px 12px; font-size: 12px; }
        
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-success { background: var(--success-light); color: #065f46; }
        .alert-danger { background: var(--danger-light); color: #991b1b; }
        .alert-warning { background: var(--warning-light); color: #92400e; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-alt); font-weight: 600; font-size: 13px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background: var(--bg-alt); }
        
        .loading { text-align: center; padding: 48px; color: var(--text-light); }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 0;
            max-width: 650px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .modal-header {
            padding: 28px 36px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: var(--primary);
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        
        .modal-body {
            padding: 32px 36px;
        }
        
        .modal-footer {
            padding: 24px 36px;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg);
            border-radius: 0 0 24px 24px;
        }
        
        .modal-close {
            background: var(--bg-alt);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-close:hover { background: var(--border); color: var(--text); }
        
        .detail-row {
            display: flex;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label {
            width: 150px;
            min-width: 150px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
            padding-right: 16px;
        }
        .detail-value {
            flex: 1;
            color: var(--text);
            padding-left: 8px;
        }
        
        .detail-section {
            margin-top: 28px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }
        .detail-section h4 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 16px;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .severity-low { background: var(--success-light); color: #065f46; }
        .severity-medium { background: var(--warning-light); color: #92400e; }
        .severity-high { background: #fed7aa; color: #c2410c; }
        .severity-critical { background: var(--danger-light); color: #991b1b; }
        
        .status-active { color: var(--danger); font-weight: 600; }
        .status-resolved { color: var(--success); font-weight: 600; }
        .status-cancelled { color: var(--text-light); }
        
        @media (max-width: 768px) {
            .tabs { flex-wrap: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-header, .modal-body, .modal-footer { padding-left: 24px; padding-right: 24px; }
            .detail-label { width: 120px; min-width: 120px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">
                <span style="font-size: 32px;">üîê</span>
                <div>
                    <h1>Obonato Admin</h1>
                    <span>Database Management Portal</span>
                </div>
            </a>
            <div class="header-right">
                <span class="admin-badge">ADMIN</span>
                <span id="connectionStatus" class="status-badge status-disconnected">Not Connected</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('settings', this)">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab" onclick="showTab('users', this)">üë• Users</button>
            <button class="tab" onclick="showTab('helpers', this)">ü§ù Helpers</button>
            <button class="tab" onclick="showTab('sos', this)">üö® SOS Alerts</button>
            <button class="tab" onclick="showTab('feedback', this)">‚≠ê Feedback</button>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content active">
            <div class="card">
                <h3>‚öôÔ∏è Database Connection</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Admin Portal:</strong> Use your <strong>service_role</strong> key here for full database access. This key bypasses Row Level Security - keep it secret!
                </div>
                
                <div class="form-group">
                    <label>Supabase Project URL</label>
                    <input type="text" class="form-control" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                </div>
                
                <div class="form-group">
                    <label>Supabase Service Role Key</label>
                    <input type="password" class="form-control" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    <div class="form-hint">Found in Settings ‚Üí API ‚Üí service_role (secret)</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="handleTestConnection()">üîç Test Connection</button>
                    <button class="btn btn-success" onclick="handleSaveConnection()">üíæ Save & Connect</button>
                    <button class="btn btn-secondary" onclick="handleClearConnection()">üóëÔ∏è Clear</button>
                </div>
                
                <div id="connectionResult" style="margin-top: 20px;"></div>
            </div>
            
            <div class="card">
                <h3>üìß Email Notifications (Optional)</h3>
                <div class="alert alert-info">
                    Set up EmailJS to send email notifications when SOS alerts are created. 
                    <a href="https://www.emailjs.com/" target="_blank" style="color: #1e40af; font-weight: 600;">Get free account ‚Üí</a>
                </div>
                
                <div class="form-group">
                    <label>EmailJS Service ID</label>
                    <input type="text" class="form-control" id="emailServiceId" placeholder="service_xxxxxxx">
                </div>
                
                <div class="form-group">
                    <label>EmailJS Template ID</label>
                    <input type="text" class="form-control" id="emailTemplateId" placeholder="template_xxxxxxx">
                </div>
                
                <div class="form-group">
                    <label>EmailJS Public Key</label>
                    <input type="text" class="form-control" id="emailPublicKey" placeholder="xxxxxxxxxxxxxxx">
                </div>
                
                <div class="form-group">
                    <label>Admin Email (receives notifications)</label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="admin@example.com">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveEmailSettings()">üíæ Save Email Settings</button>
                    <button class="btn btn-secondary" onclick="testEmail()">üìß Send Test Email</button>
                </div>
                <div id="emailResult" style="margin-top: 16px;"></div>
            </div>
            
            <div class="card">
                <h3>üìä Database Tables</h3>
                <div id="tableStatus">
                    <p class="loading">Connect to see table status...</p>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="statUsers">-</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statHelpers">-</div>
                    <div class="label">Active Helpers</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statSOS">-</div>
                    <div class="label">Active SOS</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statFeedback">-</div>
                    <div class="label">Feedback Given</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Recent Activity</h3>
                <div id="recentActivity">
                    <p class="loading">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="card">
                <h3>üë• User Management</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh Users</button>
                </div>
                <div id="usersList">
                    <p class="loading">Click refresh to load users...</p>
                </div>
            </div>
        </div>
        
        <!-- Helpers Tab -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>ü§ù Helper Availability</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadHelpers()">üîÑ Refresh</button>
                </div>
                <div id="helpersList">
                    <p class="loading">Click refresh to load helpers...</p>
                </div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="card">
                <h3>üö® SOS Alerts</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadSOSAlerts()">üîÑ Refresh</button>
                    <button class="btn btn-danger" onclick="createTestSOS()">‚ûï Create Test SOS</button>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="margin-right: 16px;">
                        <input type="checkbox" id="filterActive" checked onchange="loadSOSAlerts()"> Active
                    </label>
                    <label style="margin-right: 16px;">
                        <input type="checkbox" id="filterResolved" onchange="loadSOSAlerts()"> Resolved
                    </label>
                    <label>
                        <input type="checkbox" id="filterCancelled" onchange="loadSOSAlerts()"> Cancelled
                    </label>
                </div>
                
                <div id="sosList">
                    <p class="loading">Click refresh to load alerts...</p>
                </div>
            </div>
        </div>
        
        <!-- Feedback Tab -->
        <div id="feedback" class="tab-content">
            <div class="card">
                <h3>‚≠ê User Feedback</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadFeedback()">üîÑ Refresh</button>
                </div>
                <div id="feedbackList">
                    <p class="loading">Click refresh to load feedback...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Detail Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <h2>üö® SOS Alert Details</h2>
            <div id="sosModalContent"></div>
        </div>
    </div>
    
    <!-- User Detail Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <h2>üë§ User Details</h2>
            <div id="userModalContent"></div>
        </div>
    </div>

    <!-- EmailJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        let db = null;
        let currentSOSAlert = null;
        
        // Tab navigation
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            if (tabId === 'dashboard') loadDashboard();
        }
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) closeModals();
            });
        });
        
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(function(m) { m.classList.remove('active'); });
        }
        
        // Load saved credentials
        window.onload = function() {
            var savedUrl = localStorage.getItem('obonato_admin_url');
            var savedKey = localStorage.getItem('obonato_admin_key');
            
            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseKey').value = savedKey;
                initDatabase(savedUrl, savedKey);
            }
            
            // Load email settings
            document.getElementById('emailServiceId').value = localStorage.getItem('obonato_email_service') || '';
            document.getElementById('emailTemplateId').value = localStorage.getItem('obonato_email_template') || '';
            document.getElementById('emailPublicKey').value = localStorage.getItem('obonato_email_key') || '';
            document.getElementById('adminEmail').value = localStorage.getItem('obonato_admin_email') || '';
        };
        
        // Initialize database
        function initDatabase(url, key) {
            try {
                db = window.supabase.createClient(url, key);
                updateStatus(true);
                loadTableStatus();
                return true;
            } catch (error) {
                console.error('Init error:', error);
                updateStatus(false);
                return false;
            }
        }
        
        // Test connection
        async function handleTestConnection() {
            var url = document.getElementById('supabaseUrl').value.trim();
            var key = document.getElementById('supabaseKey').value.trim();
            var result = document.getElementById('connectionResult');
            
            if (!url || !key) {
                result.innerHTML = '<div class="alert alert-danger">Enter both URL and Key</div>';
                return;
            }
            
            result.innerHTML = '<div class="alert alert-info">Testing...</div>';
            
            try {
                var testClient = window.supabase.createClient(url, key);
                var response = await testClient.from('profiles').select('count', { count: 'exact', head: true });
                
                if (response.error && !response.error.message.includes('does not exist')) {
                    throw response.error;
                }
                
                result.innerHTML = '<div class="alert alert-success">‚úÖ Connected! Click Save to continue.</div>';
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">‚ùå ' + error.message + '</div>';
            }
        }
        
        // Save connection
        function handleSaveConnection() {
            var url = document.getElementById('supabaseUrl').value.trim();
            var key = document.getElementById('supabaseKey').value.trim();
            
            localStorage.setItem('obonato_admin_url', url);
            localStorage.setItem('obonato_admin_key', key);
            
            if (initDatabase(url, key)) {
                document.getElementById('connectionResult').innerHTML = '<div class="alert alert-success">‚úÖ Connected and saved!</div>';
            }
        }
        
        // Clear connection
        function handleClearConnection() {
            localStorage.removeItem('obonato_admin_url');
            localStorage.removeItem('obonato_admin_key');
            document.getElementById('supabaseUrl').value = '';
            document.getElementById('supabaseKey').value = '';
            db = null;
            updateStatus(false);
        }
        
        // Update status badge
        function updateStatus(connected) {
            var badge = document.getElementById('connectionStatus');
            badge.textContent = connected ? 'Connected' : 'Not Connected';
            badge.className = 'status-badge ' + (connected ? 'status-connected' : 'status-disconnected');
        }
        
        // Email settings
        function saveEmailSettings() {
            localStorage.setItem('obonato_email_service', document.getElementById('emailServiceId').value);
            localStorage.setItem('obonato_email_template', document.getElementById('emailTemplateId').value);
            localStorage.setItem('obonato_email_key', document.getElementById('emailPublicKey').value);
            localStorage.setItem('obonato_admin_email', document.getElementById('adminEmail').value);
            document.getElementById('emailResult').innerHTML = '<div class="alert alert-success">‚úÖ Email settings saved!</div>';
        }
        
        function testEmail() {
            var serviceId = document.getElementById('emailServiceId').value;
            var templateId = document.getElementById('emailTemplateId').value;
            var publicKey = document.getElementById('emailPublicKey').value;
            var adminEmail = document.getElementById('adminEmail').value;
            
            if (!serviceId || !templateId || !publicKey || !adminEmail) {
                document.getElementById('emailResult').innerHTML = '<div class="alert alert-danger">Please fill in all email settings</div>';
                return;
            }
            
            emailjs.init(publicKey);
            
            emailjs.send(serviceId, templateId, {
                to_email: adminEmail,
                subject: 'Obonato Test Email',
                message: 'This is a test email from Obonato Admin Portal. If you received this, email notifications are working!',
                alert_type: 'Test',
                severity: 'Low',
                location: 'Test Location',
                user_name: 'Admin',
                time: new Date().toLocaleString()
            }).then(function() {
                document.getElementById('emailResult').innerHTML = '<div class="alert alert-success">‚úÖ Test email sent! Check your inbox.</div>';
            }).catch(function(error) {
                document.getElementById('emailResult').innerHTML = '<div class="alert alert-danger">‚ùå Email failed: ' + error.text + '</div>';
            });
        }
        
        // Load table status
        async function loadTableStatus() {
            if (!db) return;
            
            var div = document.getElementById('tableStatus');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            var tables = ['profiles', 'user_availability', 'sos_alerts', 'messages', 'feedback'];
            var html = '<table><tr><th>Table</th><th>Status</th><th>Records</th></tr>';
            
            for (var i = 0; i < tables.length; i++) {
                var table = tables[i];
                try {
                    var response = await db.from(table).select('*', { count: 'exact', head: true });
                    if (response.error) {
                        html += '<tr><td>' + table + '</td><td>‚ùå</td><td>-</td></tr>';
                    } else {
                        html += '<tr><td>' + table + '</td><td>‚úÖ</td><td>' + (response.count || 0) + '</td></tr>';
                    }
                } catch (e) {
                    html += '<tr><td>' + table + '</td><td>‚ùå</td><td>-</td></tr>';
                }
            }
            
            html += '</table>';
            div.innerHTML = html;
        }
        
        // Load dashboard
        async function loadDashboard() {
            if (!db) return;
            
            try {
                var usersRes = await db.from('profiles').select('*', { count: 'exact', head: true });
                var helpersRes = await db.from('user_availability').select('*', { count: 'exact', head: true }).eq('is_available', true);
                var sosRes = await db.from('sos_alerts').select('*', { count: 'exact', head: true }).eq('status', 'active');
                var feedbackRes = await db.from('feedback').select('*', { count: 'exact', head: true });
                
                document.getElementById('statUsers').textContent = usersRes.count || 0;
                document.getElementById('statHelpers').textContent = helpersRes.count || 0;
                document.getElementById('statSOS').textContent = sosRes.count || 0;
                document.getElementById('statFeedback').textContent = feedbackRes.count || 0;
                
                var recentRes = await db
                    .from('sos_alerts')
                    .select('*, profiles(display_name)')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                var html = '<table><tr><th>Time</th><th>Type</th><th>User</th><th>Status</th></tr>';
                if (recentRes.data && recentRes.data.length) {
                    recentRes.data.forEach(function(a) {
                        var userName = (a.profiles && a.profiles.display_name) || 'Unknown';
                        html += '<tr><td>' + new Date(a.created_at).toLocaleString() + '</td><td>' + a.alert_type + '</td><td>' + userName + '</td><td>' + a.status + '</td></tr>';
                    });
                } else {
                    html += '<tr><td colspan="4">No recent activity</td></tr>';
                }
                html += '</table>';
                document.getElementById('recentActivity').innerHTML = html;
                
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        // Load users
        async function loadUsers() {
            if (!db) {
                alert('Connect to database first');
                return;
            }
            
            var div = document.getElementById('usersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No users found.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Name</th><th>Email</th><th>Phone</th><th>Country</th><th>Created</th><th>Actions</th></tr>';
                data.forEach(function(u) {
                    html += '<tr>';
                    html += '<td>' + (u.display_name || u.first_name || '-') + '</td>';
                    html += '<td>' + (u.email || '-') + '</td>';
                    html += '<td>' + (u.phone || '-') + '</td>';
                    html += '<td>' + (u.country || '-') + '</td>';
                    html += '<td>' + (u.created_at ? new Date(u.created_at).toLocaleDateString() : '-') + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-primary" onclick="viewUser(\'' + u.id + '\')">üëÅÔ∏è View</button> ';
                    html += '<button class="btn btn-sm btn-danger" onclick="deleteUser(\'' + u.id + '\')">üóëÔ∏è</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // View user details
        async function viewUser(id) {
            if (!db) return;
            
            var response = await db.from('profiles').select('*').eq('id', id).single();
            if (response.error) {
                alert('Error loading user: ' + response.error.message);
                return;
            }
            
            var u = response.data;
            var html = '';
            html += '<div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">' + (u.first_name || '') + ' ' + (u.last_name || '') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Display Name</div><div class="detail-value">' + (u.display_name || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">' + (u.phone || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Country</div><div class="detail-value">' + (u.country || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Emergency Contact</div><div class="detail-value">' + (u.emergency_contact_name || '-') + ' - ' + (u.emergency_contact_phone || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Created</div><div class="detail-value">' + new Date(u.created_at).toLocaleString() + '</div></div>';
            html += '<div style="margin-top: 20px;"><button class="btn btn-secondary" onclick="closeModals()">Close</button></div>';
            
            document.getElementById('userModalContent').innerHTML = html;
            document.getElementById('userModal').classList.add('active');
        }
        
        // Load helpers
        async function loadHelpers() {
            if (!db) return;
            
            var div = document.getElementById('helpersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('user_availability')
                    .select('*, profiles(display_name, first_name, phone)')
                    .order('updated_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No helper records.</div>';
                    return;
                }
                
                var html = '<table><tr><th>User</th><th>Location</th><th>Available</th><th>Services</th><th>Radius</th><th>Actions</th></tr>';
                data.forEach(function(h) {
                    var services = [];
                    if (h.can_pickup) services.push('üöó');
                    if (h.can_provide_garage) services.push('üîß');
                    if (h.can_provide_accommodation) services.push('üè†');
                    if (h.can_meet_for_drinks) services.push('üç∫');
                    if (h.can_provide_local_advice) services.push('üí°');
                    
                    var userName = (h.profiles && h.profiles.display_name) || (h.profiles && h.profiles.first_name) || '-';
                    
                    html += '<tr>';
                    html += '<td>' + userName + '</td>';
                    html += '<td>' + (h.current_location_name || '-') + '</td>';
                    html += '<td>' + (h.is_available ? '‚úÖ' : '‚ùå') + '</td>';
                    html += '<td>' + (services.join(' ') || '-') + '</td>';
                    html += '<td>' + (h.max_help_radius_km || '-') + ' km</td>';
                    html += '<td>';
                    if (h.latitude && h.longitude) {
                        html += '<a href="https://www.google.com/maps?q=' + h.latitude + ',' + h.longitude + '" target="_blank" class="btn btn-sm btn-secondary">üó∫Ô∏è Map</a>';
                    }
                    html += '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Load SOS alerts
        async function loadSOSAlerts() {
            if (!db) return;
            
            var div = document.getElementById('sosList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var query = db
                    .from('sos_alerts')
                    .select('*, profiles(display_name, phone)')
                    .order('created_at', { ascending: false });
                
                // Apply filters
                var statuses = [];
                if (document.getElementById('filterActive').checked) statuses.push('active');
                if (document.getElementById('filterResolved').checked) statuses.push('resolved');
                if (document.getElementById('filterCancelled').checked) statuses.push('cancelled');
                
                if (statuses.length > 0) {
                    query = query.in('status', statuses);
                }
                
                var response = await query;
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No SOS alerts found.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Time</th><th>User</th><th>Type</th><th>Severity</th><th>Status</th><th>Actions</th></tr>';
                data.forEach(function(a) {
                    var userName = (a.profiles && a.profiles.display_name) || 'Unknown';
                    var sevClass = 'severity-' + a.severity;
                    var statusClass = 'status-' + a.status;
                    
                    html += '<tr>';
                    html += '<td>' + new Date(a.created_at).toLocaleString() + '</td>';
                    html += '<td>' + userName + '</td>';
                    html += '<td>' + a.alert_type + '</td>';
                    html += '<td><span class="severity-badge ' + sevClass + '">' + a.severity + '</span></td>';
                    html += '<td class="' + statusClass + '">' + a.status + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-primary" onclick="viewSOSAlert(\'' + a.id + '\')">üëÅÔ∏è View</button> ';
                    if (a.status === 'active') {
                        html += '<button class="btn btn-sm btn-success" onclick="resolveAlert(\'' + a.id + '\')">‚úÖ</button> ';
                    }
                    html += '<button class="btn btn-sm btn-danger" onclick="deleteAlert(\'' + a.id + '\')">üóëÔ∏è</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // View SOS Alert Details
        async function viewSOSAlert(id) {
            if (!db) return;
            
            var response = await db.from('sos_alerts').select('*, profiles(display_name, first_name, phone, emergency_contact_name, emergency_contact_phone)').eq('id', id).single();
            if (response.error) {
                alert('Error loading alert: ' + response.error.message);
                return;
            }
            
            currentSOSAlert = response.data;
            var a = currentSOSAlert;
            
            var sevClass = 'severity-' + a.severity;
            var statusClass = 'status-' + a.status;
            
            var html = '';
            
            // Alert info
            html += '<div class="detail-row"><div class="detail-label">Alert ID</div><div class="detail-value" style="font-family: monospace; font-size: 12px;">' + a.id + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Type</div><div class="detail-value">' + a.alert_type + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Severity</div><div class="detail-value"><span class="severity-badge ' + sevClass + '">' + a.severity + '</span></div></div>';
            html += '<div class="detail-row"><div class="detail-label">Status</div><div class="detail-value"><select class="form-control" id="editStatus" style="width: auto; display: inline-block;">';
            html += '<option value="active"' + (a.status === 'active' ? ' selected' : '') + '>Active</option>';
            html += '<option value="resolved"' + (a.status === 'resolved' ? ' selected' : '') + '>Resolved</option>';
            html += '<option value="cancelled"' + (a.status === 'cancelled' ? ' selected' : '') + '>Cancelled</option>';
            html += '</select></div></div>';
            html += '<div class="detail-row"><div class="detail-label">Created</div><div class="detail-value">' + new Date(a.created_at).toLocaleString() + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Description</div><div class="detail-value">' + (a.description || '-') + '</div></div>';
            
            // Location
            if (a.latitude && a.longitude) {
                html += '<div class="detail-row"><div class="detail-label">Location</div><div class="detail-value">';
                html += a.latitude.toFixed(6) + ', ' + a.longitude.toFixed(6) + ' ';
                html += '<a href="https://www.google.com/maps?q=' + a.latitude + ',' + a.longitude + '" target="_blank" class="btn btn-sm btn-secondary">üó∫Ô∏è View on Map</a>';
                html += '</div></div>';
            }
            
            // User info
            html += '<h3 style="margin-top: 20px; color: var(--accent);">üë§ User Contact</h3>';
            if (a.profiles) {
                html += '<div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">' + (a.profiles.display_name || a.profiles.first_name || '-') + '</div></div>';
                html += '<div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">';
                if (a.profiles.phone) {
                    html += '<a href="tel:' + a.profiles.phone + '" class="btn btn-sm btn-success">üìû ' + a.profiles.phone + '</a>';
                } else {
                    html += '-';
                }
                html += '</div></div>';
                html += '<div class="detail-row"><div class="detail-label">Emergency Contact</div><div class="detail-value">';
                if (a.profiles.emergency_contact_phone) {
                    html += a.profiles.emergency_contact_name + ' - <a href="tel:' + a.profiles.emergency_contact_phone + '" class="btn btn-sm btn-warning">üìû ' + a.profiles.emergency_contact_phone + '</a>';
                } else {
                    html += '-';
                }
                html += '</div></div>';
            } else {
                html += '<div class="detail-row"><div class="detail-value">No user linked to this alert</div></div>';
            }
            
            // Admin notes
            html += '<h3 style="margin-top: 20px; color: var(--accent);">üìù Admin Notes</h3>';
            html += '<textarea class="form-control" id="editNotes" rows="3" placeholder="Add notes about this alert...">' + (a.admin_notes || '') + '</textarea>';
            
            // Action buttons
            html += '<div style="margin-top: 20px;" class="btn-group">';
            html += '<button class="btn btn-success" onclick="saveSOSChanges()">üíæ Save Changes</button>';
            if (a.status === 'active') {
                html += '<button class="btn btn-warning" onclick="quickResolve()">‚úÖ Mark Resolved</button>';
            }
            html += '<button class="btn btn-secondary" onclick="closeModals()">Close</button>';
            html += '</div>';
            
            document.getElementById('sosModalContent').innerHTML = html;
            document.getElementById('sosModal').classList.add('active');
        }
        
        // Save SOS changes
        async function saveSOSChanges() {
            if (!db || !currentSOSAlert) return;
            
            var newStatus = document.getElementById('editStatus').value;
            var newNotes = document.getElementById('editNotes').value;
            
            var updateData = {
                status: newStatus,
                admin_notes: newNotes
            };
            
            if (newStatus === 'resolved' && currentSOSAlert.status !== 'resolved') {
                updateData.responded_at = new Date().toISOString();
            }
            
            var response = await db.from('sos_alerts').update(updateData).eq('id', currentSOSAlert.id);
            
            if (response.error) {
                alert('Error saving: ' + response.error.message);
            } else {
                closeModals();
                loadSOSAlerts();
            }
        }
        
        // Quick resolve
        async function quickResolve() {
            document.getElementById('editStatus').value = 'resolved';
            await saveSOSChanges();
        }
        
        // Load feedback
        async function loadFeedback() {
            if (!db) return;
            
            var div = document.getElementById('feedbackList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('feedback')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No feedback yet.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Time</th><th>Rating</th><th>Comment</th></tr>';
                data.forEach(function(f) {
                    var stars = '';
                    for (var i = 0; i < (f.rating || 0); i++) stars += '‚≠ê';
                    
                    html += '<tr>';
                    html += '<td>' + new Date(f.created_at).toLocaleString() + '</td>';
                    html += '<td>' + (stars || '-') + '</td>';
                    html += '<td>' + (f.comment || '-') + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Delete user
        async function deleteUser(id) {
            if (!confirm('Delete this user? This will also delete their availability, alerts, and feedback.')) return;
            var response = await db.from('profiles').delete().eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadUsers();
        }
        
        // Resolve alert
        async function resolveAlert(id) {
            var response = await db.from('sos_alerts').update({ status: 'resolved', responded_at: new Date().toISOString() }).eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadSOSAlerts();
        }
        
        // Delete alert
        async function deleteAlert(id) {
            if (!confirm('Delete this alert?')) return;
            var response = await db.from('sos_alerts').delete().eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadSOSAlerts();
        }
        
        // Create test SOS
        async function createTestSOS() {
            if (!db) return;
            
            var response = await db.from('sos_alerts').insert({
                alert_type: 'breakdown',
                severity: 'medium',
                description: 'Test SOS alert - please ignore',
                status: 'active',
                latitude: -36.8485 + (Math.random() - 0.5) * 0.1,
                longitude: 174.7633 + (Math.random() - 0.5) * 0.1,
                created_at: new Date().toISOString()
            });
            
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                alert('Test SOS created!');
                loadSOSAlerts();
            }
        }
    </script>
</body>
</html>
